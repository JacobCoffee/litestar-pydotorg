name: CI

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================================================================================== #
  # SECURITY SCAN (workflow security with zizmor)
  # ==================================================================================== #
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run zizmor
        uses: zizmorcore/zizmor-action@135698455da5c3b3e55f73f4419e481ab68cdd95 # v0.4.1
        with:
          inputs: .github/workflows/

  # ==================================================================================== #
  # VALIDATE (lint, format, type-check in one job)
  # ==================================================================================== #
  validate:
    name: Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: true

      - name: Create virtual environment
        run: uv sync --all-extras --group dev

      - name: Run ruff check
        run: uv run ruff check src/pydotorg tests

      - name: Run ruff format check
        run: uv run ruff format --check src/pydotorg tests

      - name: Run codespell
        run: uv run codespell

      - name: Run ty type checker
        uses: JacobCoffee/ty-action@53e9dd1d07f0793d33756a9230c6fc39c23089a3 # v0.0.1
        with:
          args: check src/pydotorg

  # ==================================================================================== #
  # FRONTEND BUILD
  # ==================================================================================== #
  frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2

      - name: Install frontend dependencies
        run: bun install

      - name: Lint frontend
        run: bunx --bun biome check . || true

      - name: Build Vite assets
        run: bunx --bun vite build

      - name: Build TailwindCSS
        run: bunx --bun tailwindcss -i ./resources/css/input.css -o ./static/css/tailwind.css --minify

  # ==================================================================================== #
  # UNIT TESTS (fast, no external services)
  # ==================================================================================== #
  test-unit:
    name: Unit Tests
    needs: [validate]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras --group test

      - name: Run unit tests
        run: uv run pytest tests/unit -v --tb=short

  # ==================================================================================== #
  # INTEGRATION TESTS (with PostgreSQL and Redis)
  # Only run on PRs - main deployments use unit tests for speed
  # Parallelized with pytest-split across 4 runners for faster CI
  # ==================================================================================== #
  test-integration:
    name: Integration Tests (${{ matrix.group }}/4)
    needs: [validate]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pydotorg_test
          POSTGRES_INITDB_ARGS: --encoding=UTF-8
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras --group test

      - name: Run integration tests (group ${{ matrix.group }})
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/pydotorg_test
          REDIS_URL: redis://localhost:6379
        run: |
          uv run pytest tests/integration \
            --splits 4 \
            --group ${{ matrix.group }} \
            -v --tb=short \
            -p no:randomly \
            --maxfail=5

  # ==================================================================================== #
  # E2E TESTS (Playwright)
  # Only run on PRs - main deployments use unit tests for speed
  # ==================================================================================== #
  test-e2e:
    name: E2E Tests
    needs: [test-unit, test-integration]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pydotorg_test
          POSTGRES_INITDB_ARGS: --encoding=UTF-8
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras --group test

      - name: Install Playwright browsers
        run: uv run playwright install chromium --with-deps

      - name: Setup Bun for frontend build
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2

      - name: Build frontend assets
        run: |
          bun install
          bunx --bun vite build
          bunx --bun tailwindcss -i ./resources/css/input.css -o ./static/css/tailwind.css --minify

      - name: Setup database
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/pydotorg_test
          REDIS_URL: redis://localhost:6379
          LITESTAR_APP: pydotorg.main:app
        run: uv run litestar database upgrade

      - name: Start test server
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/pydotorg_test
          REDIS_URL: redis://localhost:6379
          LITESTAR_APP: pydotorg.main:app
        run: |
          uv run litestar run --host 0.0.0.0 --port 8000 > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          echo "Server started with PID $SERVER_PID"
          for i in {1..30}; do
            if curl -sf http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Waiting for server... attempt $i/30"
            sleep 2
          done
          echo "Server failed to start. Log output:"
          cat /tmp/server.log
          exit 1

      - name: Run E2E tests
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/pydotorg_test
          REDIS_URL: redis://localhost:6379
          E2E_SERVER_URL: http://localhost:8000
        run: uv run pytest tests/e2e -v --tb=short

  # ==================================================================================== #
  # COVERAGE (runs after tests pass)
  # Only run on PRs - main deployments use unit tests for speed
  # ==================================================================================== #
  coverage:
    name: Test Coverage
    needs: [test-unit, test-integration]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pydotorg_test
          POSTGRES_INITDB_ARGS: --encoding=UTF-8
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras --group test

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/pydotorg_test
          REDIS_URL: redis://localhost:6379
        run: |
          uv run pytest tests/unit tests/integration \
            --cov=src/pydotorg \
            --cov-report=term-missing \
            --cov-report=xml \
            --maxfail=5 \
            -v

      - name: Upload coverage to Codecov
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # ==================================================================================== #
  # CI SUCCESS (gate for branch protection)
  # ==================================================================================== #
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [security, validate, frontend, test-unit, test-integration, test-e2e, coverage]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check CI results
        env:
          SECURITY_RESULT: ${{ needs.security.result }}
          VALIDATE_RESULT: ${{ needs.validate.result }}
          FRONTEND_RESULT: ${{ needs.frontend.result }}
          UNIT_RESULT: ${{ needs.test-unit.result }}
          INTEGRATION_RESULT: ${{ needs.test-integration.result }}
          E2E_RESULT: ${{ needs.test-e2e.result }}
          COVERAGE_RESULT: ${{ needs.coverage.result }}
        run: |
          # Required jobs must succeed
          for result in "${SECURITY_RESULT}" "${VALIDATE_RESULT}" "${FRONTEND_RESULT}" "${UNIT_RESULT}"; do
            if [[ "${result}" != "success" ]]; then
              echo "Required job failed! Result: ${result}"
              exit 1
            fi
          done

          # PR-only jobs can be skipped on main pushes
          for result in "${INTEGRATION_RESULT}" "${E2E_RESULT}" "${COVERAGE_RESULT}"; do
            if [[ "${result}" != "success" && "${result}" != "skipped" ]]; then
              echo "CI job failed! Result: ${result}"
              exit 1
            fi
          done

          echo "CI passed!"
