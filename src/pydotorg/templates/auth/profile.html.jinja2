{% extends "base.html.jinja2" %}
{% from "macros/forms.html.jinja2" import input_field, checkbox_field %}

{% block title %}{{ user.username }}'s Profile - Python.org{% endblock %}

{% block content %}
<div class="section-container py-16">
    <div class="max-w-4xl mx-auto">
        <div class="flex flex-col md:flex-row gap-6">
            <aside class="w-full md:w-64 shrink-0">
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body items-center text-center">
                        <div class="avatar placeholder">
                            <div class="bg-primary text-primary-content rounded-full w-24">
                                <span class="text-3xl">{{ user.username[0]|upper }}</span>
                            </div>
                        </div>
                        <h2 class="card-title">{{ user.first_name }} {{ user.last_name }}</h2>
                        <p class="text-sm opacity-70">@{{ user.username }}</p>
                        {% if user.is_verified %}
                        <div class="badge badge-success gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Verified
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="menu bg-base-200 rounded-box mt-4 p-2">
                    <li><a href="#profile-info" class="active">Profile Info</a></li>
                    <li><a href="#change-password">Change Password</a></li>
                    <li><a href="#account-settings">Account Settings</a></li>
                    <li class="menu-title"><span>Danger Zone</span></li>
                    <li><a href="#delete-account" class="text-error">Delete Account</a></li>
                </div>
            </aside>

            <div class="flex-grow space-y-6">
                <div class="card bg-base-200 shadow-xl" id="profile-info">
                    <div class="card-body">
                        <h2 class="card-title text-2xl mb-4">Profile Information</h2>

                        <div id="profile-messages"></div>

                        <form
                            hx-put="/api/auth/profile"
                            hx-target="#profile-messages"
                            hx-swap="innerHTML"
                            hx-indicator="#profile-spinner"
                            class="space-y-4"
                        >
                            {{ csrf_input|safe }}

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {{ input_field(
                                    name='first_name',
                                    label='First Name',
                                    type='text',
                                    value=user.first_name,
                                    required=true
                                ) }}

                                {{ input_field(
                                    name='last_name',
                                    label='Last Name',
                                    type='text',
                                    value=user.last_name,
                                    required=true
                                ) }}
                            </div>

                            {{ input_field(
                                name='username',
                                label='Username',
                                type='text',
                                value=user.username,
                                required=true
                            ) }}

                            <div class="form-control w-full">
                                <label class="label" for="email">
                                    <span class="label-text">Email Address <span class="text-error">*</span></span>
                                </label>
                                <div class="flex gap-2">
                                    <input
                                        type="email"
                                        name="email"
                                        id="email"
                                        value="{{ user.email }}"
                                        class="input input-bordered w-full"
                                        required
                                    />
                                    {% if not user.is_verified %}
                                    <button
                                        type="button"
                                        class="btn btn-outline btn-sm"
                                        hx-post="/api/auth/verify-email"
                                        hx-target="#profile-messages"
                                    >
                                        Verify
                                    </button>
                                    {% endif %}
                                </div>
                                {% if not user.is_verified %}
                                <label class="label">
                                    <span class="label-text-alt text-warning">Email not verified</span>
                                </label>
                                {% endif %}
                            </div>

                            <div class="card-actions justify-end">
                                <button type="submit" class="btn btn-primary">
                                    <span id="profile-spinner" class="loading loading-spinner loading-sm htmx-indicator"></span>
                                    Update Profile
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card bg-base-200 shadow-xl" id="change-password">
                    <div class="card-body">
                        <h2 class="card-title text-2xl mb-4">Change Password</h2>

                        <div id="password-messages"></div>

                        <form
                            hx-post="/api/auth/change-password"
                            hx-target="#password-messages"
                            hx-swap="innerHTML"
                            hx-indicator="#password-spinner"
                            class="space-y-4"
                        >
                            {{ csrf_input|safe }}

                            {{ input_field(
                                name='current_password',
                                label='Current Password',
                                type='password',
                                placeholder='Enter your current password',
                                required=true
                            ) }}

                            {{ input_field(
                                name='new_password',
                                label='New Password',
                                type='password',
                                placeholder='Enter new password',
                                required=true
                            ) }}

                            {{ input_field(
                                name='confirm_password',
                                label='Confirm New Password',
                                type='password',
                                placeholder='Re-enter new password',
                                required=true
                            ) }}

                            <div class="card-actions justify-end">
                                <button type="submit" class="btn btn-primary">
                                    <span id="password-spinner" class="loading loading-spinner loading-sm htmx-indicator"></span>
                                    Change Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card bg-base-200 shadow-xl" id="account-settings">
                    <div class="card-body">
                        <h2 class="card-title text-2xl mb-4">Account Settings</h2>

                        <div id="settings-messages"></div>

                        <form
                            hx-put="/api/auth/settings"
                            hx-target="#settings-messages"
                            hx-swap="innerHTML"
                            hx-indicator="#settings-spinner"
                            class="space-y-4"
                        >
                            {{ csrf_input|safe }}

                            {{ checkbox_field(
                                name='email_notifications',
                                label='Receive email notifications',
                                checked=user.settings.email_notifications|default(true)
                            ) }}

                            {{ checkbox_field(
                                name='newsletter',
                                label='Subscribe to Python newsletter',
                                checked=user.settings.newsletter|default(false)
                            ) }}

                            {{ checkbox_field(
                                name='profile_public',
                                label='Make profile publicly visible',
                                checked=user.settings.profile_public|default(true)
                            ) }}

                            <div class="card-actions justify-end">
                                <button type="submit" class="btn btn-primary">
                                    <span id="settings-spinner" class="loading loading-spinner loading-sm htmx-indicator"></span>
                                    Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card bg-error bg-opacity-10 border border-error shadow-xl" id="delete-account">
                    <div class="card-body">
                        <h2 class="card-title text-2xl text-error mb-4">Danger Zone</h2>
                        <p class="mb-4">
                            Once you delete your account, there is no going back. Please be certain.
                        </p>
                        <div class="card-actions justify-end">
                            <button
                                class="btn btn-error"
                                onclick="delete_account_modal.showModal()"
                            >
                                Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<dialog id="delete_account_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-error">Delete Account</h3>
        <p class="py-4">
            Are you absolutely sure you want to delete your account? This action cannot be undone.
            All your data will be permanently deleted.
        </p>
        <div class="modal-action">
            <form method="dialog" class="flex gap-2">
                <button class="btn">Cancel</button>
                <button
                    type="button"
                    class="btn btn-error"
                    hx-delete="/api/auth/account"
                    hx-confirm="Type 'DELETE' to confirm"
                    hx-target="body"
                >
                    Delete Account
                </button>
            </form>
        </div>
    </div>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
    document.querySelectorAll('.menu a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
</script>
{% endblock %}
