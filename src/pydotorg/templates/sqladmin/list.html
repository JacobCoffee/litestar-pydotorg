{% extends "sqladmin/layout.html" %}

{% block breadcrumb_items %}
<li><span class="font-semibold">{{ model_view.name_plural }}</span></li>
{% endblock %}

{% block content_header %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-bold text-python-blue">{{ model_view.name_plural }}</h1>
        <p class="text-base-content/70 mt-1">Manage {{ model_view.name_plural|lower }}</p>
    </div>
    <div class="flex gap-2 flex-wrap">
        {% if model_view.can_export %}
        {% if model_view.export_types | length > 1 %}
        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-outline btn-sm gap-2">
                <i data-lucide="download" class="h-4 w-4"></i>
                Export
            </label>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-200 rounded-box w-32">
                {% for export_type in model_view.export_types %}
                <li><a href="{{ url_for('admin:export', identity=model_view.identity, export_type=export_type) }}">{{ export_type | upper }}</a></li>
                {% endfor %}
            </ul>
        </div>
        {% elif model_view.export_types | length == 1 %}
        <a href="{{ url_for('admin:export', identity=model_view.identity, export_type=model_view.export_types[0]) }}" class="btn btn-outline btn-sm gap-2">
            <i data-lucide="download" class="h-4 w-4"></i>
            Export
        </a>
        {% endif %}
        {% endif %}
        {% if model_view.can_create %}
        <a href="{{ url_for('admin:create', identity=model_view.identity) }}" class="btn btn-primary btn-sm gap-2">
            <i data-lucide="plus" class="h-4 w-4"></i>
            New {{ model_view.name }}
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6">
    <div class="flex-1">
        <div class="card bg-base-100 shadow-lg border border-base-300">
            <div class="card-body p-4">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                    <div class="flex gap-2">
                        {% if model_view.can_delete or model_view._custom_actions_in_list %}
                        <div class="dropdown">
                            <label tabindex="0" class="btn btn-outline btn-sm gap-2" {% if not model_view.can_delete and not model_view._custom_actions_in_list %}disabled{% endif %}>
                                Actions
                                <i data-lucide="chevron-down" class="h-4 w-4"></i>
                            </label>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-200 rounded-box w-52">
                                {% if model_view.can_delete %}
                                <li>
                                    <a id="action-delete" href="#" data-name="{{ model_view.name }}" data-url="{{ url_for('admin:delete', identity=model_view.identity) }}" onclick="deleteModal.showModal()">
                                        <i data-lucide="trash-2" class="h-4 w-4 text-error"></i>
                                        Delete selected
                                    </a>
                                </li>
                                {% endif %}
                                {% for custom_action, label in model_view._custom_actions_in_list.items() %}
                                {% if custom_action in model_view._custom_actions_confirmation %}
                                <li><a id="action-customconfirm-{{ custom_action }}" href="#" onclick="confirmationModal{{ custom_action }}.showModal()">{{ label }}</a></li>
                                {% else %}
                                <li><a id="action-custom-{{ custom_action }}" href="#" data-url="{{ model_view._url_for_action(request, custom_action) }}">{{ label }}</a></li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>

                    {% if model_view.column_searchable_list %}
                    <div class="form-control">
                        <div class="input-group input-group-sm">
                            <input id="search-input" type="text" placeholder="Search: {{ model_view.search_placeholder() }}" class="input input-bordered input-sm w-full max-w-xs" value="{{ request.query_params.get('search', '') }}">
                            <button id="search-button" class="btn btn-sm btn-primary">
                                <i data-lucide="search" class="h-4 w-4"></i>
                            </button>
                            {% if request.query_params.get('search') %}
                            <button id="search-reset" class="btn btn-sm btn-ghost">
                                <i data-lucide="x" class="h-4 w-4"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr class="bg-base-200">
                                <th class="w-10">
                                    <label>
                                        <input type="checkbox" class="checkbox checkbox-sm" id="select-all" />
                                    </label>
                                </th>
                                <th class="w-20">Actions</th>
                                {% for name in model_view._list_prop_names %}
                                {% set label = model_view._column_labels.get(name, name) %}
                                <th>
                                    {% if name in model_view._sort_fields %}
                                    {% if request.query_params.get("sortBy") == name and request.query_params.get("sort") == "asc" %}
                                    <a href="{{ request.url.include_query_params(sort='desc') }}" class="link link-hover flex items-center gap-1">
                                        <i data-lucide="chevron-up" class="h-3 w-3"></i>
                                        {{ label }}
                                    </a>
                                    {% elif request.query_params.get("sortBy") == name and request.query_params.get("sort") == "desc" %}
                                    <a href="{{ request.url.include_query_params(sort='asc') }}" class="link link-hover flex items-center gap-1">
                                        <i data-lucide="chevron-down" class="h-3 w-3"></i>
                                        {{ label }}
                                    </a>
                                    {% else %}
                                    <a href="{{ request.url.include_query_params(sortBy=name, sort='asc') }}" class="link link-hover">{{ label }}</a>
                                    {% endif %}
                                    {% else %}
                                    {{ label }}
                                    {% endif %}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in pagination.rows %}
                            <tr class="hover">
                                <td>
                                    <input type="hidden" value="{{ get_object_identifier(row) }}">
                                    <label>
                                        <input class="checkbox checkbox-sm select-box" type="checkbox" />
                                    </label>
                                </td>
                                <td>
                                    <div class="flex gap-1">
                                        {% if model_view.can_view_details %}
                                        <a href="{{ model_view._build_url_for('admin:details', request, row) }}" class="btn btn-ghost btn-xs btn-square" title="View">
                                            <i data-lucide="eye" class="h-4 w-4"></i>
                                        </a>
                                        {% endif %}
                                        {% if model_view.can_edit %}
                                        <a href="{{ model_view._build_url_for('admin:edit', request, row) }}" class="btn btn-ghost btn-xs btn-square" title="Edit">
                                            <i data-lucide="pencil" class="h-4 w-4"></i>
                                        </a>
                                        {% endif %}
                                        {% if model_view.can_delete %}
                                        <button class="btn btn-ghost btn-xs btn-square text-error" title="Delete" data-name="{{ model_view.name }}" data-pk="{{ get_object_identifier(row) }}" data-url="{{ model_view._url_for_delete(request, row) }}" onclick="deleteModal.showModal()">
                                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                                {% for name in model_view._list_prop_names %}
                                {% set value, formatted_value = model_view.get_list_value(row, name) %}
                                {% if name in model_view._relation_names %}
                                {% if is_list(value) %}
                                <td class="max-w-xs truncate">
                                    {% for elem, formatted_elem in zip(value, formatted_value) %}
                                    <a href="{{ model_view._build_url_for('admin:details', request, elem) }}" class="badge badge-sm badge-outline">{{ formatted_elem }}</a>
                                    {% endfor %}
                                </td>
                                {% else %}
                                <td><a href="{{ model_view._url_for_details_with_prop(request, row, name) }}" class="link link-primary">{{ formatted_value }}</a></td>
                                {% endif %}
                                {% else %}
                                <td class="max-w-xs truncate">{{ formatted_value }}</td>
                                {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-4 pt-4 border-t border-base-300">
                    <p class="text-sm text-base-content/60">
                        Showing <span class="font-medium">{{ ((pagination.page - 1) * pagination.page_size) + 1 }}</span> to
                        <span class="font-medium">{{ [pagination.page * pagination.page_size, pagination.count]|min }}</span> of
                        <span class="font-medium">{{ pagination.count }}</span> items
                    </p>

                    <div class="join">
                        {% if pagination.has_previous %}
                        <a href="{{ pagination.previous_page.url }}" class="join-item btn btn-sm">
                            <i data-lucide="chevron-left" class="h-4 w-4"></i>
                        </a>
                        {% else %}
                        <button class="join-item btn btn-sm" disabled>
                            <i data-lucide="chevron-left" class="h-4 w-4"></i>
                        </button>
                        {% endif %}

                        {% for page_control in pagination.page_controls %}
                        <a href="{{ page_control.url }}" class="join-item btn btn-sm {% if page_control.number == pagination.page %}btn-active{% endif %}">
                            {{ page_control.number }}
                        </a>
                        {% endfor %}

                        {% if pagination.has_next %}
                        <a href="{{ pagination.next_page.url }}" class="join-item btn btn-sm">
                            <i data-lucide="chevron-right" class="h-4 w-4"></i>
                        </a>
                        {% else %}
                        <button class="join-item btn btn-sm" disabled>
                            <i data-lucide="chevron-right" class="h-4 w-4"></i>
                        </button>
                        {% endif %}
                    </div>

                    <div class="dropdown dropdown-end">
                        <label tabindex="0" class="btn btn-ghost btn-sm gap-1">
                            {{ request.query_params.get("pageSize") or model_view.page_size }} / page
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </label>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-200 rounded-box w-32">
                            {% for page_size_option in model_view.page_size_options %}
                            <li><a href="{{ request.url.include_query_params(pageSize=page_size_option, page=pagination.resize(page_size_option).page) }}">{{ page_size_option }} / page</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if model_view.get_filters() %}
    <div class="w-full lg:w-72 flex-shrink-0">
        <div class="card bg-base-100 shadow-lg border border-base-300">
            <div class="card-body p-4">
                <h3 class="font-bold text-lg mb-4">Filters</h3>
                {% for filter in model_view.get_filters() %}
                {% if filter.has_operator %}
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text font-medium">{{ filter.title }}</span>
                    </label>
                    {% set current_filter = request.query_params.get(filter.parameter_name, '') %}
                    {% set current_op = request.query_params.get(filter.parameter_name + '_op', '') %}
                    {% if current_filter %}
                    <div class="text-xs text-base-content/60 mb-2">
                        Current: {{ current_op }} {{ current_filter }}
                        <a href="{{ request.url.remove_query_params(filter.parameter_name).remove_query_params(filter.parameter_name + '_op') }}" class="link link-primary">[Clear]</a>
                    </div>
                    {% endif %}
                    <form method="get" class="space-y-2">
                        {% for key, value in request.query_params.items() %}
                        {% if key != filter.parameter_name and key != filter.parameter_name + '_op' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                        {% endfor %}
                        <select name="{{ filter.parameter_name }}_op" class="select select-bordered select-sm w-full" required>
                            <option value="">Select operation...</option>
                            {% for op_value, op_label in filter.get_operation_options_for_model(model_view.model) %}
                            <option value="{{ op_value }}" {% if current_op == op_value %}selected{% endif %}>{{ op_label }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" name="{{ filter.parameter_name }}" placeholder="Enter value" class="input input-bordered input-sm w-full" value="{{ current_filter }}" required>
                        <button type="submit" class="btn btn-primary btn-sm w-full">Apply Filter</button>
                    </form>
                </div>
                {% else %}
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text font-medium">{{ filter.title }}</span>
                    </label>
                    <ul class="menu menu-sm bg-base-200 rounded-lg p-1">
                        {% for lookup in filter.lookups(request, model_view.model, model_view._run_arbitrary_query) %}
                        <li><a href="{{ request.url.include_query_params(**{filter.parameter_name: lookup[0]}) }}" class="text-sm truncate">{{ lookup[1] }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if model_view.can_delete %}
{% include 'sqladmin/modals/delete.html' %}
{% endif %}

{% for custom_action in model_view._custom_actions_in_list %}
{% if custom_action in model_view._custom_actions_confirmation %}
{% with confirmation_message = model_view._custom_actions_confirmation[custom_action], custom_action=custom_action, url=model_view._url_for_action(request, custom_action) %}
{% include 'sqladmin/modals/list_action_confirmation.html' %}
{% endwith %}
{% endif %}
{% endfor %}
{% endblock %}
