{% extends "base.html.jinja2" %}
{% from "macros/forms.html.jinja2" import input_field, textarea_field, select_field, checkbox_field, form_start, form_end %}

{% block title %}Submit a Job - Python Job Board{% endblock %}

{% block content %}
<section class="python-gradient text-white py-12">
    <div class="section-container">
        <div class="max-w-3xl mx-auto text-center">
            <h1 class="text-4xl font-bold mb-4">Post a Python Job</h1>
            <p class="text-lg opacity-90">
                Reach thousands of talented Python developers worldwide
            </p>
        </div>
    </div>
</section>

<section class="bg-base-100 py-12">
    <div class="section-container">
        <div class="max-w-4xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <main class="lg:col-span-2">
                    <div class="card bg-base-200 shadow-md">
                        <div class="card-body">
                            <h2 class="card-title text-2xl text-python-blue mb-6">Job Details</h2>

                            <form
                                id="job-submit-form"
                                class="space-y-6"
                            >
                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold text-python-blue">Company Information</h3>

                                    {{ input_field(
                                        name='company_name',
                                        label='Company Name',
                                        type='text',
                                        placeholder='Acme Corporation',
                                        required=true,
                                        value=form_data.company_name if form_data else ''
                                    ) }}

                                    {{ input_field(
                                        name='company_url',
                                        label='Company Website',
                                        type='url',
                                        placeholder='https://example.com',
                                        value=form_data.company_url if form_data else '',
                                        help_text='Optional - your company website URL'
                                    ) }}
                                </div>

                                <div class="divider"></div>

                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold text-python-blue">Job Information</h3>

                                    {{ input_field(
                                        name='job_title',
                                        label='Job Title',
                                        type='text',
                                        placeholder='Senior Python Developer',
                                        required=true,
                                        value=form_data.job_title if form_data else ''
                                    ) }}

                                    <div class="form-control w-full">
                                        <label class="label" for="job_types">
                                            <span class="label-text">
                                                Job Type
                                                <span class="text-error">*</span>
                                            </span>
                                        </label>
                                        <div class="grid grid-cols-2 gap-2">
                                            {% if job_types %}
                                                {% for job_type in job_types %}
                                                <label class="label cursor-pointer justify-start gap-3 bg-base-100 rounded-lg p-3">
                                                    <input
                                                        type="checkbox"
                                                        name="job_type_ids"
                                                        value="{{ job_type.id }}"
                                                        class="checkbox checkbox-primary"
                                                    />
                                                    <span class="label-text">{{ job_type.name }}</span>
                                                </label>
                                                {% endfor %}
                                            {% else %}
                                                <p class="text-sm text-base-content/60 col-span-2">No job types available</p>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="form-control w-full">
                                        <label class="label" for="categories">
                                            <span class="label-text">Categories</span>
                                        </label>
                                        <div class="grid grid-cols-2 gap-2">
                                            {% if job_categories %}
                                                {% for category in job_categories %}
                                                <label class="label cursor-pointer justify-start gap-3 bg-base-100 rounded-lg p-3">
                                                    <input
                                                        type="checkbox"
                                                        name="category_ids"
                                                        value="{{ category.id }}"
                                                        class="checkbox checkbox-primary"
                                                    />
                                                    <span class="label-text">{{ category.name }}</span>
                                                </label>
                                                {% endfor %}
                                            {% else %}
                                                <p class="text-sm text-base-content/60 col-span-2">No categories available</p>
                                            {% endif %}
                                        </div>
                                    </div>

                                    {{ textarea_field(
                                        name='description',
                                        label='Job Description',
                                        placeholder='Describe the role, responsibilities, and what makes this position exciting...',
                                        rows=8,
                                        required=true,
                                        value=form_data.description if form_data else '',
                                        help_text='Markdown formatting supported'
                                    ) }}

                                    {{ textarea_field(
                                        name='requirements',
                                        label='Requirements',
                                        placeholder='List the required skills, experience, and qualifications...',
                                        rows=6,
                                        value=form_data.requirements if form_data else '',
                                        help_text='Markdown formatting supported'
                                    ) }}
                                </div>

                                <div class="divider"></div>

                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold text-python-blue">Location</h3>

                                    {{ checkbox_field(
                                        name='telecommuting',
                                        label='This is a remote position',
                                        checked=form_data.telecommuting if form_data else false
                                    ) }}

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {{ input_field(
                                            name='city',
                                            label='City',
                                            type='text',
                                            placeholder='San Francisco',
                                            value=form_data.city if form_data else ''
                                        ) }}

                                        {{ input_field(
                                            name='region',
                                            label='State/Region',
                                            type='text',
                                            placeholder='California',
                                            value=form_data.region if form_data else ''
                                        ) }}

                                        {{ input_field(
                                            name='country',
                                            label='Country',
                                            type='text',
                                            placeholder='USA',
                                            required=true,
                                            value=form_data.country if form_data else ''
                                        ) }}
                                    </div>
                                </div>

                                <div class="divider"></div>

                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold text-python-blue">Contact Information</h3>

                                    {{ input_field(
                                        name='contact_name',
                                        label='Contact Name',
                                        type='text',
                                        placeholder='Jane Doe',
                                        required=true,
                                        value=form_data.contact_name if form_data else ''
                                    ) }}

                                    {{ input_field(
                                        name='contact_email',
                                        label='Contact Email',
                                        type='email',
                                        placeholder='jobs@example.com',
                                        required=true,
                                        value=form_data.contact_email if form_data else '',
                                        help_text='This will be visible to job seekers'
                                    ) }}

                                    {{ textarea_field(
                                        name='contact',
                                        label='Application Instructions',
                                        placeholder='How should candidates apply? Include any additional instructions...',
                                        rows=4,
                                        required=true,
                                        value=form_data.contact if form_data else '',
                                        help_text='Provide clear instructions on how to apply'
                                    ) }}
                                </div>

                                <div class="divider"></div>

                                <div id="form-response" class="mb-4"></div>

                                <div class="flex flex-col sm:flex-row gap-4 justify-between items-center pt-4">
                                    <div class="text-sm text-base-content/60">
                                        <span class="text-error">*</span> Required fields
                                    </div>

                                    <div class="flex gap-2">
                                        <button
                                            type="button"
                                            class="btn btn-ghost"
                                            onclick="window.history.back()"
                                        >
                                            Cancel
                                        </button>

                                        <button
                                            type="button"
                                            class="btn btn-outline gap-2"
                                            hx-post="/jobs/preview"
                                            hx-include="#job-submit-form"
                                            hx-target="#preview-modal-content"
                                            onclick="preview_modal.showModal()"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                            Preview
                                        </button>

                                        <button
                                            type="submit"
                                            class="btn btn-primary gap-2"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                            </svg>
                                            Submit Job
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </main>

                <aside class="lg:col-span-1">
                    <div class="card bg-base-200 shadow-sm sticky top-4">
                        <div class="card-body">
                            <h3 class="card-title text-lg mb-4">Posting Guidelines</h3>
                            <div class="space-y-4 text-sm">
                                <div class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <div>
                                        <p class="font-semibold">Python-related jobs only</p>
                                        <p class="text-base-content/60">Position must involve Python development</p>
                                    </div>
                                </div>

                                <div class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <div>
                                        <p class="font-semibold">Clear description</p>
                                        <p class="text-base-content/60">Include responsibilities and requirements</p>
                                    </div>
                                </div>

                                <div class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <div>
                                        <p class="font-semibold">Contact information</p>
                                        <p class="text-base-content/60">Provide valid email for applications</p>
                                    </div>
                                </div>

                                <div class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <div>
                                        <p class="font-semibold">Review process</p>
                                        <p class="text-base-content/60">Jobs are reviewed before publishing</p>
                                    </div>
                                </div>
                            </div>

                            <div class="divider"></div>

                            <div class="alert alert-info">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div class="text-xs">
                                    <p class="font-semibold">Posting is free!</p>
                                    <p>Your job will be reviewed within 24-48 hours</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</section>

<dialog id="preview_modal" class="modal">
    <div class="modal-box max-w-4xl">
        <button
            type="button"
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
            onclick="preview_modal.close()"
        >âœ•</button>
        <h3 class="font-bold text-lg mb-4">Job Preview</h3>
        <div id="preview-modal-content">
            <div class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('job-submit-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    const jobTypeIds = formData.getAll('job_type_ids');
    const categoryIds = formData.getAll('category_ids');

    const data = {
        company_name: formData.get('company_name') || '',
        url: formData.get('company_url') || null,
        job_title: formData.get('job_title') || '',
        description: formData.get('description') || '',
        requirements: formData.get('requirements') || null,
        city: formData.get('city') || null,
        region: formData.get('region') || null,
        country: formData.get('country') || '',
        email: formData.get('contact_email') || '',
        contact: formData.get('contact') || null,
        telecommuting: formData.get('telecommuting') === 'on',
        agencies: false,
        job_type_ids: jobTypeIds,
        category_id: categoryIds.length > 0 ? categoryIds[0] : null
    };

    fetch('/api/v1/jobs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Submission failed');
        }
        return response.json();
    })
    .then(result => {
        document.getElementById('form-response').innerHTML = `
            <div class="alert alert-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <h3 class="font-bold">Success!</h3>
                    <div class="text-sm">Your job has been submitted for review.</div>
                </div>
            </div>
        `;
        setTimeout(() => {
            window.location.href = '/jobs';
        }, 2000);
    })
    .catch(error => {
        document.getElementById('form-response').innerHTML = `
            <div class="alert alert-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <h3 class="font-bold">Error!</h3>
                    <div class="text-sm">Failed to submit job. Please try again.</div>
                </div>
            </div>
        `;
    });
});
</script>
{% endblock %}
