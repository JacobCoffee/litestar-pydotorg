"""Litestar application entry point with authentication enabled."""

from __future__ import annotations

from pathlib import Path

from advanced_alchemy.extensions.litestar import SQLAlchemyPlugin
from advanced_alchemy.extensions.litestar.plugins.init.config.asyncio import SQLAlchemyAsyncConfig
from litestar import Litestar, get
from litestar.config.compression import CompressionConfig
from litestar.contrib.jinja import JinjaTemplateEngine
from litestar.middleware import DefineMiddleware
from litestar.openapi import OpenAPIConfig
from litestar.static_files import create_static_files_router
from litestar.template.config import TemplateConfig

from pydotorg.config import settings
from pydotorg.core.auth import JWTAuthMiddleware
from pydotorg.core.database.base import AuditBase
from pydotorg.domains.users.auth_controller import AuthController


@get("/", sync_to_thread=False)
def index() -> dict[str, str]:
    return {
        "name": settings.site_name,
        "description": settings.site_description,
        "version": "0.1.0",
    }


@get("/health", sync_to_thread=False)
def health_check() -> dict[str, str]:
    return {"status": "healthy"}


sqlalchemy_config = SQLAlchemyAsyncConfig(
    connection_string=str(settings.database_url),
    metadata=AuditBase.metadata,
    create_all=settings.debug,
)

sqlalchemy_plugin = SQLAlchemyPlugin(config=sqlalchemy_config)

templates_dir = Path(__file__).parent / "templates"
static_dir = Path(__file__).parent.parent.parent / "static"


app = Litestar(
    route_handlers=[
        index,
        health_check,
        AuthController,
        create_static_files_router(
            path="/static",
            directories=[static_dir] if static_dir.exists() else [],
            name="static",
        ),
    ],
    plugins=[sqlalchemy_plugin],
    middleware=[
        DefineMiddleware(JWTAuthMiddleware),
    ],
    template_config=TemplateConfig(
        directory=templates_dir,
        engine=JinjaTemplateEngine,
    ),
    openapi_config=OpenAPIConfig(
        title=settings.site_name,
        version="0.1.0",
        description=settings.site_description,
    ),
    compression_config=CompressionConfig(backend="gzip", gzip_compress_level=6),
    debug=settings.debug,
)
