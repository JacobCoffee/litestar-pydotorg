<!DOCTYPE html>
<html lang="en" data-accent-color="blue" data-content_root="../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>sqlalchemy.orm.relationships - litestar-pydotorg</title><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=14737038" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=513f0650" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.relationships"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../../index.html">
      
      
      <strong>litestar-pydotorg</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul><li class="link">
          <a href="https://litestar.dev/">
            <span>Litestar</span></a>
        </li><li class="link">
          <a href="https://python.org/">
            <span>Python.org</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/JacobCoffee/litestar-pydotorg" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Learn</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started/quickstart.html">Quickstart</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/development.html">Development Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/contributing.html">Contribution Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/testing.html">Testing Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/debugging.html">Debugging Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/api-usage.html">API Usage Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/authentication.html">Authentication Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/feature-flags.html">Feature Flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/configuration.html">Configuration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/deployment.html">Deployment Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/docker.html">Docker Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/troubleshooting.html">Troubleshooting Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cookbook/index.html">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cookbook/domain-patterns.html">Domain Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cookbook/authentication-recipes.html">Authentication Recipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cookbook/database-recipes.html">Database Recipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cookbook/testing-recipes.html">Testing Recipes</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core/index.html">Core Infrastructure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/auth.html">Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/cache.html">Caching</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/database.html">Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/email.html">Email</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/exceptions.html">Exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/features.html">Feature Flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/feeds.html">RSS/Atom Feeds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/ical.html">iCalendar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/logging.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/middleware.html">Middleware</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/openapi.html">OpenAPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/ratelimit.html">Rate Limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/search.html">Search</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/security.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core/worker.html">Background Worker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/domains/index.html">Domain Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/about.html">About</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/admin.html">Admin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/banners.html">banners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/blogs.html">blogs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/codesamples.html">Code Samples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/community.html">community</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/docs.html">Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/downloads.html">downloads</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/events.html">events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/jobs.html">jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/mailing.html">Mailing Lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/minutes.html">Minutes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/nominations.html">Nominations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/pages.html">pages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/search.html">Search</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/sponsors.html">sponsors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/sqladmin.html">SQLAdmin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/successstories.html">Success Stories</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/users.html">users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domains/work_groups.html">Work Groups</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/lib.html">Library Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tasks.html">Background Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/config.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/main.html">Application Entry Point</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/index.html">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/ARCHITECTURE.html">Litestar Python.org Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/DATABASE_SCHEMA.html">Database Schema Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/DOMAIN_MODELS.html">Domain Models Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/QUICK_START.html">Litestar Python.org Quick Start Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/API_TAGS_INDEX.html">API Tags Documentation Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/RATE_LIMITING_ARCHITECTURE.html">Rate Limiting Architecture Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/adr/001-litestar-framework.html">ADR-001: Use Litestar as Web Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture/adr/002-saq-background-tasks.html">ADR-002: Use SAQ for Background Task Processing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/JacobCoffee/litestar-pydotorg">GitHub</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">litestar-pydotorg</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sqlalchemy.orm.relationships</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue dark-code" role="main">
          <h1>Source code for sqlalchemy.orm.relationships</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># orm/relationships.py</span>
</span><span data-line="2"><span class="c1"># Copyright (C) 2005-2025 the SQLAlchemy authors and contributors</span>
</span><span data-line="3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span data-line="4"><span class="c1">#</span>
</span><span data-line="5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span data-line="6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span data-line="7">
</span><span data-line="8"><span class="sd">&quot;&quot;&quot;Heuristics related to join conditions as used in</span>
</span><span data-line="9"><span class="sd">:func:`_orm.relationship`.</span>
</span><span data-line="10">
</span><span data-line="11"><span class="sd">Provides the :class:`.JoinCondition` object, which encapsulates</span>
</span><span data-line="12"><span class="sd">SQL annotation and aliasing behavior focused on the `primaryjoin`</span>
</span><span data-line="13"><span class="sd">and `secondaryjoin` aspects of :func:`_orm.relationship`.</span>
</span><span data-line="14">
</span><span data-line="15"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="16"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="17">
</span><span data-line="18"><span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
</span><span data-line="19"><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">abc</span>
</span><span data-line="20"><span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
</span><span data-line="21"><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_py_inspect</span>
</span><span data-line="22"><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
</span><span data-line="23"><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span data-line="24"><span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
</span><span data-line="25"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span data-line="26"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span data-line="27"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span><span data-line="28"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span>
</span><span data-line="29"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
</span><span data-line="30"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrozenSet</span>
</span><span data-line="31"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generic</span>
</span><span data-line="32"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
</span><span data-line="33"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>
</span><span data-line="34"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span data-line="35"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>
</span><span data-line="36"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoReturn</span>
</span><span data-line="37"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span data-line="38"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
</span><span data-line="39"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span>
</span><span data-line="40"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
</span><span data-line="41"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span>
</span><span data-line="42"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span>
</span><span data-line="43"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span data-line="44"><span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>
</span><span data-line="45">
</span><span data-line="46"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">attributes</span>
</span><span data-line="47"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">strategy_options</span>
</span><span data-line="48"><span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">insp_is_aliased_class</span>
</span><span data-line="49"><span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_has_collection_adapter</span>
</span><span data-line="50"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DeclarativeMapped</span>
</span><span data-line="51"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_is_mapped_class</span>
</span><span data-line="52"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">class_mapper</span>
</span><span data-line="53"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DynamicMapped</span>
</span><span data-line="54"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoaderCallableStatus</span>
</span><span data-line="55"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PassiveFlag</span>
</span><span data-line="56"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">state_str</span>
</span><span data-line="57"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">WriteOnlyMapped</span>
</span><span data-line="58"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AttributeOptions</span>
</span><span data-line="59"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">_IntrospectsAnnotations</span>
</span><span data-line="60"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">MANYTOMANY</span>
</span><span data-line="61"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">MANYTOONE</span>
</span><span data-line="62"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">ONETOMANY</span>
</span><span data-line="63"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">PropComparator</span>
</span><span data-line="64"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelationshipDirection</span>
</span><span data-line="65"><span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategizedProperty</span>
</span><span data-line="66"><span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">_orm_annotate</span>
</span><span data-line="67"><span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">_orm_deannotate</span>
</span><span data-line="68"><span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">CascadeOptions</span>
</span><span data-line="69"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">sa_exc</span>
</span><span data-line="70"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">Exists</span>
</span><span data-line="71"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span>
</span><span data-line="72"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">schema</span>
</span><span data-line="73"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">sql</span>
</span><span data-line="74"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>
</span><span data-line="75"><span class="kn">from</span><span class="w"> </span><span class="nn">..inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span>
</span><span data-line="76"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">coercions</span>
</span><span data-line="77"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">expression</span>
</span><span data-line="78"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">operators</span>
</span><span data-line="79"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">roles</span>
</span><span data-line="80"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">visitors</span>
</span><span data-line="81"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ColumnExpressionArgument</span>
</span><span data-line="82"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_HasClauseElement</span>
</span><span data-line="83"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.annotation</span><span class="w"> </span><span class="kn">import</span> <span class="n">_safe_annotate</span>
</span><span data-line="84"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnClause</span>
</span><span data-line="85"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnElement</span>
</span><span data-line="86"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">_deep_annotate</span>
</span><span data-line="87"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">_deep_deannotate</span>
</span><span data-line="88"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">_shallow_annotate</span>
</span><span data-line="89"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">adapt_criterion_to_null</span>
</span><span data-line="90"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClauseAdapter</span>
</span><span data-line="91"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">join_condition</span>
</span><span data-line="92"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">selectables_overlap</span>
</span><span data-line="93"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">visit_binary_product</span>
</span><span data-line="94"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">de_optionalize_union_types</span>
</span><span data-line="95"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
</span><span data-line="96"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">resolve_name_to_real_class_name</span>
</span><span data-line="97">
</span><span data-line="98"><span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="99">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_EntityType</span>
</span><span data-line="100">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ExternalEntityType</span>
</span><span data-line="101">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_IdentityKeyType</span>
</span><span data-line="102">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InstanceDict</span>
</span><span data-line="103">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InternalEntityType</span>
</span><span data-line="104">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_O</span>
</span><span data-line="105">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_RegistryType</span>
</span><span data-line="106">    <span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
</span><span data-line="107">    <span class="kn">from</span><span class="w"> </span><span class="nn">.clsregistry</span><span class="w"> </span><span class="kn">import</span> <span class="n">_class_resolver</span>
</span><span data-line="108">    <span class="kn">from</span><span class="w"> </span><span class="nn">.clsregistry</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ModNS</span>
</span><span data-line="109">    <span class="kn">from</span><span class="w"> </span><span class="nn">.decl_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ClassScanMapperConfig</span>
</span><span data-line="110">    <span class="kn">from</span><span class="w"> </span><span class="nn">.dependency</span><span class="w"> </span><span class="kn">import</span> <span class="n">DependencyProcessor</span>
</span><span data-line="111">    <span class="kn">from</span><span class="w"> </span><span class="nn">.mapper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapper</span>
</span><span data-line="112">    <span class="kn">from</span><span class="w"> </span><span class="nn">.query</span><span class="w"> </span><span class="kn">import</span> <span class="n">Query</span>
</span><span data-line="113">    <span class="kn">from</span><span class="w"> </span><span class="nn">.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
</span><span data-line="114">    <span class="kn">from</span><span class="w"> </span><span class="nn">.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">InstanceState</span>
</span><span data-line="115">    <span class="kn">from</span><span class="w"> </span><span class="nn">.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyLoader</span>
</span><span data-line="116">    <span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">AliasedClass</span>
</span><span data-line="117">    <span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">AliasedInsp</span>
</span><span data-line="118">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_CoreAdapterProto</span>
</span><span data-line="119">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_EquivalentColumnMap</span>
</span><span data-line="120">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InfoType</span>
</span><span data-line="121">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.annotation</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AnnotationDict</span>
</span><span data-line="122">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.annotation</span><span class="w"> </span><span class="kn">import</span> <span class="n">SupportsAnnotations</span>
</span><span data-line="123">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">BinaryExpression</span>
</span><span data-line="124">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">BindParameter</span>
</span><span data-line="125">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClauseElement</span>
</span><span data-line="126">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
</span><span data-line="127">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.selectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">FromClause</span>
</span><span data-line="128">    <span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AnnotationScanType</span>
</span><span data-line="129">    <span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">RODescriptorReference</span>
</span><span data-line="130">
</span><span data-line="131"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="132"><span class="n">_T1</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T1&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="133"><span class="n">_T2</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T2&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="134">
</span><span data-line="135"><span class="n">_PT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_PT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="136">
</span><span data-line="137"><span class="n">_PT2</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_PT2&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="138">
</span><span data-line="139">
</span><span data-line="140"><span class="n">_RelationshipArgumentType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="141">    <span class="nb">str</span><span class="p">,</span>
</span><span data-line="142">    <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="143">    <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span data-line="144">    <span class="s2">&quot;Mapper[_T]&quot;</span><span class="p">,</span>
</span><span data-line="145">    <span class="s2">&quot;AliasedClass[_T]&quot;</span><span class="p">,</span>
</span><span data-line="146">    <span class="n">Callable</span><span class="p">[[],</span> <span class="s2">&quot;Mapper[_T]&quot;</span><span class="p">],</span>
</span><span data-line="147">    <span class="n">Callable</span><span class="p">[[],</span> <span class="s2">&quot;AliasedClass[_T]&quot;</span><span class="p">],</span>
</span><span data-line="148"><span class="p">]</span>
</span><span data-line="149">
</span><span data-line="150"><span class="n">_LazyLoadArgumentType</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
</span><span data-line="151">    <span class="s2">&quot;select&quot;</span><span class="p">,</span>
</span><span data-line="152">    <span class="s2">&quot;joined&quot;</span><span class="p">,</span>
</span><span data-line="153">    <span class="s2">&quot;selectin&quot;</span><span class="p">,</span>
</span><span data-line="154">    <span class="s2">&quot;subquery&quot;</span><span class="p">,</span>
</span><span data-line="155">    <span class="s2">&quot;raise&quot;</span><span class="p">,</span>
</span><span data-line="156">    <span class="s2">&quot;raise_on_sql&quot;</span><span class="p">,</span>
</span><span data-line="157">    <span class="s2">&quot;noload&quot;</span><span class="p">,</span>
</span><span data-line="158">    <span class="s2">&quot;immediate&quot;</span><span class="p">,</span>
</span><span data-line="159">    <span class="s2">&quot;write_only&quot;</span><span class="p">,</span>
</span><span data-line="160">    <span class="s2">&quot;dynamic&quot;</span><span class="p">,</span>
</span><span data-line="161">    <span class="kc">True</span><span class="p">,</span>
</span><span data-line="162">    <span class="kc">False</span><span class="p">,</span>
</span><span data-line="163">    <span class="kc">None</span><span class="p">,</span>
</span><span data-line="164"><span class="p">]</span>
</span><span data-line="165">
</span><span data-line="166">
</span><span data-line="167"><span class="n">_RelationshipJoinConditionArgument</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="168">    <span class="nb">str</span><span class="p">,</span> <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
</span><span data-line="169"><span class="p">]</span>
</span><span data-line="170"><span class="n">_RelationshipSecondaryArgument</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="171">    <span class="s2">&quot;FromClause&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="s2">&quot;FromClause&quot;</span><span class="p">]</span>
</span><span data-line="172"><span class="p">]</span>
</span><span data-line="173"><span class="n">_ORMOrderByArgument</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="174">    <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span>
</span><span data-line="175">    <span class="nb">str</span><span class="p">,</span>
</span><span data-line="176">    <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="177">    <span class="n">Callable</span><span class="p">[[],</span> <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="178">    <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
</span><span data-line="179">    <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
</span><span data-line="180"><span class="p">]</span>
</span><span data-line="181"><span class="n">ORMBackrefArgument</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="182">
</span><span data-line="183"><span class="n">_ORMColCollectionElement</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="184">    <span class="n">ColumnClause</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="185">    <span class="n">_HasClauseElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="186">    <span class="n">roles</span><span class="o">.</span><span class="n">DMLColumnRole</span><span class="p">,</span>
</span><span data-line="187">    <span class="s2">&quot;Mapped[Any]&quot;</span><span class="p">,</span>
</span><span data-line="188"><span class="p">]</span>
</span><span data-line="189"><span class="n">_ORMColCollectionArgument</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="190">    <span class="nb">str</span><span class="p">,</span>
</span><span data-line="191">    <span class="n">Sequence</span><span class="p">[</span><span class="n">_ORMColCollectionElement</span><span class="p">],</span>
</span><span data-line="192">    <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_ORMColCollectionElement</span><span class="p">]],</span>
</span><span data-line="193">    <span class="n">Callable</span><span class="p">[[],</span> <span class="n">_ORMColCollectionElement</span><span class="p">],</span>
</span><span data-line="194">    <span class="n">_ORMColCollectionElement</span><span class="p">,</span>
</span><span data-line="195"><span class="p">]</span>
</span><span data-line="196">
</span><span data-line="197">
</span><span data-line="198"><span class="n">_CEA</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_CEA&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span>
</span><span data-line="199">
</span><span data-line="200"><span class="n">_CE</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_CE&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;ColumnElement[Any]&quot;</span><span class="p">)</span>
</span><span data-line="201">
</span><span data-line="202">
</span><span data-line="203"><span class="n">_ColumnPairIterable</span> <span class="o">=</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="204">
</span><span data-line="205"><span class="n">_ColumnPairs</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="206">
</span><span data-line="207"><span class="n">_MutableColumnPairs</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="208">
</span><span data-line="209">
</span><span data-line="210"><span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">_CEA</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_CEA</span><span class="p">:</span>
</span><span data-line="211"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Annotate a portion of a primaryjoin expression</span>
</span><span data-line="212"><span class="sd">    with a &#39;remote&#39; annotation.</span>
</span><span data-line="213">
</span><span data-line="214"><span class="sd">    See the section :ref:`relationship_custom_foreign` for a</span>
</span><span data-line="215"><span class="sd">    description of use.</span>
</span><span data-line="216">
</span><span data-line="217"><span class="sd">    .. seealso::</span>
</span><span data-line="218">
</span><span data-line="219"><span class="sd">        :ref:`relationship_custom_foreign`</span>
</span><span data-line="220">
</span><span data-line="221"><span class="sd">        :func:`.foreign`</span>
</span><span data-line="222">
</span><span data-line="223"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="224">    <span class="k">return</span> <span class="n">_annotate_columns</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
</span><span data-line="225">        <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">ColumnArgumentRole</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span data-line="226">    <span class="p">)</span>
</span><span data-line="227">
</span><span data-line="228">
</span><span data-line="229"><span class="k">def</span><span class="w"> </span><span class="nf">foreign</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">_CEA</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_CEA</span><span class="p">:</span>
</span><span data-line="230"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Annotate a portion of a primaryjoin expression</span>
</span><span data-line="231"><span class="sd">    with a &#39;foreign&#39; annotation.</span>
</span><span data-line="232">
</span><span data-line="233"><span class="sd">    See the section :ref:`relationship_custom_foreign` for a</span>
</span><span data-line="234"><span class="sd">    description of use.</span>
</span><span data-line="235">
</span><span data-line="236"><span class="sd">    .. seealso::</span>
</span><span data-line="237">
</span><span data-line="238"><span class="sd">        :ref:`relationship_custom_foreign`</span>
</span><span data-line="239">
</span><span data-line="240"><span class="sd">        :func:`.remote`</span>
</span><span data-line="241">
</span><span data-line="242"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="243">
</span><span data-line="244">    <span class="k">return</span> <span class="n">_annotate_columns</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
</span><span data-line="245">        <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">ColumnArgumentRole</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;foreign&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span data-line="246">    <span class="p">)</span>
</span><span data-line="247">
</span><span data-line="248">
</span><span data-line="249"><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
</span><span data-line="250"><span class="k">class</span><span class="w"> </span><span class="nc">_RelationshipArg</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">]):</span>
</span><span data-line="251"><span class="w">    </span><span class="sd">&quot;&quot;&quot;stores a user-defined parameter value that must be resolved and</span>
</span><span data-line="252"><span class="sd">    parsed later at mapper configuration time.</span>
</span><span data-line="253">
</span><span data-line="254"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="255">
</span><span data-line="256">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;argument&quot;</span><span class="p">,</span> <span class="s2">&quot;resolved&quot;</span>
</span><span data-line="257">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="258">    <span class="n">argument</span><span class="p">:</span> <span class="n">_T1</span>
</span><span data-line="259">    <span class="n">resolved</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_T2</span><span class="p">]</span>
</span><span data-line="260">
</span><span data-line="261">    <span class="k">def</span><span class="w"> </span><span class="nf">_is_populated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="262">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="263">
</span><span data-line="264">    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_against_registry</span><span class="p">(</span>
</span><span data-line="265">        <span class="bp">self</span><span class="p">,</span> <span class="n">clsregistry_resolver</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">_class_resolver</span><span class="p">]</span>
</span><span data-line="266">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="267">        <span class="n">attr_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument</span>
</span><span data-line="268">
</span><span data-line="269">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="270">            <span class="bp">self</span><span class="o">.</span><span class="n">resolved</span> <span class="o">=</span> <span class="n">clsregistry_resolver</span><span class="p">(</span>
</span><span data-line="271">                <span class="n">attr_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;secondary&quot;</span>
</span><span data-line="272">            <span class="p">)()</span>
</span><span data-line="273">        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="n">attr_value</span><span class="p">):</span>
</span><span data-line="274">            <span class="bp">self</span><span class="o">.</span><span class="n">resolved</span> <span class="o">=</span> <span class="n">attr_value</span><span class="p">()</span>
</span><span data-line="275">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="276">            <span class="bp">self</span><span class="o">.</span><span class="n">resolved</span> <span class="o">=</span> <span class="n">attr_value</span>
</span><span data-line="277">
</span><span data-line="278">
</span><span data-line="279"><span class="n">_RelationshipOrderByArg</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">...</span><span class="p">]]</span>
</span><span data-line="280">
</span><span data-line="281">
</span><span data-line="282"><span class="k">class</span><span class="w"> </span><span class="nc">_RelationshipArgs</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
</span><span data-line="283"><span class="w">    </span><span class="sd">&quot;&quot;&quot;stores user-passed parameters that are resolved at mapper configuration</span>
</span><span data-line="284"><span class="sd">    time.</span>
</span><span data-line="285">
</span><span data-line="286"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="287">
</span><span data-line="288">    <span class="n">secondary</span><span class="p">:</span> <span class="n">_RelationshipArg</span><span class="p">[</span>
</span><span data-line="289">        <span class="n">Optional</span><span class="p">[</span><span class="n">_RelationshipSecondaryArgument</span><span class="p">],</span>
</span><span data-line="290">        <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="291">    <span class="p">]</span>
</span><span data-line="292">    <span class="n">primaryjoin</span><span class="p">:</span> <span class="n">_RelationshipArg</span><span class="p">[</span>
</span><span data-line="293">        <span class="n">Optional</span><span class="p">[</span><span class="n">_RelationshipJoinConditionArgument</span><span class="p">],</span>
</span><span data-line="294">        <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="295">    <span class="p">]</span>
</span><span data-line="296">    <span class="n">secondaryjoin</span><span class="p">:</span> <span class="n">_RelationshipArg</span><span class="p">[</span>
</span><span data-line="297">        <span class="n">Optional</span><span class="p">[</span><span class="n">_RelationshipJoinConditionArgument</span><span class="p">],</span>
</span><span data-line="298">        <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="299">    <span class="p">]</span>
</span><span data-line="300">    <span class="n">order_by</span><span class="p">:</span> <span class="n">_RelationshipArg</span><span class="p">[</span><span class="n">_ORMOrderByArgument</span><span class="p">,</span> <span class="n">_RelationshipOrderByArg</span><span class="p">]</span>
</span><span data-line="301">    <span class="n">foreign_keys</span><span class="p">:</span> <span class="n">_RelationshipArg</span><span class="p">[</span>
</span><span data-line="302">        <span class="n">Optional</span><span class="p">[</span><span class="n">_ORMColCollectionArgument</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="303">    <span class="p">]</span>
</span><span data-line="304">    <span class="n">remote_side</span><span class="p">:</span> <span class="n">_RelationshipArg</span><span class="p">[</span>
</span><span data-line="305">        <span class="n">Optional</span><span class="p">[</span><span class="n">_ORMColCollectionArgument</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="306">    <span class="p">]</span>
</span><span data-line="307">
</span><span data-line="308">
</span><span data-line="309"><span class="nd">@log</span><span class="o">.</span><span class="n">class_logger</span>
</span><span data-line="310"><span class="k">class</span><span class="w"> </span><span class="nc">RelationshipProperty</span><span class="p">(</span>
</span><span data-line="311">    <span class="n">_IntrospectsAnnotations</span><span class="p">,</span> <span class="n">StrategizedProperty</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">log</span><span class="o">.</span><span class="n">Identified</span>
</span><span data-line="312"><span class="p">):</span>
</span><span data-line="313"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Describes an object property that holds a single item or list</span>
</span><span data-line="314"><span class="sd">    of items that correspond to a related database table.</span>
</span><span data-line="315">
</span><span data-line="316"><span class="sd">    Public constructor is the :func:`_orm.relationship` function.</span>
</span><span data-line="317">
</span><span data-line="318"><span class="sd">    .. seealso::</span>
</span><span data-line="319">
</span><span data-line="320"><span class="sd">        :ref:`relationship_config_toplevel`</span>
</span><span data-line="321">
</span><span data-line="322"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="323">
</span><span data-line="324">    <span class="n">strategy_wildcard_key</span> <span class="o">=</span> <span class="n">strategy_options</span><span class="o">.</span><span class="n">_RELATIONSHIP_TOKEN</span>
</span><span data-line="325">    <span class="n">inherit_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="326"><span class="w">    </span><span class="sd">&quot;&quot;&quot;:meta private:&quot;&quot;&quot;</span>
</span><span data-line="327">
</span><span data-line="328">    <span class="n">_links_to_entity</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="329">    <span class="n">_is_relationship</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="330">
</span><span data-line="331">    <span class="n">_overlaps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="332">
</span><span data-line="333">    <span class="n">_lazy_strategy</span><span class="p">:</span> <span class="n">LazyLoader</span>
</span><span data-line="334">
</span><span data-line="335">    <span class="n">_persistence_only</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span data-line="336">        <span class="n">passive_deletes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="337">        <span class="n">passive_updates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="338">        <span class="n">enable_typechecks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="339">        <span class="n">active_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="340">        <span class="n">cascade_backrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="341">    <span class="p">)</span>
</span><span data-line="342">
</span><span data-line="343">    <span class="n">_dependency_processor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DependencyProcessor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="344">
</span><span data-line="345">    <span class="n">primaryjoin</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
</span><span data-line="346">    <span class="n">secondaryjoin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span>
</span><span data-line="347">    <span class="n">secondary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span data-line="348">    <span class="n">_join_condition</span><span class="p">:</span> <span class="n">JoinCondition</span>
</span><span data-line="349">    <span class="n">order_by</span><span class="p">:</span> <span class="n">_RelationshipOrderByArg</span>
</span><span data-line="350">
</span><span data-line="351">    <span class="n">_user_defined_foreign_keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="352">    <span class="n">_calculated_foreign_keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="353">
</span><span data-line="354">    <span class="n">remote_side</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="355">    <span class="n">local_columns</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="356">
</span><span data-line="357">    <span class="n">synchronize_pairs</span><span class="p">:</span> <span class="n">_ColumnPairs</span>
</span><span data-line="358">    <span class="n">secondary_synchronize_pairs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnPairs</span><span class="p">]</span>
</span><span data-line="359">
</span><span data-line="360">    <span class="n">local_remote_pairs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnPairs</span><span class="p">]</span>
</span><span data-line="361">
</span><span data-line="362">    <span class="n">direction</span><span class="p">:</span> <span class="n">RelationshipDirection</span>
</span><span data-line="363">
</span><span data-line="364">    <span class="n">_init_args</span><span class="p">:</span> <span class="n">_RelationshipArgs</span>
</span><span data-line="365">
</span><span data-line="366">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="367">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="368">        <span class="n">argument</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_RelationshipArgumentType</span><span class="p">[</span><span class="n">_T</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="369">        <span class="n">secondary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_RelationshipSecondaryArgument</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="370">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="371">        <span class="n">uselist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="372">        <span class="n">collection_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span data-line="373">            <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="374">        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="375">        <span class="n">primaryjoin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_RelationshipJoinConditionArgument</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="376">        <span class="n">secondaryjoin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_RelationshipJoinConditionArgument</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="377">        <span class="n">back_populates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="378">        <span class="n">order_by</span><span class="p">:</span> <span class="n">_ORMOrderByArgument</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="379">        <span class="n">backref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ORMBackrefArgument</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="380">        <span class="n">overlaps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="381">        <span class="n">post_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="382">        <span class="n">cascade</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;save-update, merge&quot;</span><span class="p">,</span>
</span><span data-line="383">        <span class="n">viewonly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="384">        <span class="n">attribute_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AttributeOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="385">        <span class="n">lazy</span><span class="p">:</span> <span class="n">_LazyLoadArgumentType</span> <span class="o">=</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
</span><span data-line="386">        <span class="n">passive_deletes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="387">        <span class="n">passive_updates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="388">        <span class="n">active_history</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="389">        <span class="n">enable_typechecks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="390">        <span class="n">foreign_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ORMColCollectionArgument</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="391">        <span class="n">remote_side</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ORMColCollectionArgument</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="392">        <span class="n">join_depth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="393">        <span class="n">comparator_factory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span data-line="394">            <span class="n">Type</span><span class="p">[</span><span class="n">RelationshipProperty</span><span class="o">.</span><span class="n">Comparator</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="395">        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="396">        <span class="n">single_parent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="397">        <span class="n">innerjoin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="398">        <span class="n">distinct_target_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="399">        <span class="n">load_on_pending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="400">        <span class="n">query_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="401">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="402">        <span class="n">omit_join</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="403">        <span class="n">sync_backref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="404">        <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="405">        <span class="n">bake_queries</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="406">        <span class="n">cascade_backrefs</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="407">        <span class="n">_local_remote_pairs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnPairs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="408">        <span class="n">_legacy_inactive_history_style</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="409">    <span class="p">):</span>
</span><span data-line="410">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attribute_options</span><span class="o">=</span><span class="n">attribute_options</span><span class="p">)</span>
</span><span data-line="411">
</span><span data-line="412">        <span class="bp">self</span><span class="o">.</span><span class="n">uselist</span> <span class="o">=</span> <span class="n">uselist</span>
</span><span data-line="413">        <span class="bp">self</span><span class="o">.</span><span class="n">argument</span> <span class="o">=</span> <span class="n">argument</span>
</span><span data-line="414">
</span><span data-line="415">        <span class="bp">self</span><span class="o">.</span><span class="n">_init_args</span> <span class="o">=</span> <span class="n">_RelationshipArgs</span><span class="p">(</span>
</span><span data-line="416">            <span class="n">_RelationshipArg</span><span class="p">(</span><span class="s2">&quot;secondary&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="417">            <span class="n">_RelationshipArg</span><span class="p">(</span><span class="s2">&quot;primaryjoin&quot;</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="418">            <span class="n">_RelationshipArg</span><span class="p">(</span><span class="s2">&quot;secondaryjoin&quot;</span><span class="p">,</span> <span class="n">secondaryjoin</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="419">            <span class="n">_RelationshipArg</span><span class="p">(</span><span class="s2">&quot;order_by&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="420">            <span class="n">_RelationshipArg</span><span class="p">(</span><span class="s2">&quot;foreign_keys&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="421">            <span class="n">_RelationshipArg</span><span class="p">(</span><span class="s2">&quot;remote_side&quot;</span><span class="p">,</span> <span class="n">remote_side</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="422">        <span class="p">)</span>
</span><span data-line="423">
</span><span data-line="424">        <span class="bp">self</span><span class="o">.</span><span class="n">post_update</span> <span class="o">=</span> <span class="n">post_update</span>
</span><span data-line="425">        <span class="bp">self</span><span class="o">.</span><span class="n">viewonly</span> <span class="o">=</span> <span class="n">viewonly</span>
</span><span data-line="426">        <span class="k">if</span> <span class="n">viewonly</span><span class="p">:</span>
</span><span data-line="427">            <span class="bp">self</span><span class="o">.</span><span class="n">_warn_for_persistence_only_flags</span><span class="p">(</span>
</span><span data-line="428">                <span class="n">passive_deletes</span><span class="o">=</span><span class="n">passive_deletes</span><span class="p">,</span>
</span><span data-line="429">                <span class="n">passive_updates</span><span class="o">=</span><span class="n">passive_updates</span><span class="p">,</span>
</span><span data-line="430">                <span class="n">enable_typechecks</span><span class="o">=</span><span class="n">enable_typechecks</span><span class="p">,</span>
</span><span data-line="431">                <span class="n">active_history</span><span class="o">=</span><span class="n">active_history</span><span class="p">,</span>
</span><span data-line="432">                <span class="n">cascade_backrefs</span><span class="o">=</span><span class="n">cascade_backrefs</span><span class="p">,</span>
</span><span data-line="433">            <span class="p">)</span>
</span><span data-line="434">        <span class="k">if</span> <span class="n">viewonly</span> <span class="ow">and</span> <span class="n">sync_backref</span><span class="p">:</span>
</span><span data-line="435">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="436">                <span class="s2">&quot;sync_backref and viewonly cannot both be True&quot;</span>
</span><span data-line="437">            <span class="p">)</span>
</span><span data-line="438">        <span class="bp">self</span><span class="o">.</span><span class="n">sync_backref</span> <span class="o">=</span> <span class="n">sync_backref</span>
</span><span data-line="439">        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="n">lazy</span>
</span><span data-line="440">        <span class="bp">self</span><span class="o">.</span><span class="n">single_parent</span> <span class="o">=</span> <span class="n">single_parent</span>
</span><span data-line="441">        <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="o">=</span> <span class="n">collection_class</span>
</span><span data-line="442">        <span class="bp">self</span><span class="o">.</span><span class="n">passive_deletes</span> <span class="o">=</span> <span class="n">passive_deletes</span>
</span><span data-line="443">
</span><span data-line="444">        <span class="k">if</span> <span class="n">cascade_backrefs</span><span class="p">:</span>
</span><span data-line="445">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="446">                <span class="s2">&quot;The &#39;cascade_backrefs&#39; parameter passed to &quot;</span>
</span><span data-line="447">                <span class="s2">&quot;relationship() may only be set to False.&quot;</span>
</span><span data-line="448">            <span class="p">)</span>
</span><span data-line="449">
</span><span data-line="450">        <span class="bp">self</span><span class="o">.</span><span class="n">passive_updates</span> <span class="o">=</span> <span class="n">passive_updates</span>
</span><span data-line="451">        <span class="bp">self</span><span class="o">.</span><span class="n">enable_typechecks</span> <span class="o">=</span> <span class="n">enable_typechecks</span>
</span><span data-line="452">        <span class="bp">self</span><span class="o">.</span><span class="n">query_class</span> <span class="o">=</span> <span class="n">query_class</span>
</span><span data-line="453">        <span class="bp">self</span><span class="o">.</span><span class="n">innerjoin</span> <span class="o">=</span> <span class="n">innerjoin</span>
</span><span data-line="454">        <span class="bp">self</span><span class="o">.</span><span class="n">distinct_target_key</span> <span class="o">=</span> <span class="n">distinct_target_key</span>
</span><span data-line="455">        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span>
</span><span data-line="456">        <span class="bp">self</span><span class="o">.</span><span class="n">active_history</span> <span class="o">=</span> <span class="n">active_history</span>
</span><span data-line="457">        <span class="bp">self</span><span class="o">.</span><span class="n">_legacy_inactive_history_style</span> <span class="o">=</span> <span class="n">_legacy_inactive_history_style</span>
</span><span data-line="458">
</span><span data-line="459">        <span class="bp">self</span><span class="o">.</span><span class="n">join_depth</span> <span class="o">=</span> <span class="n">join_depth</span>
</span><span data-line="460">        <span class="k">if</span> <span class="n">omit_join</span><span class="p">:</span>
</span><span data-line="461">            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="462">                <span class="s2">&quot;setting omit_join to True is not supported; selectin &quot;</span>
</span><span data-line="463">                <span class="s2">&quot;loading of this relationship may not work correctly if this &quot;</span>
</span><span data-line="464">                <span class="s2">&quot;flag is set explicitly.  omit_join optimization is &quot;</span>
</span><span data-line="465">                <span class="s2">&quot;automatically detected for conditions under which it is &quot;</span>
</span><span data-line="466">                <span class="s2">&quot;supported.&quot;</span>
</span><span data-line="467">            <span class="p">)</span>
</span><span data-line="468">
</span><span data-line="469">        <span class="bp">self</span><span class="o">.</span><span class="n">omit_join</span> <span class="o">=</span> <span class="n">omit_join</span>
</span><span data-line="470">        <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span> <span class="o">=</span> <span class="n">_local_remote_pairs</span>
</span><span data-line="471">        <span class="bp">self</span><span class="o">.</span><span class="n">load_on_pending</span> <span class="o">=</span> <span class="n">load_on_pending</span>
</span><span data-line="472">        <span class="bp">self</span><span class="o">.</span><span class="n">comparator_factory</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="473">            <span class="n">comparator_factory</span> <span class="ow">or</span> <span class="n">RelationshipProperty</span><span class="o">.</span><span class="n">Comparator</span>
</span><span data-line="474">        <span class="p">)</span>
</span><span data-line="475">        <span class="n">util</span><span class="o">.</span><span class="n">set_creation_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="476">
</span><span data-line="477">        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="478">            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span data-line="479">
</span><span data-line="480">        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_key</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;lazy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">),)</span>
</span><span data-line="481">
</span><span data-line="482">        <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_property</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="483">
</span><span data-line="484">        <span class="k">if</span> <span class="n">overlaps</span><span class="p">:</span>
</span><span data-line="485">            <span class="bp">self</span><span class="o">.</span><span class="n">_overlaps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*,\s*&quot;</span><span class="p">,</span> <span class="n">overlaps</span><span class="p">))</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span data-line="486">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="487">            <span class="bp">self</span><span class="o">.</span><span class="n">_overlaps</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="488">
</span><span data-line="489">        <span class="bp">self</span><span class="o">.</span><span class="n">cascade</span> <span class="o">=</span> <span class="n">cascade</span>
</span><span data-line="490">
</span><span data-line="491">        <span class="bp">self</span><span class="o">.</span><span class="n">back_populates</span> <span class="o">=</span> <span class="n">back_populates</span>
</span><span data-line="492">
</span><span data-line="493">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_populates</span><span class="p">:</span>
</span><span data-line="494">            <span class="k">if</span> <span class="n">backref</span><span class="p">:</span>
</span><span data-line="495">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="496">                    <span class="s2">&quot;backref and back_populates keyword arguments &quot;</span>
</span><span data-line="497">                    <span class="s2">&quot;are mutually exclusive&quot;</span>
</span><span data-line="498">                <span class="p">)</span>
</span><span data-line="499">            <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="500">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="501">            <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="o">=</span> <span class="n">backref</span>
</span><span data-line="502">
</span><span data-line="503">    <span class="k">def</span><span class="w"> </span><span class="nf">_warn_for_persistence_only_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="504">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="505">            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistence_only</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
</span><span data-line="506">                <span class="c1"># we are warning here rather than warn deprecated as this is a</span>
</span><span data-line="507">                <span class="c1"># configuration mistake, and Python shows regular warnings more</span>
</span><span data-line="508">                <span class="c1"># aggressively than deprecation warnings by default. Unlike the</span>
</span><span data-line="509">                <span class="c1"># case of setting viewonly with cascade, the settings being</span>
</span><span data-line="510">                <span class="c1"># warned about here are not actively doing the wrong thing</span>
</span><span data-line="511">                <span class="c1"># against viewonly=True, so it is not as urgent to have these</span>
</span><span data-line="512">                <span class="c1"># raise an error.</span>
</span><span data-line="513">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="514">                    <span class="s2">&quot;Setting </span><span class="si">%s</span><span class="s2"> on relationship() while also &quot;</span>
</span><span data-line="515">                    <span class="s2">&quot;setting viewonly=True does not make sense, as a &quot;</span>
</span><span data-line="516">                    <span class="s2">&quot;viewonly=True relationship does not perform persistence &quot;</span>
</span><span data-line="517">                    <span class="s2">&quot;operations. This configuration may raise an error &quot;</span>
</span><span data-line="518">                    <span class="s2">&quot;in a future release.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,)</span>
</span><span data-line="519">                <span class="p">)</span>
</span><span data-line="520">
</span><span data-line="521">    <span class="k">def</span><span class="w"> </span><span class="nf">instrument_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="522">        <span class="n">attributes</span><span class="o">.</span><span class="n">register_descriptor</span><span class="p">(</span>
</span><span data-line="523">            <span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="524">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="525">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">),</span>
</span><span data-line="526">            <span class="n">parententity</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
</span><span data-line="527">            <span class="n">doc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
</span><span data-line="528">        <span class="p">)</span>
</span><span data-line="529">
</span><span data-line="530">    <span class="k">class</span><span class="w"> </span><span class="nc">Comparator</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="p">,</span> <span class="n">PropComparator</span><span class="p">[</span><span class="n">_PT</span><span class="p">]):</span>
</span><span data-line="531"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce boolean, comparison, and other operators for</span>
</span><span data-line="532"><span class="sd">        :class:`.RelationshipProperty` attributes.</span>
</span><span data-line="533">
</span><span data-line="534"><span class="sd">        See the documentation for :class:`.PropComparator` for a brief</span>
</span><span data-line="535"><span class="sd">        overview of ORM level operator definition.</span>
</span><span data-line="536">
</span><span data-line="537"><span class="sd">        .. seealso::</span>
</span><span data-line="538">
</span><span data-line="539"><span class="sd">            :class:`.PropComparator`</span>
</span><span data-line="540">
</span><span data-line="541"><span class="sd">            :class:`.ColumnProperty.Comparator`</span>
</span><span data-line="542">
</span><span data-line="543"><span class="sd">            :class:`.ColumnOperators`</span>
</span><span data-line="544">
</span><span data-line="545"><span class="sd">            :ref:`types_operators`</span>
</span><span data-line="546">
</span><span data-line="547"><span class="sd">            :attr:`.TypeEngine.comparator_factory`</span>
</span><span data-line="548">
</span><span data-line="549"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="550">
</span><span data-line="551">        <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="552">            <span class="s2">&quot;entity&quot;</span><span class="p">,</span>
</span><span data-line="553">            <span class="s2">&quot;mapper&quot;</span><span class="p">,</span>
</span><span data-line="554">            <span class="s2">&quot;property&quot;</span><span class="p">,</span>
</span><span data-line="555">            <span class="s2">&quot;_of_type&quot;</span><span class="p">,</span>
</span><span data-line="556">            <span class="s2">&quot;_extra_criteria&quot;</span><span class="p">,</span>
</span><span data-line="557">        <span class="p">)</span>
</span><span data-line="558">
</span><span data-line="559">        <span class="n">prop</span><span class="p">:</span> <span class="n">RODescriptorReference</span><span class="p">[</span><span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">_PT</span><span class="p">]]</span>
</span><span data-line="560">        <span class="n">_of_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EntityType</span><span class="p">[</span><span class="n">_PT</span><span class="p">]]</span>
</span><span data-line="561">
</span><span data-line="562">        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="563">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="564">            <span class="n">prop</span><span class="p">:</span> <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">_PT</span><span class="p">],</span>
</span><span data-line="565">            <span class="n">parentmapper</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="566">            <span class="n">adapt_to_entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AliasedInsp</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="567">            <span class="n">of_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EntityType</span><span class="p">[</span><span class="n">_PT</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="568">            <span class="n">extra_criteria</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
</span><span data-line="569">        <span class="p">):</span>
</span><span data-line="570"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Construction of :class:`.RelationshipProperty.Comparator`</span>
</span><span data-line="571"><span class="sd">            is internal to the ORM&#39;s attribute mechanics.</span>
</span><span data-line="572">
</span><span data-line="573"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="574">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>
</span><span data-line="575">            <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span> <span class="o">=</span> <span class="n">parentmapper</span>
</span><span data-line="576">            <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span> <span class="o">=</span> <span class="n">adapt_to_entity</span>
</span><span data-line="577">            <span class="k">if</span> <span class="n">of_type</span><span class="p">:</span>
</span><span data-line="578">                <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span> <span class="o">=</span> <span class="n">of_type</span>
</span><span data-line="579">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="580">                <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="581">            <span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span> <span class="o">=</span> <span class="n">extra_criteria</span>
</span><span data-line="582">
</span><span data-line="583">        <span class="k">def</span><span class="w"> </span><span class="nf">adapt_to_entity</span><span class="p">(</span>
</span><span data-line="584">            <span class="bp">self</span><span class="p">,</span> <span class="n">adapt_to_entity</span><span class="p">:</span> <span class="n">AliasedInsp</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="585">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RelationshipProperty</span><span class="o">.</span><span class="n">Comparator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="586">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span data-line="587">                <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="588">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="589">                <span class="n">adapt_to_entity</span><span class="o">=</span><span class="n">adapt_to_entity</span><span class="p">,</span>
</span><span data-line="590">                <span class="n">of_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">,</span>
</span><span data-line="591">            <span class="p">)</span>
</span><span data-line="592">
</span><span data-line="593">        <span class="n">entity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_PT</span><span class="p">]</span>
</span><span data-line="594"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The target entity referred to by this</span>
</span><span data-line="595"><span class="sd">        :class:`.RelationshipProperty.Comparator`.</span>
</span><span data-line="596">
</span><span data-line="597"><span class="sd">        This is either a :class:`_orm.Mapper` or :class:`.AliasedInsp`</span>
</span><span data-line="598"><span class="sd">        object.</span>
</span><span data-line="599">
</span><span data-line="600"><span class="sd">        This is the &quot;target&quot; or &quot;remote&quot; side of the</span>
</span><span data-line="601"><span class="sd">        :func:`_orm.relationship`.</span>
</span><span data-line="602">
</span><span data-line="603"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="604">
</span><span data-line="605">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_PT</span><span class="p">]</span>
</span><span data-line="606"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The target :class:`_orm.Mapper` referred to by this</span>
</span><span data-line="607"><span class="sd">        :class:`.RelationshipProperty.Comparator`.</span>
</span><span data-line="608">
</span><span data-line="609"><span class="sd">        This is the &quot;target&quot; or &quot;remote&quot; side of the</span>
</span><span data-line="610"><span class="sd">        :func:`_orm.relationship`.</span>
</span><span data-line="611">
</span><span data-line="612"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="613">
</span><span data-line="614">        <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_PT</span><span class="p">]:</span>
</span><span data-line="615">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">:</span>
</span><span data-line="616">                <span class="k">return</span> <span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span data-line="617">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="618">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">entity</span>
</span><span data-line="619">
</span><span data-line="620">        <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_PT</span><span class="p">]:</span>
</span><span data-line="621">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="622">
</span><span data-line="623">        <span class="k">def</span><span class="w"> </span><span class="nf">_source_selectable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FromClause</span><span class="p">:</span>
</span><span data-line="624">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="p">:</span>
</span><span data-line="625">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="o">.</span><span class="n">selectable</span>
</span><span data-line="626">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="627">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_with_polymorphic_selectable</span>
</span><span data-line="628">
</span><span data-line="629">        <span class="k">def</span><span class="w"> </span><span class="nf">__clause_element__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="630">            <span class="n">adapt_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_selectable</span><span class="p">()</span>
</span><span data-line="631">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">:</span>
</span><span data-line="632">                <span class="n">of_type_entity</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">)</span>
</span><span data-line="633">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="634">                <span class="n">of_type_entity</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="635">
</span><span data-line="636">            <span class="p">(</span>
</span><span data-line="637">                <span class="n">pj</span><span class="p">,</span>
</span><span data-line="638">                <span class="n">sj</span><span class="p">,</span>
</span><span data-line="639">                <span class="n">source</span><span class="p">,</span>
</span><span data-line="640">                <span class="n">dest</span><span class="p">,</span>
</span><span data-line="641">                <span class="n">secondary</span><span class="p">,</span>
</span><span data-line="642">                <span class="n">target_adapter</span><span class="p">,</span>
</span><span data-line="643">            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">_create_joins</span><span class="p">(</span>
</span><span data-line="644">                <span class="n">source_selectable</span><span class="o">=</span><span class="n">adapt_from</span><span class="p">,</span>
</span><span data-line="645">                <span class="n">source_polymorphic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="646">                <span class="n">of_type_entity</span><span class="o">=</span><span class="n">of_type_entity</span><span class="p">,</span>
</span><span data-line="647">                <span class="n">alias_secondary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="648">                <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span><span class="p">,</span>
</span><span data-line="649">            <span class="p">)</span>
</span><span data-line="650">            <span class="k">if</span> <span class="n">sj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="651">                <span class="k">return</span> <span class="n">pj</span> <span class="o">&amp;</span> <span class="n">sj</span>
</span><span data-line="652">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="653">                <span class="k">return</span> <span class="n">pj</span>
</span><span data-line="654">
</span><span data-line="655">        <span class="k">def</span><span class="w"> </span><span class="nf">of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">_EntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">PropComparator</span><span class="p">[</span><span class="n">_PT</span><span class="p">]:</span>
</span><span data-line="656"><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Redefine this object in terms of a polymorphic subclass.</span>
</span><span data-line="657">
</span><span data-line="658"><span class="sd">            See :meth:`.PropComparator.of_type` for an example.</span>
</span><span data-line="659">
</span><span data-line="660">
</span><span data-line="661"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="662">            <span class="k">return</span> <span class="n">RelationshipProperty</span><span class="o">.</span><span class="n">Comparator</span><span class="p">(</span>
</span><span data-line="663">                <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="664">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="665">                <span class="n">adapt_to_entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="p">,</span>
</span><span data-line="666">                <span class="n">of_type</span><span class="o">=</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="667">                <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span><span class="p">,</span>
</span><span data-line="668">            <span class="p">)</span>
</span><span data-line="669">
</span><span data-line="670">        <span class="k">def</span><span class="w"> </span><span class="nf">and_</span><span class="p">(</span>
</span><span data-line="671">            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">:</span> <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
</span><span data-line="672">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropComparator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="673"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Add AND criteria.</span>
</span><span data-line="674">
</span><span data-line="675"><span class="sd">            See :meth:`.PropComparator.and_` for an example.</span>
</span><span data-line="676">
</span><span data-line="677"><span class="sd">            .. versionadded:: 1.4</span>
</span><span data-line="678">
</span><span data-line="679"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="680">            <span class="n">exprs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span data-line="681">                <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">WhereHavingRole</span><span class="p">,</span> <span class="n">clause</span><span class="p">)</span>
</span><span data-line="682">                <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">coerce_generator_arg</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
</span><span data-line="683">            <span class="p">)</span>
</span><span data-line="684">
</span><span data-line="685">            <span class="k">return</span> <span class="n">RelationshipProperty</span><span class="o">.</span><span class="n">Comparator</span><span class="p">(</span>
</span><span data-line="686">                <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="687">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="688">                <span class="n">adapt_to_entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="p">,</span>
</span><span data-line="689">                <span class="n">of_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">,</span>
</span><span data-line="690">                <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span> <span class="o">+</span> <span class="n">exprs</span><span class="p">,</span>
</span><span data-line="691">            <span class="p">)</span>
</span><span data-line="692">
</span><span data-line="693">        <span class="k">def</span><span class="w"> </span><span class="nf">in_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="694"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Produce an IN clause - this is not implemented</span>
</span><span data-line="695"><span class="sd">            for :func:`_orm.relationship`-based attributes at this time.</span>
</span><span data-line="696">
</span><span data-line="697"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="698">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span data-line="699">                <span class="s2">&quot;in_() not yet supported for &quot;</span>
</span><span data-line="700">                <span class="s2">&quot;relationships.  For a simple &quot;</span>
</span><span data-line="701">                <span class="s2">&quot;many-to-one, use in_() against &quot;</span>
</span><span data-line="702">                <span class="s2">&quot;the set of foreign key values.&quot;</span>
</span><span data-line="703">            <span class="p">)</span>
</span><span data-line="704">
</span><span data-line="705">        <span class="c1"># https://github.com/python/mypy/issues/4266</span>
</span><span data-line="706">        <span class="fm">__hash__</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
</span><span data-line="707">
</span><span data-line="708">        <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]  # noqa: E501</span>
</span><span data-line="709"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Implement the ``==`` operator.</span>
</span><span data-line="710">
</span><span data-line="711"><span class="sd">            In a many-to-one context, such as:</span>
</span><span data-line="712">
</span><span data-line="713"><span class="sd">            .. sourcecode:: text</span>
</span><span data-line="714">
</span><span data-line="715"><span class="sd">              MyClass.some_prop == &lt;some object&gt;</span>
</span><span data-line="716">
</span><span data-line="717"><span class="sd">            this will typically produce a</span>
</span><span data-line="718"><span class="sd">            clause such as:</span>
</span><span data-line="719">
</span><span data-line="720"><span class="sd">            .. sourcecode:: text</span>
</span><span data-line="721">
</span><span data-line="722"><span class="sd">              mytable.related_id == &lt;some id&gt;</span>
</span><span data-line="723">
</span><span data-line="724"><span class="sd">            Where ``&lt;some id&gt;`` is the primary key of the given</span>
</span><span data-line="725"><span class="sd">            object.</span>
</span><span data-line="726">
</span><span data-line="727"><span class="sd">            The ``==`` operator provides partial functionality for non-</span>
</span><span data-line="728"><span class="sd">            many-to-one comparisons:</span>
</span><span data-line="729">
</span><span data-line="730"><span class="sd">            * Comparisons against collections are not supported.</span>
</span><span data-line="731"><span class="sd">              Use :meth:`~.Relationship.Comparator.contains`.</span>
</span><span data-line="732"><span class="sd">            * Compared to a scalar one-to-many, will produce a</span>
</span><span data-line="733"><span class="sd">              clause that compares the target columns in the parent to</span>
</span><span data-line="734"><span class="sd">              the given target.</span>
</span><span data-line="735"><span class="sd">            * Compared to a scalar many-to-many, an alias</span>
</span><span data-line="736"><span class="sd">              of the association table will be rendered as</span>
</span><span data-line="737"><span class="sd">              well, forming a natural join that is part of the</span>
</span><span data-line="738"><span class="sd">              main body of the query. This will not work for</span>
</span><span data-line="739"><span class="sd">              queries that go beyond simple AND conjunctions of</span>
</span><span data-line="740"><span class="sd">              comparisons, such as those which use OR. Use</span>
</span><span data-line="741"><span class="sd">              explicit joins, outerjoins, or</span>
</span><span data-line="742"><span class="sd">              :meth:`~.Relationship.Comparator.has` for</span>
</span><span data-line="743"><span class="sd">              more comprehensive non-many-to-one scalar</span>
</span><span data-line="744"><span class="sd">              membership tests.</span>
</span><span data-line="745"><span class="sd">            * Comparisons against ``None`` given in a one-to-many</span>
</span><span data-line="746"><span class="sd">              or many-to-many context produce a NOT EXISTS clause.</span>
</span><span data-line="747">
</span><span data-line="748"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="749">            <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">Null</span><span class="p">):</span>
</span><span data-line="750">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ONETOMANY</span><span class="p">,</span> <span class="n">MANYTOMANY</span><span class="p">]:</span>
</span><span data-line="751">                    <span class="k">return</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">()</span>
</span><span data-line="752">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="753">                    <span class="k">return</span> <span class="n">_orm_annotate</span><span class="p">(</span>
</span><span data-line="754">                        <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">_optimized_compare</span><span class="p">(</span>
</span><span data-line="755">                            <span class="kc">None</span><span class="p">,</span> <span class="n">adapt_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adapter</span>
</span><span data-line="756">                        <span class="p">)</span>
</span><span data-line="757">                    <span class="p">)</span>
</span><span data-line="758">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
</span><span data-line="759">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="760">                    <span class="s2">&quot;Can&#39;t compare a collection to an object or collection; &quot;</span>
</span><span data-line="761">                    <span class="s2">&quot;use contains() to test for membership.&quot;</span>
</span><span data-line="762">                <span class="p">)</span>
</span><span data-line="763">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="764">                <span class="k">return</span> <span class="n">_orm_annotate</span><span class="p">(</span>
</span><span data-line="765">                    <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">_optimized_compare</span><span class="p">(</span>
</span><span data-line="766">                        <span class="n">other</span><span class="p">,</span> <span class="n">adapt_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adapter</span>
</span><span data-line="767">                    <span class="p">)</span>
</span><span data-line="768">                <span class="p">)</span>
</span><span data-line="769">
</span><span data-line="770">        <span class="k">def</span><span class="w"> </span><span class="nf">_criterion_exists</span><span class="p">(</span>
</span><span data-line="771">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="772">            <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="773">            <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="774">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Exists</span><span class="p">:</span>
</span><span data-line="775">            <span class="n">where_criteria</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="776">                <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">WhereHavingRole</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>
</span><span data-line="777">                <span class="k">if</span> <span class="n">criterion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="778">                <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="779">            <span class="p">)</span>
</span><span data-line="780">
</span><span data-line="781">            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_of_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span><span data-line="782">                <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span>
</span><span data-line="783">                    <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span>
</span><span data-line="784">                <span class="p">)</span>
</span><span data-line="785">                <span class="k">assert</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="786">                <span class="n">target_mapper</span><span class="p">,</span> <span class="n">to_selectable</span><span class="p">,</span> <span class="n">is_aliased_class</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="787">                    <span class="n">info</span><span class="o">.</span><span class="n">mapper</span><span class="p">,</span>
</span><span data-line="788">                    <span class="n">info</span><span class="o">.</span><span class="n">selectable</span><span class="p">,</span>
</span><span data-line="789">                    <span class="n">info</span><span class="o">.</span><span class="n">is_aliased_class</span><span class="p">,</span>
</span><span data-line="790">                <span class="p">)</span>
</span><span data-line="791">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">_is_self_referential</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_aliased_class</span><span class="p">:</span>
</span><span data-line="792">                    <span class="n">to_selectable</span> <span class="o">=</span> <span class="n">to_selectable</span><span class="o">.</span><span class="n">_anonymous_fromclause</span><span class="p">()</span>
</span><span data-line="793">
</span><span data-line="794">                <span class="n">single_crit</span> <span class="o">=</span> <span class="n">target_mapper</span><span class="o">.</span><span class="n">_single_table_criterion</span>
</span><span data-line="795">                <span class="k">if</span> <span class="n">single_crit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="796">                    <span class="k">if</span> <span class="n">where_criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="797">                        <span class="n">where_criteria</span> <span class="o">=</span> <span class="n">single_crit</span> <span class="o">&amp;</span> <span class="n">where_criteria</span>
</span><span data-line="798">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="799">                        <span class="n">where_criteria</span> <span class="o">=</span> <span class="n">single_crit</span>
</span><span data-line="800">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="801">                <span class="n">is_aliased_class</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="802">                <span class="n">to_selectable</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="803">
</span><span data-line="804">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="p">:</span>
</span><span data-line="805">                <span class="n">source_selectable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_selectable</span><span class="p">()</span>
</span><span data-line="806">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="807">                <span class="n">source_selectable</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="808">
</span><span data-line="809">            <span class="p">(</span>
</span><span data-line="810">                <span class="n">pj</span><span class="p">,</span>
</span><span data-line="811">                <span class="n">sj</span><span class="p">,</span>
</span><span data-line="812">                <span class="n">source</span><span class="p">,</span>
</span><span data-line="813">                <span class="n">dest</span><span class="p">,</span>
</span><span data-line="814">                <span class="n">secondary</span><span class="p">,</span>
</span><span data-line="815">                <span class="n">target_adapter</span><span class="p">,</span>
</span><span data-line="816">            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">_create_joins</span><span class="p">(</span>
</span><span data-line="817">                <span class="n">dest_selectable</span><span class="o">=</span><span class="n">to_selectable</span><span class="p">,</span>
</span><span data-line="818">                <span class="n">source_selectable</span><span class="o">=</span><span class="n">source_selectable</span><span class="p">,</span>
</span><span data-line="819">            <span class="p">)</span>
</span><span data-line="820">
</span><span data-line="821">            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span data-line="822">                <span class="n">crit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span data-line="823">                <span class="k">if</span> <span class="n">where_criteria</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="824">                    <span class="n">where_criteria</span> <span class="o">=</span> <span class="n">crit</span>
</span><span data-line="825">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="826">                    <span class="n">where_criteria</span> <span class="o">=</span> <span class="n">where_criteria</span> <span class="o">&amp;</span> <span class="n">crit</span>
</span><span data-line="827">
</span><span data-line="828">            <span class="c1"># annotate the *local* side of the join condition, in the case</span>
</span><span data-line="829">            <span class="c1"># of pj + sj this is the full primaryjoin, in the case of just</span>
</span><span data-line="830">            <span class="c1"># pj its the local side of the primaryjoin.</span>
</span><span data-line="831">            <span class="k">if</span> <span class="n">sj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="832">                <span class="n">j</span> <span class="o">=</span> <span class="n">_orm_annotate</span><span class="p">(</span><span class="n">pj</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sj</span>
</span><span data-line="833">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="834">                <span class="n">j</span> <span class="o">=</span> <span class="n">_orm_annotate</span><span class="p">(</span><span class="n">pj</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">remote_side</span><span class="p">)</span>
</span><span data-line="835">
</span><span data-line="836">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="837">                <span class="n">where_criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="838">                <span class="ow">and</span> <span class="n">target_adapter</span>
</span><span data-line="839">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_aliased_class</span>
</span><span data-line="840">            <span class="p">):</span>
</span><span data-line="841">                <span class="c1"># limit this adapter to annotated only?</span>
</span><span data-line="842">                <span class="n">where_criteria</span> <span class="o">=</span> <span class="n">target_adapter</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">where_criteria</span><span class="p">)</span>
</span><span data-line="843">
</span><span data-line="844">            <span class="c1"># only have the &quot;joined left side&quot; of what we</span>
</span><span data-line="845">            <span class="c1"># return be subject to Query adaption.  The right</span>
</span><span data-line="846">            <span class="c1"># side of it is used for an exists() subquery and</span>
</span><span data-line="847">            <span class="c1"># should not correlate or otherwise reach out</span>
</span><span data-line="848">            <span class="c1"># to anything in the enclosing query.</span>
</span><span data-line="849">            <span class="k">if</span> <span class="n">where_criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="850">                <span class="n">where_criteria</span> <span class="o">=</span> <span class="n">where_criteria</span><span class="o">.</span><span class="n">_annotate</span><span class="p">(</span>
</span><span data-line="851">                    <span class="p">{</span><span class="s2">&quot;no_replacement_traverse&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span data-line="852">                <span class="p">)</span>
</span><span data-line="853">
</span><span data-line="854">            <span class="n">crit</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&amp;</span> <span class="n">sql</span><span class="o">.</span><span class="n">True_</span><span class="o">.</span><span class="n">_ifnone</span><span class="p">(</span><span class="n">where_criteria</span><span class="p">)</span>
</span><span data-line="855">
</span><span data-line="856">            <span class="k">if</span> <span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="857">                <span class="n">ex</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="858">                    <span class="n">sql</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="859">                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">crit</span><span class="p">)</span>
</span><span data-line="860">                    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">secondary</span><span class="p">)</span>
</span><span data-line="861">                    <span class="o">.</span><span class="n">correlate_except</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">secondary</span><span class="p">)</span>
</span><span data-line="862">                <span class="p">)</span>
</span><span data-line="863">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="864">                <span class="n">ex</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="865">                    <span class="n">sql</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="866">                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">crit</span><span class="p">)</span>
</span><span data-line="867">                    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</span><span data-line="868">                    <span class="o">.</span><span class="n">correlate_except</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</span><span data-line="869">                <span class="p">)</span>
</span><span data-line="870">            <span class="k">return</span> <span class="n">ex</span>
</span><span data-line="871">
</span><span data-line="872">        <span class="k">def</span><span class="w"> </span><span class="nf">any</span><span class="p">(</span>
</span><span data-line="873">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="874">            <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="875">            <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="876">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="877"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Produce an expression that tests a collection against</span>
</span><span data-line="878"><span class="sd">            particular criterion, using EXISTS.</span>
</span><span data-line="879">
</span><span data-line="880"><span class="sd">            An expression like::</span>
</span><span data-line="881">
</span><span data-line="882"><span class="sd">                session.query(MyClass).filter(</span>
</span><span data-line="883"><span class="sd">                    MyClass.somereference.any(SomeRelated.x == 2)</span>
</span><span data-line="884"><span class="sd">                )</span>
</span><span data-line="885">
</span><span data-line="886"><span class="sd">            Will produce a query like:</span>
</span><span data-line="887">
</span><span data-line="888"><span class="sd">            .. sourcecode:: sql</span>
</span><span data-line="889">
</span><span data-line="890"><span class="sd">                SELECT * FROM my_table WHERE</span>
</span><span data-line="891"><span class="sd">                EXISTS (SELECT 1 FROM related WHERE related.my_id=my_table.id</span>
</span><span data-line="892"><span class="sd">                AND related.x=2)</span>
</span><span data-line="893">
</span><span data-line="894"><span class="sd">            Because :meth:`~.Relationship.Comparator.any` uses</span>
</span><span data-line="895"><span class="sd">            a correlated subquery, its performance is not nearly as</span>
</span><span data-line="896"><span class="sd">            good when compared against large target tables as that of</span>
</span><span data-line="897"><span class="sd">            using a join.</span>
</span><span data-line="898">
</span><span data-line="899"><span class="sd">            :meth:`~.Relationship.Comparator.any` is particularly</span>
</span><span data-line="900"><span class="sd">            useful for testing for empty collections::</span>
</span><span data-line="901">
</span><span data-line="902"><span class="sd">                session.query(MyClass).filter(~MyClass.somereference.any())</span>
</span><span data-line="903">
</span><span data-line="904"><span class="sd">            will produce:</span>
</span><span data-line="905">
</span><span data-line="906"><span class="sd">            .. sourcecode:: sql</span>
</span><span data-line="907">
</span><span data-line="908"><span class="sd">                SELECT * FROM my_table WHERE</span>
</span><span data-line="909"><span class="sd">                NOT (EXISTS (SELECT 1 FROM related WHERE</span>
</span><span data-line="910"><span class="sd">                related.my_id=my_table.id))</span>
</span><span data-line="911">
</span><span data-line="912"><span class="sd">            :meth:`~.Relationship.Comparator.any` is only</span>
</span><span data-line="913"><span class="sd">            valid for collections, i.e. a :func:`_orm.relationship`</span>
</span><span data-line="914"><span class="sd">            that has ``uselist=True``.  For scalar references,</span>
</span><span data-line="915"><span class="sd">            use :meth:`~.Relationship.Comparator.has`.</span>
</span><span data-line="916">
</span><span data-line="917"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="918">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
</span><span data-line="919">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="920">                    <span class="s2">&quot;&#39;any()&#39; not implemented for scalar &quot;</span>
</span><span data-line="921">                    <span class="s2">&quot;attributes. Use has().&quot;</span>
</span><span data-line="922">                <span class="p">)</span>
</span><span data-line="923">
</span><span data-line="924">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="925">
</span><span data-line="926">        <span class="k">def</span><span class="w"> </span><span class="nf">has</span><span class="p">(</span>
</span><span data-line="927">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="928">            <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="929">            <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="930">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="931"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Produce an expression that tests a scalar reference against</span>
</span><span data-line="932"><span class="sd">            particular criterion, using EXISTS.</span>
</span><span data-line="933">
</span><span data-line="934"><span class="sd">            An expression like::</span>
</span><span data-line="935">
</span><span data-line="936"><span class="sd">                session.query(MyClass).filter(</span>
</span><span data-line="937"><span class="sd">                    MyClass.somereference.has(SomeRelated.x == 2)</span>
</span><span data-line="938"><span class="sd">                )</span>
</span><span data-line="939">
</span><span data-line="940"><span class="sd">            Will produce a query like:</span>
</span><span data-line="941">
</span><span data-line="942"><span class="sd">            .. sourcecode:: sql</span>
</span><span data-line="943">
</span><span data-line="944"><span class="sd">                SELECT * FROM my_table WHERE</span>
</span><span data-line="945"><span class="sd">                EXISTS (SELECT 1 FROM related WHERE</span>
</span><span data-line="946"><span class="sd">                related.id==my_table.related_id AND related.x=2)</span>
</span><span data-line="947">
</span><span data-line="948"><span class="sd">            Because :meth:`~.Relationship.Comparator.has` uses</span>
</span><span data-line="949"><span class="sd">            a correlated subquery, its performance is not nearly as</span>
</span><span data-line="950"><span class="sd">            good when compared against large target tables as that of</span>
</span><span data-line="951"><span class="sd">            using a join.</span>
</span><span data-line="952">
</span><span data-line="953"><span class="sd">            :meth:`~.Relationship.Comparator.has` is only</span>
</span><span data-line="954"><span class="sd">            valid for scalar references, i.e. a :func:`_orm.relationship`</span>
</span><span data-line="955"><span class="sd">            that has ``uselist=False``.  For collection references,</span>
</span><span data-line="956"><span class="sd">            use :meth:`~.Relationship.Comparator.any`.</span>
</span><span data-line="957">
</span><span data-line="958"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="959">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
</span><span data-line="960">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="961">                    <span class="s2">&quot;&#39;has()&#39; not implemented for collections. Use any().&quot;</span>
</span><span data-line="962">                <span class="p">)</span>
</span><span data-line="963">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="964">
</span><span data-line="965">        <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>
</span><span data-line="966">            <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="967">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="968"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Return a simple expression that tests a collection for</span>
</span><span data-line="969"><span class="sd">            containment of a particular item.</span>
</span><span data-line="970">
</span><span data-line="971"><span class="sd">            :meth:`~.Relationship.Comparator.contains` is</span>
</span><span data-line="972"><span class="sd">            only valid for a collection, i.e. a</span>
</span><span data-line="973"><span class="sd">            :func:`_orm.relationship` that implements</span>
</span><span data-line="974"><span class="sd">            one-to-many or many-to-many with ``uselist=True``.</span>
</span><span data-line="975">
</span><span data-line="976"><span class="sd">            When used in a simple one-to-many context, an</span>
</span><span data-line="977"><span class="sd">            expression like::</span>
</span><span data-line="978">
</span><span data-line="979"><span class="sd">                MyClass.contains(other)</span>
</span><span data-line="980">
</span><span data-line="981"><span class="sd">            Produces a clause like:</span>
</span><span data-line="982">
</span><span data-line="983"><span class="sd">            .. sourcecode:: sql</span>
</span><span data-line="984">
</span><span data-line="985"><span class="sd">                mytable.id == &lt;some id&gt;</span>
</span><span data-line="986">
</span><span data-line="987"><span class="sd">            Where ``&lt;some id&gt;`` is the value of the foreign key</span>
</span><span data-line="988"><span class="sd">            attribute on ``other`` which refers to the primary</span>
</span><span data-line="989"><span class="sd">            key of its parent object. From this it follows that</span>
</span><span data-line="990"><span class="sd">            :meth:`~.Relationship.Comparator.contains` is</span>
</span><span data-line="991"><span class="sd">            very useful when used with simple one-to-many</span>
</span><span data-line="992"><span class="sd">            operations.</span>
</span><span data-line="993">
</span><span data-line="994"><span class="sd">            For many-to-many operations, the behavior of</span>
</span><span data-line="995"><span class="sd">            :meth:`~.Relationship.Comparator.contains`</span>
</span><span data-line="996"><span class="sd">            has more caveats. The association table will be</span>
</span><span data-line="997"><span class="sd">            rendered in the statement, producing an &quot;implicit&quot;</span>
</span><span data-line="998"><span class="sd">            join, that is, includes multiple tables in the FROM</span>
</span><span data-line="999"><span class="sd">            clause which are equated in the WHERE clause::</span>
</span><span data-line="1000">
</span><span data-line="1001"><span class="sd">                query(MyClass).filter(MyClass.contains(other))</span>
</span><span data-line="1002">
</span><span data-line="1003"><span class="sd">            Produces a query like:</span>
</span><span data-line="1004">
</span><span data-line="1005"><span class="sd">            .. sourcecode:: sql</span>
</span><span data-line="1006">
</span><span data-line="1007"><span class="sd">                SELECT * FROM my_table, my_association_table AS</span>
</span><span data-line="1008"><span class="sd">                my_association_table_1 WHERE</span>
</span><span data-line="1009"><span class="sd">                my_table.id = my_association_table_1.parent_id</span>
</span><span data-line="1010"><span class="sd">                AND my_association_table_1.child_id = &lt;some id&gt;</span>
</span><span data-line="1011">
</span><span data-line="1012"><span class="sd">            Where ``&lt;some id&gt;`` would be the primary key of</span>
</span><span data-line="1013"><span class="sd">            ``other``. From the above, it is clear that</span>
</span><span data-line="1014"><span class="sd">            :meth:`~.Relationship.Comparator.contains`</span>
</span><span data-line="1015"><span class="sd">            will **not** work with many-to-many collections when</span>
</span><span data-line="1016"><span class="sd">            used in queries that move beyond simple AND</span>
</span><span data-line="1017"><span class="sd">            conjunctions, such as multiple</span>
</span><span data-line="1018"><span class="sd">            :meth:`~.Relationship.Comparator.contains`</span>
</span><span data-line="1019"><span class="sd">            expressions joined by OR. In such cases subqueries or</span>
</span><span data-line="1020"><span class="sd">            explicit &quot;outer joins&quot; will need to be used instead.</span>
</span><span data-line="1021"><span class="sd">            See :meth:`~.Relationship.Comparator.any` for</span>
</span><span data-line="1022"><span class="sd">            a less-performant alternative using EXISTS, or refer</span>
</span><span data-line="1023"><span class="sd">            to :meth:`_query.Query.outerjoin`</span>
</span><span data-line="1024"><span class="sd">            as well as :ref:`orm_queryguide_joins`</span>
</span><span data-line="1025"><span class="sd">            for more details on constructing outer joins.</span>
</span><span data-line="1026">
</span><span data-line="1027"><span class="sd">            kwargs may be ignored by this operator but are required for API</span>
</span><span data-line="1028"><span class="sd">            conformance.</span>
</span><span data-line="1029"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="1030">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
</span><span data-line="1031">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1032">                    <span class="s2">&quot;&#39;contains&#39; not implemented for scalar &quot;</span>
</span><span data-line="1033">                    <span class="s2">&quot;attributes.  Use ==&quot;</span>
</span><span data-line="1034">                <span class="p">)</span>
</span><span data-line="1035">
</span><span data-line="1036">            <span class="n">clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">_optimized_compare</span><span class="p">(</span>
</span><span data-line="1037">                <span class="n">other</span><span class="p">,</span> <span class="n">adapt_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adapter</span>
</span><span data-line="1038">            <span class="p">)</span>
</span><span data-line="1039">
</span><span data-line="1040">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1041">                <span class="n">clause</span><span class="o">.</span><span class="n">negation_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__negated_contains_or_equals</span><span class="p">(</span>
</span><span data-line="1042">                    <span class="n">other</span>
</span><span data-line="1043">                <span class="p">)</span>
</span><span data-line="1044">
</span><span data-line="1045">            <span class="k">return</span> <span class="n">clause</span>
</span><span data-line="1046">
</span><span data-line="1047">        <span class="k">def</span><span class="w"> </span><span class="nf">__negated_contains_or_equals</span><span class="p">(</span>
</span><span data-line="1048">            <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="1049">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1050">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">MANYTOONE</span><span class="p">:</span>
</span><span data-line="1051">                <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span data-line="1052">
</span><span data-line="1053">                <span class="k">def</span><span class="w"> </span><span class="nf">state_bindparam</span><span class="p">(</span>
</span><span data-line="1054">                    <span class="n">local_col</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1055">                    <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1056">                    <span class="n">remote_col</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1057">                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BindParameter</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1058">                    <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
</span><span data-line="1059">                    <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span>
</span><span data-line="1060">                        <span class="n">local_col</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="1061">                        <span class="n">type_</span><span class="o">=</span><span class="n">local_col</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
</span><span data-line="1062">                        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1063">                        <span class="n">callable_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">_get_attr_w_warn_on_none</span><span class="p">(</span>
</span><span data-line="1064">                            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">remote_col</span>
</span><span data-line="1065">                        <span class="p">),</span>
</span><span data-line="1066">                    <span class="p">)</span>
</span><span data-line="1067">
</span><span data-line="1068">                <span class="k">def</span><span class="w"> </span><span class="nf">adapt</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="n">_CE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_CE</span><span class="p">:</span>
</span><span data-line="1069">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="p">:</span>
</span><span data-line="1070">                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
</span><span data-line="1071">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1072">                        <span class="k">return</span> <span class="n">col</span>
</span><span data-line="1073">
</span><span data-line="1074">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">_use_get</span><span class="p">:</span>
</span><span data-line="1075">                    <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span>
</span><span data-line="1076">                        <span class="o">*</span><span class="p">[</span>
</span><span data-line="1077">                            <span class="n">sql</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span>
</span><span data-line="1078">                                <span class="n">adapt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="1079">                                <span class="o">!=</span> <span class="n">state_bindparam</span><span class="p">(</span><span class="n">adapt</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span><span data-line="1080">                                <span class="n">adapt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1081">                            <span class="p">)</span>
</span><span data-line="1082">                            <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">local_remote_pairs</span>
</span><span data-line="1083">                        <span class="p">]</span>
</span><span data-line="1084">                    <span class="p">)</span>
</span><span data-line="1085">
</span><span data-line="1086">            <span class="n">criterion</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span>
</span><span data-line="1087">                <span class="o">*</span><span class="p">[</span>
</span><span data-line="1088">                    <span class="n">x</span> <span class="o">==</span> <span class="n">y</span>
</span><span data-line="1089">                    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span data-line="1090">                        <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span>
</span><span data-line="1091">                        <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">primary_key_from_instance</span><span class="p">(</span><span class="n">other</span><span class="p">),</span>
</span><span data-line="1092">                    <span class="p">)</span>
</span><span data-line="1093">                <span class="p">]</span>
</span><span data-line="1094">            <span class="p">)</span>
</span><span data-line="1095">
</span><span data-line="1096">            <span class="k">return</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span>
</span><span data-line="1097">
</span><span data-line="1098">        <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]  # noqa: E501</span>
</span><span data-line="1099"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Implement the ``!=`` operator.</span>
</span><span data-line="1100">
</span><span data-line="1101"><span class="sd">            In a many-to-one context, such as:</span>
</span><span data-line="1102">
</span><span data-line="1103"><span class="sd">            .. sourcecode:: text</span>
</span><span data-line="1104">
</span><span data-line="1105"><span class="sd">              MyClass.some_prop != &lt;some object&gt;</span>
</span><span data-line="1106">
</span><span data-line="1107"><span class="sd">            This will typically produce a clause such as:</span>
</span><span data-line="1108">
</span><span data-line="1109"><span class="sd">            .. sourcecode:: sql</span>
</span><span data-line="1110">
</span><span data-line="1111"><span class="sd">              mytable.related_id != &lt;some id&gt;</span>
</span><span data-line="1112">
</span><span data-line="1113"><span class="sd">            Where ``&lt;some id&gt;`` is the primary key of the</span>
</span><span data-line="1114"><span class="sd">            given object.</span>
</span><span data-line="1115">
</span><span data-line="1116"><span class="sd">            The ``!=`` operator provides partial functionality for non-</span>
</span><span data-line="1117"><span class="sd">            many-to-one comparisons:</span>
</span><span data-line="1118">
</span><span data-line="1119"><span class="sd">            * Comparisons against collections are not supported.</span>
</span><span data-line="1120"><span class="sd">              Use</span>
</span><span data-line="1121"><span class="sd">              :meth:`~.Relationship.Comparator.contains`</span>
</span><span data-line="1122"><span class="sd">              in conjunction with :func:`_expression.not_`.</span>
</span><span data-line="1123"><span class="sd">            * Compared to a scalar one-to-many, will produce a</span>
</span><span data-line="1124"><span class="sd">              clause that compares the target columns in the parent to</span>
</span><span data-line="1125"><span class="sd">              the given target.</span>
</span><span data-line="1126"><span class="sd">            * Compared to a scalar many-to-many, an alias</span>
</span><span data-line="1127"><span class="sd">              of the association table will be rendered as</span>
</span><span data-line="1128"><span class="sd">              well, forming a natural join that is part of the</span>
</span><span data-line="1129"><span class="sd">              main body of the query. This will not work for</span>
</span><span data-line="1130"><span class="sd">              queries that go beyond simple AND conjunctions of</span>
</span><span data-line="1131"><span class="sd">              comparisons, such as those which use OR. Use</span>
</span><span data-line="1132"><span class="sd">              explicit joins, outerjoins, or</span>
</span><span data-line="1133"><span class="sd">              :meth:`~.Relationship.Comparator.has` in</span>
</span><span data-line="1134"><span class="sd">              conjunction with :func:`_expression.not_` for</span>
</span><span data-line="1135"><span class="sd">              more comprehensive non-many-to-one scalar</span>
</span><span data-line="1136"><span class="sd">              membership tests.</span>
</span><span data-line="1137"><span class="sd">            * Comparisons against ``None`` given in a one-to-many</span>
</span><span data-line="1138"><span class="sd">              or many-to-many context produce an EXISTS clause.</span>
</span><span data-line="1139">
</span><span data-line="1140"><span class="sd">            &quot;&quot;&quot;</span>
</span><span data-line="1141">            <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">Null</span><span class="p">):</span>
</span><span data-line="1142">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">MANYTOONE</span><span class="p">:</span>
</span><span data-line="1143">                    <span class="k">return</span> <span class="n">_orm_annotate</span><span class="p">(</span>
</span><span data-line="1144">                        <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">_optimized_compare</span><span class="p">(</span>
</span><span data-line="1145">                            <span class="kc">None</span><span class="p">,</span> <span class="n">adapt_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adapter</span>
</span><span data-line="1146">                        <span class="p">)</span>
</span><span data-line="1147">                    <span class="p">)</span>
</span><span data-line="1148">
</span><span data-line="1149">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1150">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">()</span>
</span><span data-line="1151">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
</span><span data-line="1152">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1153">                    <span class="s2">&quot;Can&#39;t compare a collection&quot;</span>
</span><span data-line="1154">                    <span class="s2">&quot; to an object or collection; use &quot;</span>
</span><span data-line="1155">                    <span class="s2">&quot;contains() to test for membership.&quot;</span>
</span><span data-line="1156">                <span class="p">)</span>
</span><span data-line="1157">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1158">                <span class="k">return</span> <span class="n">_orm_annotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__negated_contains_or_equals</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
</span><span data-line="1159">
</span><span data-line="1160">        <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr_property</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">_PT</span><span class="p">]:</span>
</span><span data-line="1161">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_check_configure</span><span class="p">()</span>
</span><span data-line="1162">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
</span><span data-line="1163">
</span><span data-line="1164">    <span class="k">def</span><span class="w"> </span><span class="nf">_with_parent</span><span class="p">(</span>
</span><span data-line="1165">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1166">        <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
</span><span data-line="1167">        <span class="n">alias_secondary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1168">        <span class="n">from_entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1169">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1170">        <span class="k">assert</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1171">        <span class="n">adapt_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAdapterProto</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1172">        <span class="k">if</span> <span class="n">from_entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1173">            <span class="n">insp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">from_entity</span><span class="p">)</span>
</span><span data-line="1174">            <span class="k">assert</span> <span class="n">insp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1175">            <span class="k">if</span> <span class="n">insp_is_aliased_class</span><span class="p">(</span><span class="n">insp</span><span class="p">):</span>
</span><span data-line="1176">                <span class="n">adapt_source</span> <span class="o">=</span> <span class="n">insp</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">adapt_clause</span>
</span><span data-line="1177">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimized_compare</span><span class="p">(</span>
</span><span data-line="1178">            <span class="n">instance</span><span class="p">,</span>
</span><span data-line="1179">            <span class="n">value_is_parent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1180">            <span class="n">adapt_source</span><span class="o">=</span><span class="n">adapt_source</span><span class="p">,</span>
</span><span data-line="1181">            <span class="n">alias_secondary</span><span class="o">=</span><span class="n">alias_secondary</span><span class="p">,</span>
</span><span data-line="1182">        <span class="p">)</span>
</span><span data-line="1183">
</span><span data-line="1184">    <span class="k">def</span><span class="w"> </span><span class="nf">_optimized_compare</span><span class="p">(</span>
</span><span data-line="1185">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1186">        <span class="n">state</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1187">        <span class="n">value_is_parent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1188">        <span class="n">adapt_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAdapterProto</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1189">        <span class="n">alias_secondary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1190">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1191">        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1192">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1193">                <span class="n">state</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="1194">            <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span><span class="p">:</span>
</span><span data-line="1195">                <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1196">
</span><span data-line="1197">            <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;is_instance&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="1198">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1199">                    <span class="s2">&quot;Mapped instance expected for relationship &quot;</span>
</span><span data-line="1200">                    <span class="s2">&quot;comparison to object.   Classes, queries and other &quot;</span>
</span><span data-line="1201">                    <span class="s2">&quot;SQL elements are not accepted in this context; for &quot;</span>
</span><span data-line="1202">                    <span class="s2">&quot;comparison with a subquery, &quot;</span>
</span><span data-line="1203">                    <span class="s2">&quot;use </span><span class="si">%s</span><span class="s2">.has(**criteria).&quot;</span> <span class="o">%</span> <span class="bp">self</span>
</span><span data-line="1204">                <span class="p">)</span>
</span><span data-line="1205">        <span class="n">reverse_direction</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">value_is_parent</span>
</span><span data-line="1206">
</span><span data-line="1207">        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1208">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_none_clause</span><span class="p">(</span>
</span><span data-line="1209">                <span class="n">reverse_direction</span><span class="p">,</span> <span class="n">adapt_source</span><span class="o">=</span><span class="n">adapt_source</span>
</span><span data-line="1210">            <span class="p">)</span>
</span><span data-line="1211">
</span><span data-line="1212">        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse_direction</span><span class="p">:</span>
</span><span data-line="1213">            <span class="n">criterion</span><span class="p">,</span> <span class="n">bind_to_col</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1214">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_lazywhere</span><span class="p">,</span>
</span><span data-line="1215">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_bind_to_col</span><span class="p">,</span>
</span><span data-line="1216">            <span class="p">)</span>
</span><span data-line="1217">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1218">            <span class="n">criterion</span><span class="p">,</span> <span class="n">bind_to_col</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1219">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_rev_lazywhere</span><span class="p">,</span>
</span><span data-line="1220">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_rev_bind_to_col</span><span class="p">,</span>
</span><span data-line="1221">            <span class="p">)</span>
</span><span data-line="1222">
</span><span data-line="1223">        <span class="k">if</span> <span class="n">reverse_direction</span><span class="p">:</span>
</span><span data-line="1224">            <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="1225">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1226">            <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
</span><span data-line="1227">
</span><span data-line="1228">        <span class="n">dict_</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">())</span>
</span><span data-line="1229">
</span><span data-line="1230">        <span class="k">def</span><span class="w"> </span><span class="nf">visit_bindparam</span><span class="p">(</span><span class="n">bindparam</span><span class="p">:</span> <span class="n">BindParameter</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1231">            <span class="k">if</span> <span class="n">bindparam</span><span class="o">.</span><span class="n">_identifying_key</span> <span class="ow">in</span> <span class="n">bind_to_col</span><span class="p">:</span>
</span><span data-line="1232">                <span class="n">bindparam</span><span class="o">.</span><span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attr_w_warn_on_none</span><span class="p">(</span>
</span><span data-line="1233">                    <span class="n">mapper</span><span class="p">,</span>
</span><span data-line="1234">                    <span class="n">state</span><span class="p">,</span>
</span><span data-line="1235">                    <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1236">                    <span class="n">bind_to_col</span><span class="p">[</span><span class="n">bindparam</span><span class="o">.</span><span class="n">_identifying_key</span><span class="p">],</span>
</span><span data-line="1237">                <span class="p">)</span>
</span><span data-line="1238">
</span><span data-line="1239">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">alias_secondary</span><span class="p">:</span>
</span><span data-line="1240">            <span class="n">criterion</span> <span class="o">=</span> <span class="n">ClauseAdapter</span><span class="p">(</span>
</span><span data-line="1241">                <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">_anonymous_fromclause</span><span class="p">()</span>
</span><span data-line="1242">            <span class="p">)</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span>
</span><span data-line="1243">
</span><span data-line="1244">        <span class="n">criterion</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">cloned_traverse</span><span class="p">(</span>
</span><span data-line="1245">            <span class="n">criterion</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;bindparam&quot;</span><span class="p">:</span> <span class="n">visit_bindparam</span><span class="p">}</span>
</span><span data-line="1246">        <span class="p">)</span>
</span><span data-line="1247">
</span><span data-line="1248">        <span class="k">if</span> <span class="n">adapt_source</span><span class="p">:</span>
</span><span data-line="1249">            <span class="n">criterion</span> <span class="o">=</span> <span class="n">adapt_source</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span>
</span><span data-line="1250">        <span class="k">return</span> <span class="n">criterion</span>
</span><span data-line="1251">
</span><span data-line="1252">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_attr_w_warn_on_none</span><span class="p">(</span>
</span><span data-line="1253">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1254">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1255">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1256">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1257">        <span class="n">column</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1258">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1259"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the callable that is used in a many-to-one expression.</span>
</span><span data-line="1260">
</span><span data-line="1261"><span class="sd">        E.g.::</span>
</span><span data-line="1262">
</span><span data-line="1263"><span class="sd">            u1 = s.query(User).get(5)</span>
</span><span data-line="1264">
</span><span data-line="1265"><span class="sd">            expr = Address.user == u1</span>
</span><span data-line="1266">
</span><span data-line="1267"><span class="sd">        Above, the SQL should be &quot;address.user_id = 5&quot;. The callable</span>
</span><span data-line="1268"><span class="sd">        returned by this method produces the value &quot;5&quot; based on the identity</span>
</span><span data-line="1269"><span class="sd">        of ``u1``.</span>
</span><span data-line="1270">
</span><span data-line="1271"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1272">
</span><span data-line="1273">        <span class="c1"># in this callable, we&#39;re trying to thread the needle through</span>
</span><span data-line="1274">        <span class="c1"># a wide variety of scenarios, including:</span>
</span><span data-line="1275">        <span class="c1">#</span>
</span><span data-line="1276">        <span class="c1"># * the object hasn&#39;t been flushed yet and there&#39;s no value for</span>
</span><span data-line="1277">        <span class="c1">#   the attribute as of yet</span>
</span><span data-line="1278">        <span class="c1">#</span>
</span><span data-line="1279">        <span class="c1"># * the object hasn&#39;t been flushed yet but it has a user-defined</span>
</span><span data-line="1280">        <span class="c1">#   value</span>
</span><span data-line="1281">        <span class="c1">#</span>
</span><span data-line="1282">        <span class="c1"># * the object has a value but it&#39;s expired and not locally present</span>
</span><span data-line="1283">        <span class="c1">#</span>
</span><span data-line="1284">        <span class="c1"># * the object has a value but it&#39;s expired and not locally present,</span>
</span><span data-line="1285">        <span class="c1">#   and the object is also detached</span>
</span><span data-line="1286">        <span class="c1">#</span>
</span><span data-line="1287">        <span class="c1"># * The object hadn&#39;t been flushed yet, there was no value, but</span>
</span><span data-line="1288">        <span class="c1">#   later, the object has been expired and detached, and *now*</span>
</span><span data-line="1289">        <span class="c1">#   they&#39;re trying to evaluate it</span>
</span><span data-line="1290">        <span class="c1">#</span>
</span><span data-line="1291">        <span class="c1"># * the object had a value, but it was changed to a new value, and</span>
</span><span data-line="1292">        <span class="c1">#   then expired</span>
</span><span data-line="1293">        <span class="c1">#</span>
</span><span data-line="1294">        <span class="c1"># * the object had a value, but it was changed to a new value, and</span>
</span><span data-line="1295">        <span class="c1">#   then expired, then the object was detached</span>
</span><span data-line="1296">        <span class="c1">#</span>
</span><span data-line="1297">        <span class="c1"># * the object has a user-set value, but it&#39;s None and we don&#39;t do</span>
</span><span data-line="1298">        <span class="c1">#   the comparison correctly for that so warn</span>
</span><span data-line="1299">        <span class="c1">#</span>
</span><span data-line="1300">
</span><span data-line="1301">        <span class="n">prop</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">get_property_by_column</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
</span><span data-line="1302">
</span><span data-line="1303">        <span class="c1"># by invoking this method, InstanceState will track the last known</span>
</span><span data-line="1304">        <span class="c1"># value for this key each time the attribute is to be expired.</span>
</span><span data-line="1305">        <span class="c1"># this feature was added explicitly for use in this method.</span>
</span><span data-line="1306">        <span class="n">state</span><span class="o">.</span><span class="n">_track_last_known_value</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1307">
</span><span data-line="1308">        <span class="n">lkv_fixed</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">_last_known_values</span>
</span><span data-line="1309">
</span><span data-line="1310">        <span class="k">def</span><span class="w"> </span><span class="nf">_go</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1311">            <span class="k">assert</span> <span class="n">lkv_fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1312">            <span class="n">last_known</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">=</span> <span class="n">lkv_fixed</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1313">            <span class="n">existing_is_available</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1314">                <span class="n">last_known</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">NO_VALUE</span>
</span><span data-line="1315">            <span class="p">)</span>
</span><span data-line="1316">
</span><span data-line="1317">            <span class="c1"># we support that the value may have changed.  so here we</span>
</span><span data-line="1318">            <span class="c1"># try to get the most recent value including re-fetching.</span>
</span><span data-line="1319">            <span class="c1"># only if we can&#39;t get a value now due to detachment do we return</span>
</span><span data-line="1320">            <span class="c1"># the last known value</span>
</span><span data-line="1321">            <span class="n">current_value</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_get_state_attr_by_column</span><span class="p">(</span>
</span><span data-line="1322">                <span class="n">state</span><span class="p">,</span>
</span><span data-line="1323">                <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1324">                <span class="n">column</span><span class="p">,</span>
</span><span data-line="1325">                <span class="n">passive</span><span class="o">=</span><span class="p">(</span>
</span><span data-line="1326">                    <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span>
</span><span data-line="1327">                    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">persistent</span>
</span><span data-line="1328">                    <span class="k">else</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_FETCH</span> <span class="o">^</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">INIT_OK</span>
</span><span data-line="1329">                <span class="p">),</span>
</span><span data-line="1330">            <span class="p">)</span>
</span><span data-line="1331">
</span><span data-line="1332">            <span class="k">if</span> <span class="n">current_value</span> <span class="ow">is</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">NEVER_SET</span><span class="p">:</span>
</span><span data-line="1333">                <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_is_available</span><span class="p">:</span>
</span><span data-line="1334">                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1335">                        <span class="s2">&quot;Can&#39;t resolve value for column </span><span class="si">%s</span><span class="s2"> on object &quot;</span>
</span><span data-line="1336">                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">; no value has been set for this column&quot;</span>
</span><span data-line="1337">                        <span class="o">%</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</span><span data-line="1338">                    <span class="p">)</span>
</span><span data-line="1339">            <span class="k">elif</span> <span class="n">current_value</span> <span class="ow">is</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1340">                <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_is_available</span><span class="p">:</span>
</span><span data-line="1341">                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1342">                        <span class="s2">&quot;Can&#39;t resolve value for column </span><span class="si">%s</span><span class="s2"> on object &quot;</span>
</span><span data-line="1343">                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">; the object is detached and the value was &quot;</span>
</span><span data-line="1344">                        <span class="s2">&quot;expired&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</span><span data-line="1345">                    <span class="p">)</span>
</span><span data-line="1346">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1347">                <span class="n">to_return</span> <span class="o">=</span> <span class="n">current_value</span>
</span><span data-line="1348">            <span class="k">if</span> <span class="n">to_return</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1349">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1350">                    <span class="s2">&quot;Got None for value of column </span><span class="si">%s</span><span class="s2">; this is unsupported &quot;</span>
</span><span data-line="1351">                    <span class="s2">&quot;for a relationship comparison and will not &quot;</span>
</span><span data-line="1352">                    <span class="s2">&quot;currently produce an IS comparison &quot;</span>
</span><span data-line="1353">                    <span class="s2">&quot;(but may in a future release)&quot;</span> <span class="o">%</span> <span class="n">column</span>
</span><span data-line="1354">                <span class="p">)</span>
</span><span data-line="1355">            <span class="k">return</span> <span class="n">to_return</span>
</span><span data-line="1356">
</span><span data-line="1357">        <span class="k">return</span> <span class="n">_go</span>
</span><span data-line="1358">
</span><span data-line="1359">    <span class="k">def</span><span class="w"> </span><span class="nf">_lazy_none_clause</span><span class="p">(</span>
</span><span data-line="1360">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1361">        <span class="n">reverse_direction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1362">        <span class="n">adapt_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAdapterProto</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1363">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1364">        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse_direction</span><span class="p">:</span>
</span><span data-line="1365">            <span class="n">criterion</span><span class="p">,</span> <span class="n">bind_to_col</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1366">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_lazywhere</span><span class="p">,</span>
</span><span data-line="1367">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_bind_to_col</span><span class="p">,</span>
</span><span data-line="1368">            <span class="p">)</span>
</span><span data-line="1369">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1370">            <span class="n">criterion</span><span class="p">,</span> <span class="n">bind_to_col</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1371">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_rev_lazywhere</span><span class="p">,</span>
</span><span data-line="1372">                <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span><span class="o">.</span><span class="n">_rev_bind_to_col</span><span class="p">,</span>
</span><span data-line="1373">            <span class="p">)</span>
</span><span data-line="1374">
</span><span data-line="1375">        <span class="n">criterion</span> <span class="o">=</span> <span class="n">adapt_criterion_to_null</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="n">bind_to_col</span><span class="p">)</span>
</span><span data-line="1376">
</span><span data-line="1377">        <span class="k">if</span> <span class="n">adapt_source</span><span class="p">:</span>
</span><span data-line="1378">            <span class="n">criterion</span> <span class="o">=</span> <span class="n">adapt_source</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span>
</span><span data-line="1379">        <span class="k">return</span> <span class="n">criterion</span>
</span><span data-line="1380">
</span><span data-line="1381">    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="1382">        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="1383">
</span><span data-line="1384">    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span>
</span><span data-line="1385">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1386">        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
</span><span data-line="1387">        <span class="n">source_state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1388">        <span class="n">source_dict</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1389">        <span class="n">dest_state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1390">        <span class="n">dest_dict</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1391">        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="1392">        <span class="n">_recursive</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
</span><span data-line="1393">        <span class="n">_resolve_conflict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">],</span>
</span><span data-line="1394">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1395">        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="1396">            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_property</span><span class="p">:</span>
</span><span data-line="1397">                <span class="k">if</span> <span class="p">(</span><span class="n">source_state</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_recursive</span><span class="p">:</span>
</span><span data-line="1398">                    <span class="k">return</span>
</span><span data-line="1399">
</span><span data-line="1400">        <span class="k">if</span> <span class="s2">&quot;merge&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cascade</span><span class="p">:</span>
</span><span data-line="1401">            <span class="k">return</span>
</span><span data-line="1402">
</span><span data-line="1403">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_dict</span><span class="p">:</span>
</span><span data-line="1404">            <span class="k">return</span>
</span><span data-line="1405">
</span><span data-line="1406">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
</span><span data-line="1407">            <span class="n">impl</span> <span class="o">=</span> <span class="n">source_state</span><span class="o">.</span><span class="n">get_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1408">
</span><span data-line="1409">            <span class="k">assert</span> <span class="n">is_has_collection_adapter</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span>
</span><span data-line="1410">            <span class="n">instances_iterable</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">source_state</span><span class="p">,</span> <span class="n">source_dict</span><span class="p">)</span>
</span><span data-line="1411">
</span><span data-line="1412">            <span class="c1"># if this is a CollectionAttributeImpl, then empty should</span>
</span><span data-line="1413">            <span class="c1"># be False, otherwise &quot;self.key in source_dict&quot; should not be</span>
</span><span data-line="1414">            <span class="c1"># True</span>
</span><span data-line="1415">            <span class="k">assert</span> <span class="ow">not</span> <span class="n">instances_iterable</span><span class="o">.</span><span class="n">empty</span> <span class="k">if</span> <span class="n">impl</span><span class="o">.</span><span class="n">collection</span> <span class="k">else</span> <span class="kc">True</span>
</span><span data-line="1416">
</span><span data-line="1417">            <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="1418">                <span class="c1"># for a full merge, pre-load the destination collection,</span>
</span><span data-line="1419">                <span class="c1"># so that individual _merge of each item pulls from identity</span>
</span><span data-line="1420">                <span class="c1"># map for those already present.</span>
</span><span data-line="1421">                <span class="c1"># also assumes CollectionAttributeImpl behavior of loading</span>
</span><span data-line="1422">                <span class="c1"># &quot;old&quot; list in any case</span>
</span><span data-line="1423">                <span class="n">dest_state</span><span class="o">.</span><span class="n">get_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="1424">                    <span class="n">dest_state</span><span class="p">,</span> <span class="n">dest_dict</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_MERGE</span>
</span><span data-line="1425">                <span class="p">)</span>
</span><span data-line="1426">
</span><span data-line="1427">            <span class="n">dest_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1428">            <span class="k">for</span> <span class="n">current</span> <span class="ow">in</span> <span class="n">instances_iterable</span><span class="p">:</span>
</span><span data-line="1429">                <span class="n">current_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span data-line="1430">                <span class="n">current_dict</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span data-line="1431">                <span class="n">_recursive</span><span class="p">[(</span><span class="n">current_state</span><span class="p">,</span> <span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1432">                <span class="n">obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span>
</span><span data-line="1433">                    <span class="n">current_state</span><span class="p">,</span>
</span><span data-line="1434">                    <span class="n">current_dict</span><span class="p">,</span>
</span><span data-line="1435">                    <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
</span><span data-line="1436">                    <span class="n">_recursive</span><span class="o">=</span><span class="n">_recursive</span><span class="p">,</span>
</span><span data-line="1437">                    <span class="n">_resolve_conflict_map</span><span class="o">=</span><span class="n">_resolve_conflict_map</span><span class="p">,</span>
</span><span data-line="1438">                <span class="p">)</span>
</span><span data-line="1439">                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1440">                    <span class="n">dest_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span data-line="1441">
</span><span data-line="1442">            <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="1443">                <span class="n">coll</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">init_state_collection</span><span class="p">(</span>
</span><span data-line="1444">                    <span class="n">dest_state</span><span class="p">,</span> <span class="n">dest_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="1445">                <span class="p">)</span>
</span><span data-line="1446">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dest_list</span><span class="p">:</span>
</span><span data-line="1447">                    <span class="n">coll</span><span class="o">.</span><span class="n">append_without_event</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="1448">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1449">                <span class="n">dest_impl</span> <span class="o">=</span> <span class="n">dest_state</span><span class="o">.</span><span class="n">get_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1450">                <span class="k">assert</span> <span class="n">is_has_collection_adapter</span><span class="p">(</span><span class="n">dest_impl</span><span class="p">)</span>
</span><span data-line="1451">                <span class="n">dest_impl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span data-line="1452">                    <span class="n">dest_state</span><span class="p">,</span>
</span><span data-line="1453">                    <span class="n">dest_dict</span><span class="p">,</span>
</span><span data-line="1454">                    <span class="n">dest_list</span><span class="p">,</span>
</span><span data-line="1455">                    <span class="n">_adapt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1456">                    <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_MERGE</span><span class="p">,</span>
</span><span data-line="1457">                <span class="p">)</span>
</span><span data-line="1458">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1459">            <span class="n">current</span> <span class="o">=</span> <span class="n">source_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1460">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1461">                <span class="n">current_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span data-line="1462">                <span class="n">current_dict</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span data-line="1463">                <span class="n">_recursive</span><span class="p">[(</span><span class="n">current_state</span><span class="p">,</span> <span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1464">                <span class="n">obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span>
</span><span data-line="1465">                    <span class="n">current_state</span><span class="p">,</span>
</span><span data-line="1466">                    <span class="n">current_dict</span><span class="p">,</span>
</span><span data-line="1467">                    <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
</span><span data-line="1468">                    <span class="n">_recursive</span><span class="o">=</span><span class="n">_recursive</span><span class="p">,</span>
</span><span data-line="1469">                    <span class="n">_resolve_conflict_map</span><span class="o">=</span><span class="n">_resolve_conflict_map</span><span class="p">,</span>
</span><span data-line="1470">                <span class="p">)</span>
</span><span data-line="1471">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1472">                <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1473">
</span><span data-line="1474">            <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="1475">                <span class="n">dest_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="1476">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1477">                <span class="n">dest_state</span><span class="o">.</span><span class="n">get_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span data-line="1478">                    <span class="n">dest_state</span><span class="p">,</span> <span class="n">dest_dict</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="1479">                <span class="p">)</span>
</span><span data-line="1480">
</span><span data-line="1481">    <span class="k">def</span><span class="w"> </span><span class="nf">_value_as_iterable</span><span class="p">(</span>
</span><span data-line="1482">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1483">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="1484">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1485">        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="1486">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1487">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">_O</span><span class="p">]]:</span>
</span><span data-line="1488"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of tuples (state, obj) for the given</span>
</span><span data-line="1489"><span class="sd">        key.</span>
</span><span data-line="1490">
</span><span data-line="1491"><span class="sd">        returns an empty list if the value is None/empty/PASSIVE_NO_RESULT</span>
</span><span data-line="1492"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1493">
</span><span data-line="1494">        <span class="n">impl</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="1495">        <span class="n">x</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1496">        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1497">            <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="1498">        <span class="k">elif</span> <span class="n">is_has_collection_adapter</span><span class="p">(</span><span class="n">impl</span><span class="p">):</span>
</span><span data-line="1499">            <span class="k">return</span> <span class="p">[</span>
</span><span data-line="1500">                <span class="p">(</span><span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">o</span><span class="p">)</span>
</span><span data-line="1501">                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">impl</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1502">            <span class="p">]</span>
</span><span data-line="1503">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1504">            <span class="k">return</span> <span class="p">[(</span><span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">)]</span>
</span><span data-line="1505">
</span><span data-line="1506">    <span class="k">def</span><span class="w"> </span><span class="nf">cascade_iterator</span><span class="p">(</span>
</span><span data-line="1507">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1508">        <span class="n">type_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="1509">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1510">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1511">        <span class="n">visited_states</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="1512">        <span class="n">halt_on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1513">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">_InstanceDict</span><span class="p">]]:</span>
</span><span data-line="1514">        <span class="c1"># assert type_ in self._cascade</span>
</span><span data-line="1515">
</span><span data-line="1516">        <span class="c1"># only actively lazy load on the &#39;delete&#39; cascade</span>
</span><span data-line="1517">        <span class="k">if</span> <span class="n">type_</span> <span class="o">!=</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">passive_deletes</span><span class="p">:</span>
</span><span data-line="1518">            <span class="n">passive</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_INITIALIZE</span>
</span><span data-line="1519">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1520">            <span class="n">passive</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span> <span class="o">|</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">NO_RAISE</span>
</span><span data-line="1521">
</span><span data-line="1522">        <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;save-update&quot;</span><span class="p">:</span>
</span><span data-line="1523">            <span class="n">tuples</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_all_pending</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="1524">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1525">            <span class="n">tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_as_iterable</span><span class="p">(</span>
</span><span data-line="1526">                <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span>
</span><span data-line="1527">            <span class="p">)</span>
</span><span data-line="1528">
</span><span data-line="1529">        <span class="n">skip_pending</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1530">            <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;refresh-expire&quot;</span> <span class="ow">and</span> <span class="s2">&quot;delete-orphan&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cascade</span>
</span><span data-line="1531">        <span class="p">)</span>
</span><span data-line="1532">
</span><span data-line="1533">        <span class="k">for</span> <span class="n">instance_state</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
</span><span data-line="1534">            <span class="k">if</span> <span class="n">instance_state</span> <span class="ow">in</span> <span class="n">visited_states</span><span class="p">:</span>
</span><span data-line="1535">                <span class="k">continue</span>
</span><span data-line="1536">
</span><span data-line="1537">            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1538">                <span class="c1"># would like to emit a warning here, but</span>
</span><span data-line="1539">                <span class="c1"># would not be consistent with collection.append(None)</span>
</span><span data-line="1540">                <span class="c1"># current behavior of silently skipping.</span>
</span><span data-line="1541">                <span class="c1"># see [ticket:2229]</span>
</span><span data-line="1542">                <span class="k">continue</span>
</span><span data-line="1543">
</span><span data-line="1544">            <span class="k">assert</span> <span class="n">instance_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1545">            <span class="n">instance_dict</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="1546">
</span><span data-line="1547">            <span class="k">if</span> <span class="n">halt_on</span> <span class="ow">and</span> <span class="n">halt_on</span><span class="p">(</span><span class="n">instance_state</span><span class="p">):</span>
</span><span data-line="1548">                <span class="k">continue</span>
</span><span data-line="1549">
</span><span data-line="1550">            <span class="k">if</span> <span class="n">skip_pending</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">instance_state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span data-line="1551">                <span class="k">continue</span>
</span><span data-line="1552">
</span><span data-line="1553">            <span class="n">instance_mapper</span> <span class="o">=</span> <span class="n">instance_state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="1554">
</span><span data-line="1555">            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance_mapper</span><span class="o">.</span><span class="n">isa</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">mapper</span><span class="p">):</span>
</span><span data-line="1556">                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
</span><span data-line="1557">                    <span class="s2">&quot;Attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; on class &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
</span><span data-line="1558">                    <span class="s2">&quot;doesn&#39;t handle objects &quot;</span>
</span><span data-line="1559">                    <span class="s2">&quot;of type &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
</span><span data-line="1560">                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
</span><span data-line="1561">                <span class="p">)</span>
</span><span data-line="1562">
</span><span data-line="1563">            <span class="n">visited_states</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance_state</span><span class="p">)</span>
</span><span data-line="1564">
</span><span data-line="1565">            <span class="k">yield</span> <span class="n">c</span><span class="p">,</span> <span class="n">instance_mapper</span><span class="p">,</span> <span class="n">instance_state</span><span class="p">,</span> <span class="n">instance_dict</span>
</span><span data-line="1566">
</span><span data-line="1567">    <span class="nd">@property</span>
</span><span data-line="1568">    <span class="k">def</span><span class="w"> </span><span class="nf">_effective_sync_backref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1569">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewonly</span><span class="p">:</span>
</span><span data-line="1570">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="1571">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1572">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_backref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span data-line="1573">
</span><span data-line="1574">    <span class="nd">@staticmethod</span>
</span><span data-line="1575">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_sync_backref</span><span class="p">(</span>
</span><span data-line="1576">        <span class="n">rel_a</span><span class="p">:</span> <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">rel_b</span><span class="p">:</span> <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1577">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1578">        <span class="k">if</span> <span class="n">rel_a</span><span class="o">.</span><span class="n">viewonly</span> <span class="ow">and</span> <span class="n">rel_b</span><span class="o">.</span><span class="n">sync_backref</span><span class="p">:</span>
</span><span data-line="1579">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1580">                <span class="s2">&quot;Relationship </span><span class="si">%s</span><span class="s2"> cannot specify sync_backref=True since </span><span class="si">%s</span><span class="s2"> &quot;</span>
</span><span data-line="1581">                <span class="s2">&quot;includes viewonly=True.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rel_b</span><span class="p">,</span> <span class="n">rel_a</span><span class="p">)</span>
</span><span data-line="1582">            <span class="p">)</span>
</span><span data-line="1583">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1584">            <span class="n">rel_a</span><span class="o">.</span><span class="n">viewonly</span>
</span><span data-line="1585">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">rel_b</span><span class="o">.</span><span class="n">viewonly</span>
</span><span data-line="1586">            <span class="ow">and</span> <span class="n">rel_b</span><span class="o">.</span><span class="n">sync_backref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span data-line="1587">        <span class="p">):</span>
</span><span data-line="1588">            <span class="n">rel_b</span><span class="o">.</span><span class="n">sync_backref</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1589">
</span><span data-line="1590">    <span class="k">def</span><span class="w"> </span><span class="nf">_add_reverse_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1591">        <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_configure_mappers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="1592">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
</span><span data-line="1593">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1594">                <span class="s2">&quot;back_populates on relationship &#39;</span><span class="si">%s</span><span class="s2">&#39; refers to attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
</span><span data-line="1595">                <span class="s2">&quot;that is not a relationship.  The back_populates parameter &quot;</span>
</span><span data-line="1596">                <span class="s2">&quot;should refer to the name of a relationship on the target &quot;</span>
</span><span data-line="1597">                <span class="s2">&quot;class.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span data-line="1598">            <span class="p">)</span>
</span><span data-line="1599">        <span class="c1"># viewonly and sync_backref cases</span>
</span><span data-line="1600">        <span class="c1"># 1. self.viewonly==True and other.sync_backref==True -&gt; error</span>
</span><span data-line="1601">        <span class="c1"># 2. self.viewonly==True and other.viewonly==False and</span>
</span><span data-line="1602">        <span class="c1">#    other.sync_backref==None -&gt; warn sync_backref=False, set to False</span>
</span><span data-line="1603">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_sync_backref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span data-line="1604">        <span class="c1"># 3. other.viewonly==True and self.sync_backref==True -&gt; error</span>
</span><span data-line="1605">        <span class="c1"># 4. other.viewonly==True and self.viewonly==False and</span>
</span><span data-line="1606">        <span class="c1">#    self.sync_backref==None -&gt; warn sync_backref=False, set to False</span>
</span><span data-line="1607">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_sync_backref</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="1608">
</span><span data-line="1609">        <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_property</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span data-line="1610">        <span class="n">other</span><span class="o">.</span><span class="n">_reverse_property</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1611">
</span><span data-line="1612">        <span class="n">other</span><span class="o">.</span><span class="n">_setup_entity</span><span class="p">()</span>
</span><span data-line="1613">
</span><span data-line="1614">        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">common_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">):</span>
</span><span data-line="1615">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1616">                <span class="s2">&quot;reverse_property </span><span class="si">%r</span><span class="s2"> on &quot;</span>
</span><span data-line="1617">                <span class="s2">&quot;relationship </span><span class="si">%s</span><span class="s2"> references relationship </span><span class="si">%s</span><span class="s2">, which &quot;</span>
</span><span data-line="1618">                <span class="s2">&quot;does not reference mapper </span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span data-line="1619">                <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span data-line="1620">            <span class="p">)</span>
</span><span data-line="1621">
</span><span data-line="1622">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1623">            <span class="n">other</span><span class="o">.</span><span class="n">_configure_started</span>
</span><span data-line="1624">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ONETOMANY</span><span class="p">,</span> <span class="n">MANYTOONE</span><span class="p">)</span>
</span><span data-line="1625">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">direction</span>
</span><span data-line="1626">        <span class="p">):</span>
</span><span data-line="1627">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1628">                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> and back-reference </span><span class="si">%s</span><span class="s2"> are &quot;</span>
</span><span data-line="1629">                <span class="s2">&quot;both of the same direction </span><span class="si">%r</span><span class="s2">.  Did you mean to &quot;</span>
</span><span data-line="1630">                <span class="s2">&quot;set remote_side on the many-to-one side ?&quot;</span>
</span><span data-line="1631">                <span class="o">%</span> <span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
</span><span data-line="1632">            <span class="p">)</span>
</span><span data-line="1633">
</span><span data-line="1634">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="1635">    <span class="k">def</span><span class="w"> </span><span class="nf">entity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1636"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the target mapped entity, which is an inspect() of the</span>
</span><span data-line="1637"><span class="sd">        class or aliased class that is referenced by this</span>
</span><span data-line="1638"><span class="sd">        :class:`.RelationshipProperty`.</span>
</span><span data-line="1639">
</span><span data-line="1640"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1641">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_check_configure</span><span class="p">()</span>
</span><span data-line="1642">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span>
</span><span data-line="1643">
</span><span data-line="1644">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="1645">    <span class="k">def</span><span class="w"> </span><span class="nf">mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1646"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the targeted :class:`_orm.Mapper` for this</span>
</span><span data-line="1647"><span class="sd">        :class:`.RelationshipProperty`.</span>
</span><span data-line="1648">
</span><span data-line="1649"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1650">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="1651">
</span><span data-line="1652">    <span class="k">def</span><span class="w"> </span><span class="nf">do_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1653">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_conflicts</span><span class="p">()</span>
</span><span data-line="1654">        <span class="bp">self</span><span class="o">.</span><span class="n">_process_dependent_arguments</span><span class="p">()</span>
</span><span data-line="1655">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_entity</span><span class="p">()</span>
</span><span data-line="1656">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_registry_dependencies</span><span class="p">()</span>
</span><span data-line="1657">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_join_conditions</span><span class="p">()</span>
</span><span data-line="1658">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cascade_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cascade</span><span class="p">)</span>
</span><span data-line="1659">        <span class="bp">self</span><span class="o">.</span><span class="n">_post_init</span><span class="p">()</span>
</span><span data-line="1660">        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_backref</span><span class="p">()</span>
</span><span data-line="1661">        <span class="bp">self</span><span class="o">.</span><span class="n">_join_condition</span><span class="o">.</span><span class="n">_warn_for_conflicting_sync_targets</span><span class="p">()</span>
</span><span data-line="1662">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">do_init</span><span class="p">()</span>
</span><span data-line="1663">        <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="1664">            <span class="s2">&quot;LazyLoader&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_strategy</span><span class="p">(((</span><span class="s2">&quot;lazy&quot;</span><span class="p">,</span> <span class="s2">&quot;select&quot;</span><span class="p">),))</span>
</span><span data-line="1665">        <span class="p">)</span>
</span><span data-line="1666">
</span><span data-line="1667">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_registry_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1668">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">_set_depends_on</span><span class="p">(</span>
</span><span data-line="1669">            <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">registry</span>
</span><span data-line="1670">        <span class="p">)</span>
</span><span data-line="1671">
</span><span data-line="1672">    <span class="k">def</span><span class="w"> </span><span class="nf">_process_dependent_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1673"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert incoming configuration arguments to their</span>
</span><span data-line="1674"><span class="sd">        proper form.</span>
</span><span data-line="1675">
</span><span data-line="1676"><span class="sd">        Callables are resolved, ORM annotations removed.</span>
</span><span data-line="1677">
</span><span data-line="1678"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1679">
</span><span data-line="1680">        <span class="c1"># accept callables for other attributes which may require</span>
</span><span data-line="1681">        <span class="c1"># deferred initialization.  This technique is used</span>
</span><span data-line="1682">        <span class="c1"># by declarative &quot;string configs&quot; and some recipes.</span>
</span><span data-line="1683">        <span class="n">init_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_args</span>
</span><span data-line="1684">
</span><span data-line="1685">        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span>
</span><span data-line="1686">            <span class="s2">&quot;order_by&quot;</span><span class="p">,</span>
</span><span data-line="1687">            <span class="s2">&quot;primaryjoin&quot;</span><span class="p">,</span>
</span><span data-line="1688">            <span class="s2">&quot;secondaryjoin&quot;</span><span class="p">,</span>
</span><span data-line="1689">            <span class="s2">&quot;secondary&quot;</span><span class="p">,</span>
</span><span data-line="1690">            <span class="s2">&quot;foreign_keys&quot;</span><span class="p">,</span>
</span><span data-line="1691">            <span class="s2">&quot;remote_side&quot;</span><span class="p">,</span>
</span><span data-line="1692">        <span class="p">):</span>
</span><span data-line="1693">            <span class="n">rel_arg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">init_args</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span data-line="1694">
</span><span data-line="1695">            <span class="n">rel_arg</span><span class="o">.</span><span class="n">_resolve_against_registry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clsregistry_resolvers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="1696">
</span><span data-line="1697">        <span class="c1"># remove &quot;annotations&quot; which are present if mapped class</span>
</span><span data-line="1698">        <span class="c1"># descriptors are used to create the join expression.</span>
</span><span data-line="1699">        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="s2">&quot;primaryjoin&quot;</span><span class="p">,</span> <span class="s2">&quot;secondaryjoin&quot;</span><span class="p">:</span>
</span><span data-line="1700">            <span class="n">rel_arg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">init_args</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span data-line="1701">            <span class="n">val</span> <span class="o">=</span> <span class="n">rel_arg</span><span class="o">.</span><span class="n">resolved</span>
</span><span data-line="1702">            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1703">                <span class="n">rel_arg</span><span class="o">.</span><span class="n">resolved</span> <span class="o">=</span> <span class="n">_orm_deannotate</span><span class="p">(</span>
</span><span data-line="1704">                    <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span>
</span><span data-line="1705">                        <span class="n">roles</span><span class="o">.</span><span class="n">ColumnArgumentRole</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="n">attr</span>
</span><span data-line="1706">                    <span class="p">)</span>
</span><span data-line="1707">                <span class="p">)</span>
</span><span data-line="1708">
</span><span data-line="1709">        <span class="n">secondary</span> <span class="o">=</span> <span class="n">init_args</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">resolved</span>
</span><span data-line="1710">        <span class="k">if</span> <span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="n">secondary</span><span class="p">):</span>
</span><span data-line="1711">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1712">                <span class="s2">&quot;secondary argument </span><span class="si">%s</span><span class="s2"> passed to to relationship() </span><span class="si">%s</span><span class="s2"> must &quot;</span>
</span><span data-line="1713">                <span class="s2">&quot;be a Table object or other FROM clause; can&#39;t send a mapped &quot;</span>
</span><span data-line="1714">                <span class="s2">&quot;class directly as rows in &#39;secondary&#39; are persisted &quot;</span>
</span><span data-line="1715">                <span class="s2">&quot;independently of a class that is mapped &quot;</span>
</span><span data-line="1716">                <span class="s2">&quot;to that same table.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">secondary</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="1717">            <span class="p">)</span>
</span><span data-line="1718">
</span><span data-line="1719">        <span class="c1"># ensure expressions in self.order_by, foreign_keys,</span>
</span><span data-line="1720">        <span class="c1"># remote_side are all columns, not strings.</span>
</span><span data-line="1721">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1722">            <span class="n">init_args</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">resolved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span data-line="1723">            <span class="ow">and</span> <span class="n">init_args</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">resolved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1724">        <span class="p">):</span>
</span><span data-line="1725">            <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span data-line="1726">                <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span>
</span><span data-line="1727">                    <span class="n">roles</span><span class="o">.</span><span class="n">ColumnArgumentRole</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="s2">&quot;order_by&quot;</span>
</span><span data-line="1728">                <span class="p">)</span>
</span><span data-line="1729">                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">init_args</span><span class="o">.</span><span class="n">order_by</span><span class="o">.</span><span class="n">resolved</span><span class="p">)</span>
</span><span data-line="1730">            <span class="p">)</span>
</span><span data-line="1731">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1732">            <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1733">
</span><span data-line="1734">        <span class="bp">self</span><span class="o">.</span><span class="n">_user_defined_foreign_keys</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span>
</span><span data-line="1735">            <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span>
</span><span data-line="1736">                <span class="n">roles</span><span class="o">.</span><span class="n">ColumnArgumentRole</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="s2">&quot;foreign_keys&quot;</span>
</span><span data-line="1737">            <span class="p">)</span>
</span><span data-line="1738">            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_column_set</span><span class="p">(</span><span class="n">init_args</span><span class="o">.</span><span class="n">foreign_keys</span><span class="o">.</span><span class="n">resolved</span><span class="p">)</span>
</span><span data-line="1739">        <span class="p">)</span>
</span><span data-line="1740">
</span><span data-line="1741">        <span class="bp">self</span><span class="o">.</span><span class="n">remote_side</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span>
</span><span data-line="1742">            <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span>
</span><span data-line="1743">                <span class="n">roles</span><span class="o">.</span><span class="n">ColumnArgumentRole</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="s2">&quot;remote_side&quot;</span>
</span><span data-line="1744">            <span class="p">)</span>
</span><span data-line="1745">            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_column_set</span><span class="p">(</span><span class="n">init_args</span><span class="o">.</span><span class="n">remote_side</span><span class="o">.</span><span class="n">resolved</span><span class="p">)</span>
</span><span data-line="1746">        <span class="p">)</span>
</span><span data-line="1747">
</span><span data-line="1748">    <span class="k">def</span><span class="w"> </span><span class="nf">declarative_scan</span><span class="p">(</span>
</span><span data-line="1749">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1750">        <span class="n">decl_scan</span><span class="p">:</span> <span class="n">_ClassScanMapperConfig</span><span class="p">,</span>
</span><span data-line="1751">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span data-line="1752">        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1753">        <span class="n">originating_module</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1754">        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="1755">        <span class="n">mapped_container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Mapped</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
</span><span data-line="1756">        <span class="n">annotation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AnnotationScanType</span><span class="p">],</span>
</span><span data-line="1757">        <span class="n">extracted_mapped_annotation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AnnotationScanType</span><span class="p">],</span>
</span><span data-line="1758">        <span class="n">is_dataclass_field</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="1759">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1760">        <span class="k">if</span> <span class="n">extracted_mapped_annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1761">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1762">                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_for_required</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="1763">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1764">                <span class="k">return</span>
</span><span data-line="1765">
</span><span data-line="1766">        <span class="n">argument</span> <span class="o">=</span> <span class="n">extracted_mapped_annotation</span>
</span><span data-line="1767">        <span class="k">assert</span> <span class="n">originating_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1768">
</span><span data-line="1769">        <span class="k">if</span> <span class="n">mapped_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1770">            <span class="n">is_write_only</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">mapped_container</span><span class="p">,</span> <span class="n">WriteOnlyMapped</span><span class="p">)</span>
</span><span data-line="1771">            <span class="n">is_dynamic</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">mapped_container</span><span class="p">,</span> <span class="n">DynamicMapped</span><span class="p">)</span>
</span><span data-line="1772">            <span class="k">if</span> <span class="n">is_write_only</span><span class="p">:</span>
</span><span data-line="1773">                <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="s2">&quot;write_only&quot;</span>
</span><span data-line="1774">                <span class="bp">self</span><span class="o">.</span><span class="n">strategy_key</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;lazy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">),)</span>
</span><span data-line="1775">            <span class="k">elif</span> <span class="n">is_dynamic</span><span class="p">:</span>
</span><span data-line="1776">                <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="s2">&quot;dynamic&quot;</span>
</span><span data-line="1777">                <span class="bp">self</span><span class="o">.</span><span class="n">strategy_key</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;lazy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">),)</span>
</span><span data-line="1778">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1779">            <span class="n">is_write_only</span> <span class="o">=</span> <span class="n">is_dynamic</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1780">
</span><span data-line="1781">        <span class="n">argument</span> <span class="o">=</span> <span class="n">de_optionalize_union_types</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
</span><span data-line="1782">
</span><span data-line="1783">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">):</span>
</span><span data-line="1784">            <span class="n">arg_origin</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">__origin__</span>
</span><span data-line="1785">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_origin</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
</span><span data-line="1786">                <span class="n">arg_origin</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">Collection</span>
</span><span data-line="1787">            <span class="p">):</span>
</span><span data-line="1788">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1789">                    <span class="k">if</span> <span class="n">_py_inspect</span><span class="o">.</span><span class="n">isabstract</span><span class="p">(</span><span class="n">arg_origin</span><span class="p">):</span>
</span><span data-line="1790">                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1791">                            <span class="sa">f</span><span class="s2">&quot;Collection annotation type </span><span class="si">{</span><span class="n">arg_origin</span><span class="si">}</span><span class="s2"> cannot &quot;</span>
</span><span data-line="1792">                            <span class="s2">&quot;be instantiated; please provide an explicit &quot;</span>
</span><span data-line="1793">                            <span class="s2">&quot;&#39;collection_class&#39; parameter &quot;</span>
</span><span data-line="1794">                            <span class="s2">&quot;(e.g. list, set, etc.) to the &quot;</span>
</span><span data-line="1795">                            <span class="s2">&quot;relationship() function to accompany this &quot;</span>
</span><span data-line="1796">                            <span class="s2">&quot;annotation&quot;</span>
</span><span data-line="1797">                        <span class="p">)</span>
</span><span data-line="1798">
</span><span data-line="1799">                    <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="o">=</span> <span class="n">arg_origin</span>
</span><span data-line="1800">
</span><span data-line="1801">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_write_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_dynamic</span><span class="p">:</span>
</span><span data-line="1802">                <span class="bp">self</span><span class="o">.</span><span class="n">uselist</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1803">
</span><span data-line="1804">            <span class="k">if</span> <span class="n">argument</span><span class="o">.</span><span class="n">__args__</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1805">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_origin</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
</span><span data-line="1806">                    <span class="n">arg_origin</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Mapping</span>
</span><span data-line="1807">                <span class="p">):</span>
</span><span data-line="1808">                    <span class="n">type_arg</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1809">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1810">                    <span class="n">type_arg</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1811">                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">type_arg</span><span class="p">,</span> <span class="s2">&quot;__forward_arg__&quot;</span><span class="p">):</span>
</span><span data-line="1812">                    <span class="n">str_argument</span> <span class="o">=</span> <span class="n">type_arg</span><span class="o">.</span><span class="n">__forward_arg__</span>
</span><span data-line="1813">
</span><span data-line="1814">                    <span class="n">argument</span> <span class="o">=</span> <span class="n">resolve_name_to_real_class_name</span><span class="p">(</span>
</span><span data-line="1815">                        <span class="n">str_argument</span><span class="p">,</span> <span class="n">originating_module</span>
</span><span data-line="1816">                    <span class="p">)</span>
</span><span data-line="1817">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1818">                    <span class="n">argument</span> <span class="o">=</span> <span class="n">type_arg</span>
</span><span data-line="1819">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1820">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1821">                    <span class="sa">f</span><span class="s2">&quot;Generic alias </span><span class="si">{</span><span class="n">argument</span><span class="si">}</span><span class="s2"> requires an argument&quot;</span>
</span><span data-line="1822">                <span class="p">)</span>
</span><span data-line="1823">        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="s2">&quot;__forward_arg__&quot;</span><span class="p">):</span>
</span><span data-line="1824">            <span class="n">argument</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">__forward_arg__</span>
</span><span data-line="1825">
</span><span data-line="1826">            <span class="n">argument</span> <span class="o">=</span> <span class="n">resolve_name_to_real_class_name</span><span class="p">(</span>
</span><span data-line="1827">                <span class="n">argument</span><span class="p">,</span> <span class="n">originating_module</span>
</span><span data-line="1828">            <span class="p">)</span>
</span><span data-line="1829">
</span><span data-line="1830">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1831">            <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1832">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_write_only</span>
</span><span data-line="1833">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_dynamic</span>
</span><span data-line="1834">        <span class="p">):</span>
</span><span data-line="1835">            <span class="bp">self</span><span class="o">.</span><span class="n">uselist</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1836">
</span><span data-line="1837">        <span class="c1"># ticket #8759</span>
</span><span data-line="1838">        <span class="c1"># if a lead argument was given to relationship(), like</span>
</span><span data-line="1839">        <span class="c1"># `relationship(&quot;B&quot;)`, use that, don&#39;t replace it with class we</span>
</span><span data-line="1840">        <span class="c1"># found in the annotation.  The declarative_scan() method call here is</span>
</span><span data-line="1841">        <span class="c1"># still useful, as we continue to derive collection type and do</span>
</span><span data-line="1842">        <span class="c1"># checking of the annotation in any case.</span>
</span><span data-line="1843">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1844">            <span class="bp">self</span><span class="o">.</span><span class="n">argument</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_RelationshipArgumentType[_T]&quot;</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
</span><span data-line="1845">
</span><span data-line="1846">    <span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.mapper&quot;</span><span class="p">)</span>
</span><span data-line="1847">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__argument</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1848">        <span class="k">if</span> <span class="s2">&quot;entity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="1849">            <span class="k">return</span>
</span><span data-line="1850">
</span><span data-line="1851">        <span class="n">mapperlib</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_mapper</span>
</span><span data-line="1852">
</span><span data-line="1853">        <span class="k">if</span> <span class="n">__argument</span><span class="p">:</span>
</span><span data-line="1854">            <span class="n">argument</span> <span class="o">=</span> <span class="n">__argument</span>
</span><span data-line="1855">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1856">            <span class="n">argument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument</span>
</span><span data-line="1857">
</span><span data-line="1858">        <span class="n">resolved_argument</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1859">
</span><span data-line="1860">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="1861">            <span class="c1"># we might want to cleanup clsregistry API to make this</span>
</span><span data-line="1862">            <span class="c1"># more straightforward</span>
</span><span data-line="1863">            <span class="n">resolved_argument</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="1864">                <span class="s2">&quot;_ExternalEntityType[Any]&quot;</span><span class="p">,</span>
</span><span data-line="1865">                <span class="bp">self</span><span class="o">.</span><span class="n">_clsregistry_resolve_name</span><span class="p">(</span><span class="n">argument</span><span class="p">)(),</span>
</span><span data-line="1866">            <span class="p">)</span>
</span><span data-line="1867">        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="1868">            <span class="n">argument</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">Mapper</span><span class="p">)</span>
</span><span data-line="1869">        <span class="p">):</span>
</span><span data-line="1870">            <span class="n">resolved_argument</span> <span class="o">=</span> <span class="n">argument</span><span class="p">()</span>
</span><span data-line="1871">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1872">            <span class="n">resolved_argument</span> <span class="o">=</span> <span class="n">argument</span>
</span><span data-line="1873">
</span><span data-line="1874">        <span class="n">entity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1875">
</span><span data-line="1876">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved_argument</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span data-line="1877">            <span class="n">entity</span> <span class="o">=</span> <span class="n">class_mapper</span><span class="p">(</span><span class="n">resolved_argument</span><span class="p">,</span> <span class="n">configure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="1878">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1879">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1880">                <span class="n">entity</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">resolved_argument</span><span class="p">)</span>
</span><span data-line="1881">            <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span><span class="p">:</span>
</span><span data-line="1882">                <span class="n">entity</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1883">
</span><span data-line="1884">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s2">&quot;mapper&quot;</span><span class="p">):</span>
</span><span data-line="1885">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1886">                    <span class="s2">&quot;relationship &#39;</span><span class="si">%s</span><span class="s2">&#39; expects &quot;</span>
</span><span data-line="1887">                    <span class="s2">&quot;a class or a mapper argument (received: </span><span class="si">%s</span><span class="s2">)&quot;</span>
</span><span data-line="1888">                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">resolved_argument</span><span class="p">))</span>
</span><span data-line="1889">                <span class="p">)</span>
</span><span data-line="1890">
</span><span data-line="1891">        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
</span><span data-line="1892">        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">persist_selectable</span>
</span><span data-line="1893">
</span><span data-line="1894">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_join_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1895">        <span class="bp">self</span><span class="o">.</span><span class="n">_join_condition</span> <span class="o">=</span> <span class="n">jc</span> <span class="o">=</span> <span class="n">JoinCondition</span><span class="p">(</span>
</span><span data-line="1896">            <span class="n">parent_persist_selectable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">persist_selectable</span><span class="p">,</span>
</span><span data-line="1897">            <span class="n">child_persist_selectable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">persist_selectable</span><span class="p">,</span>
</span><span data-line="1898">            <span class="n">parent_local_selectable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span>
</span><span data-line="1899">            <span class="n">child_local_selectable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span>
</span><span data-line="1900">            <span class="n">primaryjoin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_args</span><span class="o">.</span><span class="n">primaryjoin</span><span class="o">.</span><span class="n">resolved</span><span class="p">,</span>
</span><span data-line="1901">            <span class="n">secondary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_args</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">resolved</span><span class="p">,</span>
</span><span data-line="1902">            <span class="n">secondaryjoin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_args</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="o">.</span><span class="n">resolved</span><span class="p">,</span>
</span><span data-line="1903">            <span class="n">parent_equivalents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_equivalent_columns</span><span class="p">,</span>
</span><span data-line="1904">            <span class="n">child_equivalents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_equivalent_columns</span><span class="p">,</span>
</span><span data-line="1905">            <span class="n">consider_as_foreign_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_defined_foreign_keys</span><span class="p">,</span>
</span><span data-line="1906">            <span class="n">local_remote_pairs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">,</span>
</span><span data-line="1907">            <span class="n">remote_side</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_side</span><span class="p">,</span>
</span><span data-line="1908">            <span class="n">self_referential</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_self_referential</span><span class="p">,</span>
</span><span data-line="1909">            <span class="n">prop</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span data-line="1910">            <span class="n">support_sync</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewonly</span><span class="p">,</span>
</span><span data-line="1911">            <span class="n">can_be_synced_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns_are_mapped</span><span class="p">,</span>
</span><span data-line="1912">        <span class="p">)</span>
</span><span data-line="1913">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">primaryjoin</span>
</span><span data-line="1914">        <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">secondaryjoin</span>
</span><span data-line="1915">        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">secondary</span>
</span><span data-line="1916">        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">direction</span>
</span><span data-line="1917">        <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">local_remote_pairs</span>
</span><span data-line="1918">        <span class="bp">self</span><span class="o">.</span><span class="n">remote_side</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">remote_columns</span>
</span><span data-line="1919">        <span class="bp">self</span><span class="o">.</span><span class="n">local_columns</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">local_columns</span>
</span><span data-line="1920">        <span class="bp">self</span><span class="o">.</span><span class="n">synchronize_pairs</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">synchronize_pairs</span>
</span><span data-line="1921">        <span class="bp">self</span><span class="o">.</span><span class="n">_calculated_foreign_keys</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">foreign_key_columns</span>
</span><span data-line="1922">        <span class="bp">self</span><span class="o">.</span><span class="n">secondary_synchronize_pairs</span> <span class="o">=</span> <span class="n">jc</span><span class="o">.</span><span class="n">secondary_synchronize_pairs</span>
</span><span data-line="1923">
</span><span data-line="1924">    <span class="nd">@property</span>
</span><span data-line="1925">    <span class="k">def</span><span class="w"> </span><span class="nf">_clsregistry_resolve_arg</span><span class="p">(</span>
</span><span data-line="1926">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1927">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">_class_resolver</span><span class="p">]:</span>
</span><span data-line="1928">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clsregistry_resolvers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="1929">
</span><span data-line="1930">    <span class="nd">@property</span>
</span><span data-line="1931">    <span class="k">def</span><span class="w"> </span><span class="nf">_clsregistry_resolve_name</span><span class="p">(</span>
</span><span data-line="1932">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1933">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Table</span><span class="p">,</span> <span class="n">_ModNS</span><span class="p">]]]:</span>
</span><span data-line="1934">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clsregistry_resolvers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1935">
</span><span data-line="1936">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="1937">    <span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.clsregistry&quot;</span><span class="p">)</span>
</span><span data-line="1938">    <span class="k">def</span><span class="w"> </span><span class="nf">_clsregistry_resolvers</span><span class="p">(</span>
</span><span data-line="1939">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1940">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
</span><span data-line="1941">        <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Table</span><span class="p">,</span> <span class="n">_ModNS</span><span class="p">]]],</span>
</span><span data-line="1942">        <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">_class_resolver</span><span class="p">],</span>
</span><span data-line="1943">    <span class="p">]:</span>
</span><span data-line="1944">        <span class="n">_resolver</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_clsregistry</span><span class="o">.</span><span class="n">_resolver</span>
</span><span data-line="1945">
</span><span data-line="1946">        <span class="k">return</span> <span class="n">_resolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="1947">
</span><span data-line="1948">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1949"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that this relationship is legal, warn about</span>
</span><span data-line="1950"><span class="sd">        inheritance conflicts.&quot;&quot;&quot;</span>
</span><span data-line="1951">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">non_primary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">class_mapper</span><span class="p">(</span>
</span><span data-line="1952">            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">configure</span><span class="o">=</span><span class="kc">False</span>
</span><span data-line="1953">        <span class="p">)</span><span class="o">.</span><span class="n">has_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
</span><span data-line="1954">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1955">                <span class="s2">&quot;Attempting to assign a new &quot;</span>
</span><span data-line="1956">                <span class="s2">&quot;relationship &#39;</span><span class="si">%s</span><span class="s2">&#39; to a non-primary mapper on &quot;</span>
</span><span data-line="1957">                <span class="s2">&quot;class &#39;</span><span class="si">%s</span><span class="s2">&#39;.  New relationships can only be added &quot;</span>
</span><span data-line="1958">                <span class="s2">&quot;to the primary mapper, i.e. the very first mapper &quot;</span>
</span><span data-line="1959">                <span class="s2">&quot;created for class &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
</span><span data-line="1960">                <span class="o">%</span> <span class="p">(</span>
</span><span data-line="1961">                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="1962">                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="1963">                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="1964">                <span class="p">)</span>
</span><span data-line="1965">            <span class="p">)</span>
</span><span data-line="1966">
</span><span data-line="1967">    <span class="nd">@property</span>
</span><span data-line="1968">    <span class="k">def</span><span class="w"> </span><span class="nf">cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CascadeOptions</span><span class="p">:</span>
</span><span data-line="1969"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current cascade setting for this</span>
</span><span data-line="1970"><span class="sd">        :class:`.RelationshipProperty`.</span>
</span><span data-line="1971"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1972">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cascade</span>
</span><span data-line="1973">
</span><span data-line="1974">    <span class="nd">@cascade</span><span class="o">.</span><span class="n">setter</span>
</span><span data-line="1975">    <span class="k">def</span><span class="w"> </span><span class="nf">cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CascadeOptions</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1976">        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cascade</span><span class="p">(</span><span class="n">cascade</span><span class="p">)</span>
</span><span data-line="1977">
</span><span data-line="1978">    <span class="k">def</span><span class="w"> </span><span class="nf">_set_cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade_arg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CascadeOptions</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1979">        <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeOptions</span><span class="p">(</span><span class="n">cascade_arg</span><span class="p">)</span>
</span><span data-line="1980">
</span><span data-line="1981">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewonly</span><span class="p">:</span>
</span><span data-line="1982">            <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeOptions</span><span class="p">(</span>
</span><span data-line="1983">                <span class="n">cascade</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">CascadeOptions</span><span class="o">.</span><span class="n">_viewonly_cascades</span><span class="p">)</span>
</span><span data-line="1984">            <span class="p">)</span>
</span><span data-line="1985">
</span><span data-line="1986">        <span class="k">if</span> <span class="s2">&quot;mapper&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="1987">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_cascade_settings</span><span class="p">(</span><span class="n">cascade</span><span class="p">)</span>
</span><span data-line="1988">        <span class="bp">self</span><span class="o">.</span><span class="n">_cascade</span> <span class="o">=</span> <span class="n">cascade</span>
</span><span data-line="1989">
</span><span data-line="1990">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_processor</span><span class="p">:</span>
</span><span data-line="1991">            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_processor</span><span class="o">.</span><span class="n">cascade</span> <span class="o">=</span> <span class="n">cascade</span>
</span><span data-line="1992">
</span><span data-line="1993">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_cascade_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade</span><span class="p">:</span> <span class="n">CascadeOptions</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1994">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1995">            <span class="n">cascade</span><span class="o">.</span><span class="n">delete_orphan</span>
</span><span data-line="1996">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_parent</span>
</span><span data-line="1997">            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="n">MANYTOMANY</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="n">MANYTOONE</span><span class="p">)</span>
</span><span data-line="1998">        <span class="p">):</span>
</span><span data-line="1999">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2000">                <span class="s2">&quot;For </span><span class="si">%(direction)s</span><span class="s2"> relationship </span><span class="si">%(rel)s</span><span class="s2">, delete-orphan &quot;</span>
</span><span data-line="2001">                <span class="s2">&quot;cascade is normally &quot;</span>
</span><span data-line="2002">                <span class="s1">&#39;configured only on the &quot;one&quot; side of a one-to-many &#39;</span>
</span><span data-line="2003">                <span class="s2">&quot;relationship, &quot;</span>
</span><span data-line="2004">                <span class="s1">&#39;and not on the &quot;many&quot; side of a many-to-one or many-to-many &#39;</span>
</span><span data-line="2005">                <span class="s2">&quot;relationship.  &quot;</span>
</span><span data-line="2006">                <span class="s2">&quot;To force this relationship to allow a particular &quot;</span>
</span><span data-line="2007">                <span class="s1">&#39;&quot;</span><span class="si">%(relatedcls)s</span><span class="s1">&quot; object to be referenced by only &#39;</span>
</span><span data-line="2008">                <span class="s1">&#39;a single &quot;</span><span class="si">%(clsname)s</span><span class="s1">&quot; object at a time via the &#39;</span>
</span><span data-line="2009">                <span class="s2">&quot;</span><span class="si">%(rel)s</span><span class="s2"> relationship, which &quot;</span>
</span><span data-line="2010">                <span class="s2">&quot;would allow &quot;</span>
</span><span data-line="2011">                <span class="s2">&quot;delete-orphan cascade to take place in this direction, set &quot;</span>
</span><span data-line="2012">                <span class="s2">&quot;the single_parent=True flag.&quot;</span>
</span><span data-line="2013">                <span class="o">%</span> <span class="p">{</span>
</span><span data-line="2014">                    <span class="s2">&quot;rel&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2015">                    <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span data-line="2016">                        <span class="s2">&quot;many-to-one&quot;</span>
</span><span data-line="2017">                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="n">MANYTOONE</span>
</span><span data-line="2018">                        <span class="k">else</span> <span class="s2">&quot;many-to-many&quot;</span>
</span><span data-line="2019">                    <span class="p">),</span>
</span><span data-line="2020">                    <span class="s2">&quot;clsname&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="2021">                    <span class="s2">&quot;relatedcls&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="2022">                <span class="p">},</span>
</span><span data-line="2023">                <span class="n">code</span><span class="o">=</span><span class="s2">&quot;bbf0&quot;</span><span class="p">,</span>
</span><span data-line="2024">            <span class="p">)</span>
</span><span data-line="2025">
</span><span data-line="2026">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passive_deletes</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="2027">            <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">cascade</span> <span class="ow">or</span> <span class="s2">&quot;delete-orphan&quot;</span> <span class="ow">in</span> <span class="n">cascade</span>
</span><span data-line="2028">        <span class="p">):</span>
</span><span data-line="2029">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2030">                <span class="s2">&quot;On </span><span class="si">%s</span><span class="s2">, can&#39;t set passive_deletes=&#39;all&#39; in conjunction &quot;</span>
</span><span data-line="2031">                <span class="s2">&quot;with &#39;delete&#39; or &#39;delete-orphan&#39; cascade&quot;</span> <span class="o">%</span> <span class="bp">self</span>
</span><span data-line="2032">            <span class="p">)</span>
</span><span data-line="2033">
</span><span data-line="2034">        <span class="k">if</span> <span class="n">cascade</span><span class="o">.</span><span class="n">delete_orphan</span><span class="p">:</span>
</span><span data-line="2035">            <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">primary_mapper</span><span class="p">()</span><span class="o">.</span><span class="n">_delete_orphans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="2036">                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>
</span><span data-line="2037">            <span class="p">)</span>
</span><span data-line="2038">
</span><span data-line="2039">    <span class="k">def</span><span class="w"> </span><span class="nf">_persists_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2040"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this property will persist values on behalf</span>
</span><span data-line="2041"><span class="sd">        of the given mapper.</span>
</span><span data-line="2042">
</span><span data-line="2043"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2044">
</span><span data-line="2045">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="2046">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">relationships</span>
</span><span data-line="2047">            <span class="ow">and</span> <span class="n">mapper</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">self</span>
</span><span data-line="2048">        <span class="p">)</span>
</span><span data-line="2049">
</span><span data-line="2050">    <span class="k">def</span><span class="w"> </span><span class="nf">_columns_are_mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">cols</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2051"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if all columns in the given collection are</span>
</span><span data-line="2052"><span class="sd">        mapped by the tables referenced by this :class:`.RelationshipProperty`.</span>
</span><span data-line="2053">
</span><span data-line="2054"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2055">
</span><span data-line="2056">        <span class="n">secondary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_args</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">resolved</span>
</span><span data-line="2057">        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
</span><span data-line="2058">            <span class="k">if</span> <span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">secondary</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span data-line="2059">                <span class="k">continue</span>
</span><span data-line="2060">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span>
</span><span data-line="2061">                <span class="n">c</span>
</span><span data-line="2062">            <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span data-line="2063">                <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="2064">        <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="2065">
</span><span data-line="2066">    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_backref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2067"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpret the &#39;backref&#39; instruction to create a</span>
</span><span data-line="2068"><span class="sd">        :func:`_orm.relationship` complementary to this one.&quot;&quot;&quot;</span>
</span><span data-line="2069">
</span><span data-line="2070">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">non_primary</span><span class="p">:</span>
</span><span data-line="2071">            <span class="k">return</span>
</span><span data-line="2072">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_populates</span><span class="p">:</span>
</span><span data-line="2073">            <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="2074">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="2075">                <span class="n">backref_key</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">,</span> <span class="p">{}</span>
</span><span data-line="2076">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2077">                <span class="n">backref_key</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span>
</span><span data-line="2078">            <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">primary_mapper</span><span class="p">()</span>
</span><span data-line="2079">
</span><span data-line="2080">            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
</span><span data-line="2081">                <span class="n">check</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span data-line="2082">                    <span class="n">mapper</span><span class="o">.</span><span class="n">self_and_descendants</span>
</span><span data-line="2083">                <span class="p">)</span>
</span><span data-line="2084">                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
</span><span data-line="2085">                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">has_property</span><span class="p">(</span><span class="n">backref_key</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
</span><span data-line="2086">                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2087">                            <span class="s2">&quot;Error creating backref &quot;</span>
</span><span data-line="2088">                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; on relationship &#39;</span><span class="si">%s</span><span class="s2">&#39;: property of that &quot;</span>
</span><span data-line="2089">                            <span class="s2">&quot;name exists on mapper &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
</span><span data-line="2090">                            <span class="o">%</span> <span class="p">(</span><span class="n">backref_key</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</span><span data-line="2091">                        <span class="p">)</span>
</span><span data-line="2092">
</span><span data-line="2093">            <span class="c1"># determine primaryjoin/secondaryjoin for the</span>
</span><span data-line="2094">            <span class="c1"># backref.  Use the one we had, so that</span>
</span><span data-line="2095">            <span class="c1"># a custom join doesn&#39;t have to be specified in</span>
</span><span data-line="2096">            <span class="c1"># both directions.</span>
</span><span data-line="2097">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2098">                <span class="c1"># for many to many, just switch primaryjoin/</span>
</span><span data-line="2099">                <span class="c1"># secondaryjoin.   use the annotated</span>
</span><span data-line="2100">                <span class="c1"># pj/sj on the _join_condition.</span>
</span><span data-line="2101">                <span class="n">pj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span data-line="2102">                    <span class="s2">&quot;primaryjoin&quot;</span><span class="p">,</span>
</span><span data-line="2103">                    <span class="bp">self</span><span class="o">.</span><span class="n">_join_condition</span><span class="o">.</span><span class="n">secondaryjoin_minus_local</span><span class="p">,</span>
</span><span data-line="2104">                <span class="p">)</span>
</span><span data-line="2105">                <span class="n">sj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span data-line="2106">                    <span class="s2">&quot;secondaryjoin&quot;</span><span class="p">,</span>
</span><span data-line="2107">                    <span class="bp">self</span><span class="o">.</span><span class="n">_join_condition</span><span class="o">.</span><span class="n">primaryjoin_minus_local</span><span class="p">,</span>
</span><span data-line="2108">                <span class="p">)</span>
</span><span data-line="2109">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2110">                <span class="n">pj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span data-line="2111">                    <span class="s2">&quot;primaryjoin&quot;</span><span class="p">,</span>
</span><span data-line="2112">                    <span class="bp">self</span><span class="o">.</span><span class="n">_join_condition</span><span class="o">.</span><span class="n">primaryjoin_reverse_remote</span><span class="p">,</span>
</span><span data-line="2113">                <span class="p">)</span>
</span><span data-line="2114">                <span class="n">sj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;secondaryjoin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2115">                <span class="k">if</span> <span class="n">sj</span><span class="p">:</span>
</span><span data-line="2116">                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="2117">                        <span class="s2">&quot;Can&#39;t assign &#39;secondaryjoin&#39; on a backref &quot;</span>
</span><span data-line="2118">                        <span class="s2">&quot;against a non-secondary relationship.&quot;</span>
</span><span data-line="2119">                    <span class="p">)</span>
</span><span data-line="2120">
</span><span data-line="2121">            <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span data-line="2122">                <span class="s2">&quot;foreign_keys&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_defined_foreign_keys</span>
</span><span data-line="2123">            <span class="p">)</span>
</span><span data-line="2124">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">primary_mapper</span><span class="p">()</span>
</span><span data-line="2125">            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;viewonly&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewonly</span><span class="p">)</span>
</span><span data-line="2126">            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;post_update&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_update</span><span class="p">)</span>
</span><span data-line="2127">            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;passive_updates&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passive_updates</span><span class="p">)</span>
</span><span data-line="2128">            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;sync_backref&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_backref</span><span class="p">)</span>
</span><span data-line="2129">            <span class="bp">self</span><span class="o">.</span><span class="n">back_populates</span> <span class="o">=</span> <span class="n">backref_key</span>
</span><span data-line="2130">            <span class="n">relationship</span> <span class="o">=</span> <span class="n">RelationshipProperty</span><span class="p">(</span>
</span><span data-line="2131">                <span class="n">parent</span><span class="p">,</span>
</span><span data-line="2132">                <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span>
</span><span data-line="2133">                <span class="n">primaryjoin</span><span class="o">=</span><span class="n">pj</span><span class="p">,</span>
</span><span data-line="2134">                <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">sj</span><span class="p">,</span>
</span><span data-line="2135">                <span class="n">foreign_keys</span><span class="o">=</span><span class="n">foreign_keys</span><span class="p">,</span>
</span><span data-line="2136">                <span class="n">back_populates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="2137">                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="2138">            <span class="p">)</span>
</span><span data-line="2139">            <span class="n">mapper</span><span class="o">.</span><span class="n">_configure_property</span><span class="p">(</span>
</span><span data-line="2140">                <span class="n">backref_key</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">warn_for_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="2141">            <span class="p">)</span>
</span><span data-line="2142">
</span><span data-line="2143">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_populates</span><span class="p">:</span>
</span><span data-line="2144">            <span class="bp">self</span><span class="o">.</span><span class="n">_add_reverse_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">back_populates</span><span class="p">)</span>
</span><span data-line="2145">
</span><span data-line="2146">    <span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.dependency&quot;</span><span class="p">)</span>
</span><span data-line="2147">    <span class="k">def</span><span class="w"> </span><span class="nf">_post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2148">        <span class="n">dependency</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_dependency</span>
</span><span data-line="2149">
</span><span data-line="2150">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uselist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2151">            <span class="bp">self</span><span class="o">.</span><span class="n">uselist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MANYTOONE</span>
</span><span data-line="2152">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewonly</span><span class="p">:</span>
</span><span data-line="2153">            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_processor</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># type: ignore</span>
</span><span data-line="2154">                <span class="n">dependency</span><span class="o">.</span><span class="n">DependencyProcessor</span><span class="o">.</span><span class="n">from_relationship</span>
</span><span data-line="2155">            <span class="p">)(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="2156">
</span><span data-line="2157">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="2158">    <span class="k">def</span><span class="w"> </span><span class="nf">_use_get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2159"><span class="w">        </span><span class="sd">&quot;&quot;&quot;memoize the &#39;use_get&#39; attribute of this RelationshipLoader&#39;s</span>
</span><span data-line="2160"><span class="sd">        lazyloader.&quot;&quot;&quot;</span>
</span><span data-line="2161">
</span><span data-line="2162">        <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_strategy</span>
</span><span data-line="2163">        <span class="k">return</span> <span class="n">strategy</span><span class="o">.</span><span class="n">use_get</span>
</span><span data-line="2164">
</span><span data-line="2165">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="2166">    <span class="k">def</span><span class="w"> </span><span class="nf">_is_self_referential</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2167">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">common_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span data-line="2168">
</span><span data-line="2169">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_joins</span><span class="p">(</span>
</span><span data-line="2170">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2171">        <span class="n">source_polymorphic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2172">        <span class="n">source_selectable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2173">        <span class="n">dest_selectable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2174">        <span class="n">of_type_entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2175">        <span class="n">alias_secondary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2176">        <span class="n">extra_criteria</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
</span><span data-line="2177">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
</span><span data-line="2178">        <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span data-line="2179">        <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]],</span>
</span><span data-line="2180">        <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="2181">        <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="2182">        <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="2183">        <span class="n">Optional</span><span class="p">[</span><span class="n">ClauseAdapter</span><span class="p">],</span>
</span><span data-line="2184">    <span class="p">]:</span>
</span><span data-line="2185">        <span class="n">aliased</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="2186">
</span><span data-line="2187">        <span class="k">if</span> <span class="n">alias_secondary</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2188">            <span class="n">aliased</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2189">
</span><span data-line="2190">        <span class="k">if</span> <span class="n">source_selectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2191">            <span class="k">if</span> <span class="n">source_polymorphic</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">:</span>
</span><span data-line="2192">                <span class="n">source_selectable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_with_polymorphic_selectable</span>
</span><span data-line="2193">
</span><span data-line="2194">        <span class="k">if</span> <span class="n">of_type_entity</span><span class="p">:</span>
</span><span data-line="2195">            <span class="n">dest_mapper</span> <span class="o">=</span> <span class="n">of_type_entity</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="2196">            <span class="k">if</span> <span class="n">dest_selectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2197">                <span class="n">dest_selectable</span> <span class="o">=</span> <span class="n">of_type_entity</span><span class="o">.</span><span class="n">selectable</span>
</span><span data-line="2198">                <span class="n">aliased</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2199">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2200">            <span class="n">dest_mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="2201">
</span><span data-line="2202">        <span class="k">if</span> <span class="n">dest_selectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2203">            <span class="n">dest_selectable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">selectable</span>
</span><span data-line="2204">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">:</span>
</span><span data-line="2205">                <span class="n">aliased</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2206">
</span><span data-line="2207">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_self_referential</span> <span class="ow">and</span> <span class="n">source_selectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2208">                <span class="n">dest_selectable</span> <span class="o">=</span> <span class="n">dest_selectable</span><span class="o">.</span><span class="n">_anonymous_fromclause</span><span class="p">()</span>
</span><span data-line="2209">                <span class="n">aliased</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2210">        <span class="k">elif</span> <span class="p">(</span>
</span><span data-line="2211">            <span class="n">dest_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_with_polymorphic_selectable</span>
</span><span data-line="2212">            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">with_polymorphic</span>
</span><span data-line="2213">        <span class="p">):</span>
</span><span data-line="2214">            <span class="n">aliased</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2215">
</span><span data-line="2216">        <span class="n">single_crit</span> <span class="o">=</span> <span class="n">dest_mapper</span><span class="o">.</span><span class="n">_single_table_criterion</span>
</span><span data-line="2217">        <span class="n">aliased</span> <span class="o">=</span> <span class="n">aliased</span> <span class="ow">or</span> <span class="p">(</span>
</span><span data-line="2218">            <span class="n">source_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2219">            <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="2220">                <span class="n">source_selectable</span>
</span><span data-line="2221">                <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_with_polymorphic_selectable</span>
</span><span data-line="2222">                <span class="ow">or</span> <span class="n">source_selectable</span><span class="o">.</span><span class="n">_is_subquery</span>
</span><span data-line="2223">            <span class="p">)</span>
</span><span data-line="2224">        <span class="p">)</span>
</span><span data-line="2225">
</span><span data-line="2226">        <span class="p">(</span>
</span><span data-line="2227">            <span class="n">primaryjoin</span><span class="p">,</span>
</span><span data-line="2228">            <span class="n">secondaryjoin</span><span class="p">,</span>
</span><span data-line="2229">            <span class="n">secondary</span><span class="p">,</span>
</span><span data-line="2230">            <span class="n">target_adapter</span><span class="p">,</span>
</span><span data-line="2231">            <span class="n">dest_selectable</span><span class="p">,</span>
</span><span data-line="2232">        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_condition</span><span class="o">.</span><span class="n">join_targets</span><span class="p">(</span>
</span><span data-line="2233">            <span class="n">source_selectable</span><span class="p">,</span>
</span><span data-line="2234">            <span class="n">dest_selectable</span><span class="p">,</span>
</span><span data-line="2235">            <span class="n">aliased</span><span class="p">,</span>
</span><span data-line="2236">            <span class="n">single_crit</span><span class="p">,</span>
</span><span data-line="2237">            <span class="n">extra_criteria</span><span class="p">,</span>
</span><span data-line="2238">        <span class="p">)</span>
</span><span data-line="2239">        <span class="k">if</span> <span class="n">source_selectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2240">            <span class="n">source_selectable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">local_table</span>
</span><span data-line="2241">        <span class="k">if</span> <span class="n">dest_selectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2242">            <span class="n">dest_selectable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">local_table</span>
</span><span data-line="2243">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="2244">            <span class="n">primaryjoin</span><span class="p">,</span>
</span><span data-line="2245">            <span class="n">secondaryjoin</span><span class="p">,</span>
</span><span data-line="2246">            <span class="n">source_selectable</span><span class="p">,</span>
</span><span data-line="2247">            <span class="n">dest_selectable</span><span class="p">,</span>
</span><span data-line="2248">            <span class="n">secondary</span><span class="p">,</span>
</span><span data-line="2249">            <span class="n">target_adapter</span><span class="p">,</span>
</span><span data-line="2250">        <span class="p">)</span>
</span><span data-line="2251">
</span><span data-line="2252">
</span><span data-line="2253"><span class="k">def</span><span class="w"> </span><span class="nf">_annotate_columns</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="n">annotations</span><span class="p">:</span> <span class="n">_AnnotationDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_CE</span><span class="p">:</span>
</span><span data-line="2254">    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">_CE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_CE</span><span class="p">:</span>
</span><span data-line="2255">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">):</span>
</span><span data-line="2256">            <span class="n">elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">_annotate</span><span class="p">(</span><span class="n">annotations</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>  <span class="c1"># type: ignore</span>
</span><span data-line="2257">        <span class="n">elem</span><span class="o">.</span><span class="n">_copy_internals</span><span class="p">(</span><span class="n">clone</span><span class="o">=</span><span class="n">clone</span><span class="p">)</span>
</span><span data-line="2258">        <span class="k">return</span> <span class="n">elem</span>
</span><span data-line="2259">
</span><span data-line="2260">    <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2261">        <span class="n">element</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span data-line="2262">    <span class="n">clone</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore # remove gc cycles</span>
</span><span data-line="2263">    <span class="k">return</span> <span class="n">element</span>
</span><span data-line="2264">
</span><span data-line="2265">
</span><span data-line="2266"><span class="k">class</span><span class="w"> </span><span class="nc">JoinCondition</span><span class="p">:</span>
</span><span data-line="2267">    <span class="n">primaryjoin_initial</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span>
</span><span data-line="2268">    <span class="n">primaryjoin</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
</span><span data-line="2269">    <span class="n">secondaryjoin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span>
</span><span data-line="2270">    <span class="n">secondary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span data-line="2271">    <span class="n">prop</span><span class="p">:</span> <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="2272">
</span><span data-line="2273">    <span class="n">synchronize_pairs</span><span class="p">:</span> <span class="n">_ColumnPairs</span>
</span><span data-line="2274">    <span class="n">secondary_synchronize_pairs</span><span class="p">:</span> <span class="n">_ColumnPairs</span>
</span><span data-line="2275">    <span class="n">direction</span><span class="p">:</span> <span class="n">RelationshipDirection</span>
</span><span data-line="2276">
</span><span data-line="2277">    <span class="n">parent_persist_selectable</span><span class="p">:</span> <span class="n">FromClause</span>
</span><span data-line="2278">    <span class="n">child_persist_selectable</span><span class="p">:</span> <span class="n">FromClause</span>
</span><span data-line="2279">    <span class="n">parent_local_selectable</span><span class="p">:</span> <span class="n">FromClause</span>
</span><span data-line="2280">    <span class="n">child_local_selectable</span><span class="p">:</span> <span class="n">FromClause</span>
</span><span data-line="2281">
</span><span data-line="2282">    <span class="n">_local_remote_pairs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnPairs</span><span class="p">]</span>
</span><span data-line="2283">
</span><span data-line="2284">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="2285">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2286">        <span class="n">parent_persist_selectable</span><span class="p">:</span> <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="2287">        <span class="n">child_persist_selectable</span><span class="p">:</span> <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="2288">        <span class="n">parent_local_selectable</span><span class="p">:</span> <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="2289">        <span class="n">child_local_selectable</span><span class="p">:</span> <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="2290">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2291">        <span class="n">primaryjoin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2292">        <span class="n">secondary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2293">        <span class="n">secondaryjoin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2294">        <span class="n">parent_equivalents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EquivalentColumnMap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2295">        <span class="n">child_equivalents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EquivalentColumnMap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2296">        <span class="n">consider_as_foreign_keys</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2297">        <span class="n">local_remote_pairs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnPairs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2298">        <span class="n">remote_side</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2299">        <span class="n">self_referential</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2300">        <span class="n">prop</span><span class="p">:</span> <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2301">        <span class="n">support_sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2302">        <span class="n">can_be_synced_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">c</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2303">    <span class="p">):</span>
</span><span data-line="2304">        <span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span> <span class="o">=</span> <span class="n">parent_persist_selectable</span>
</span><span data-line="2305">        <span class="bp">self</span><span class="o">.</span><span class="n">parent_local_selectable</span> <span class="o">=</span> <span class="n">parent_local_selectable</span>
</span><span data-line="2306">        <span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span> <span class="o">=</span> <span class="n">child_persist_selectable</span>
</span><span data-line="2307">        <span class="bp">self</span><span class="o">.</span><span class="n">child_local_selectable</span> <span class="o">=</span> <span class="n">child_local_selectable</span>
</span><span data-line="2308">        <span class="bp">self</span><span class="o">.</span><span class="n">parent_equivalents</span> <span class="o">=</span> <span class="n">parent_equivalents</span>
</span><span data-line="2309">        <span class="bp">self</span><span class="o">.</span><span class="n">child_equivalents</span> <span class="o">=</span> <span class="n">child_equivalents</span>
</span><span data-line="2310">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin_initial</span> <span class="o">=</span> <span class="n">primaryjoin</span>
</span><span data-line="2311">        <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">secondaryjoin</span>
</span><span data-line="2312">        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="n">secondary</span>
</span><span data-line="2313">        <span class="bp">self</span><span class="o">.</span><span class="n">consider_as_foreign_keys</span> <span class="o">=</span> <span class="n">consider_as_foreign_keys</span>
</span><span data-line="2314">        <span class="bp">self</span><span class="o">.</span><span class="n">_local_remote_pairs</span> <span class="o">=</span> <span class="n">local_remote_pairs</span>
</span><span data-line="2315">        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_side</span> <span class="o">=</span> <span class="n">remote_side</span>
</span><span data-line="2316">        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>
</span><span data-line="2317">        <span class="bp">self</span><span class="o">.</span><span class="n">self_referential</span> <span class="o">=</span> <span class="n">self_referential</span>
</span><span data-line="2318">        <span class="bp">self</span><span class="o">.</span><span class="n">support_sync</span> <span class="o">=</span> <span class="n">support_sync</span>
</span><span data-line="2319">        <span class="bp">self</span><span class="o">.</span><span class="n">can_be_synced_fn</span> <span class="o">=</span> <span class="n">can_be_synced_fn</span>
</span><span data-line="2320">
</span><span data-line="2321">        <span class="bp">self</span><span class="o">.</span><span class="n">_determine_joins</span><span class="p">()</span>
</span><span data-line="2322">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2323">
</span><span data-line="2324">        <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_joins</span><span class="p">()</span>
</span><span data-line="2325">        <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_fks</span><span class="p">()</span>
</span><span data-line="2326">        <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_remote</span><span class="p">()</span>
</span><span data-line="2327">        <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_local</span><span class="p">()</span>
</span><span data-line="2328">        <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_parentmapper</span><span class="p">()</span>
</span><span data-line="2329">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_pairs</span><span class="p">()</span>
</span><span data-line="2330">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_foreign_cols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="2331">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2332">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_foreign_cols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="2333">        <span class="bp">self</span><span class="o">.</span><span class="n">_determine_direction</span><span class="p">()</span>
</span><span data-line="2334">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_remote_side</span><span class="p">()</span>
</span><span data-line="2335">        <span class="bp">self</span><span class="o">.</span><span class="n">_log_joins</span><span class="p">()</span>
</span><span data-line="2336">
</span><span data-line="2337">    <span class="k">def</span><span class="w"> </span><span class="nf">_log_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2338">        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">logger</span>
</span><span data-line="2339">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> setup primary join </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">)</span>
</span><span data-line="2340">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> setup secondary join </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">)</span>
</span><span data-line="2341">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="2342">            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> synchronize pairs [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span data-line="2343">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="2344">            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span data-line="2345">                <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchronize_pairs</span>
</span><span data-line="2346">            <span class="p">),</span>
</span><span data-line="2347">        <span class="p">)</span>
</span><span data-line="2348">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="2349">            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> secondary synchronize pairs [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span data-line="2350">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="2351">            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span data-line="2352">                <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span data-line="2353">                <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary_synchronize_pairs</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span data-line="2354">            <span class="p">),</span>
</span><span data-line="2355">        <span class="p">)</span>
</span><span data-line="2356">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="2357">            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> local/remote pairs [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span data-line="2358">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="2359">            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span data-line="2360">                <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> / </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span>
</span><span data-line="2361">            <span class="p">),</span>
</span><span data-line="2362">        <span class="p">)</span>
</span><span data-line="2363">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="2364">            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> remote columns [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span data-line="2365">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="2366">            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_columns</span><span class="p">),</span>
</span><span data-line="2367">        <span class="p">)</span>
</span><span data-line="2368">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="2369">            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> local columns [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span data-line="2370">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="2371">            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_columns</span><span class="p">),</span>
</span><span data-line="2372">        <span class="p">)</span>
</span><span data-line="2373">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> relationship direction </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
</span><span data-line="2374">
</span><span data-line="2375">    <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2376"><span class="w">        </span><span class="sd">&quot;&quot;&quot;remove the parententity annotation from our join conditions which</span>
</span><span data-line="2377"><span class="sd">        can leak in here based on some declarative patterns and maybe others.</span>
</span><span data-line="2378">
</span><span data-line="2379"><span class="sd">        &quot;parentmapper&quot; is relied upon both by the ORM evaluator as well as</span>
</span><span data-line="2380"><span class="sd">        the use case in _join_fixture_inh_selfref_w_entity</span>
</span><span data-line="2381"><span class="sd">        that relies upon it being present, see :ticket:`3364`.</span>
</span><span data-line="2382">
</span><span data-line="2383"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2384">
</span><span data-line="2385">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">_deep_deannotate</span><span class="p">(</span>
</span><span data-line="2386">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;parententity&quot;</span><span class="p">,</span> <span class="s2">&quot;proxy_key&quot;</span><span class="p">)</span>
</span><span data-line="2387">        <span class="p">)</span>
</span><span data-line="2388">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2389">            <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">_deep_deannotate</span><span class="p">(</span>
</span><span data-line="2390">                <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;parententity&quot;</span><span class="p">,</span> <span class="s2">&quot;proxy_key&quot;</span><span class="p">)</span>
</span><span data-line="2391">            <span class="p">)</span>
</span><span data-line="2392">
</span><span data-line="2393">    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2394"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the &#39;primaryjoin&#39; and &#39;secondaryjoin&#39; attributes,</span>
</span><span data-line="2395"><span class="sd">        if not passed to the constructor already.</span>
</span><span data-line="2396">
</span><span data-line="2397"><span class="sd">        This is based on analysis of the foreign key relationships</span>
</span><span data-line="2398"><span class="sd">        between the parent and target mapped selectables.</span>
</span><span data-line="2399">
</span><span data-line="2400"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2401">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2402">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2403">                <span class="s2">&quot;Property </span><span class="si">%s</span><span class="s2"> specified with secondary &quot;</span>
</span><span data-line="2404">                <span class="s2">&quot;join condition but &quot;</span>
</span><span data-line="2405">                <span class="s2">&quot;no secondary argument&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
</span><span data-line="2406">            <span class="p">)</span>
</span><span data-line="2407">
</span><span data-line="2408">        <span class="c1"># find a join between the given mapper&#39;s mapped table and</span>
</span><span data-line="2409">        <span class="c1"># the given table. will try the mapper&#39;s local table first</span>
</span><span data-line="2410">        <span class="c1"># for more specificity, then if not found will try the more</span>
</span><span data-line="2411">        <span class="c1"># general mapped table, which in the case of inheritance is</span>
</span><span data-line="2412">        <span class="c1"># a join.</span>
</span><span data-line="2413">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="2414">            <span class="n">consider_as_foreign_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consider_as_foreign_keys</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span data-line="2415">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2416">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2417">                    <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">join_condition</span><span class="p">(</span>
</span><span data-line="2418">                        <span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span><span class="p">,</span>
</span><span data-line="2419">                        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span>
</span><span data-line="2420">                        <span class="n">a_subset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">child_local_selectable</span><span class="p">,</span>
</span><span data-line="2421">                        <span class="n">consider_as_foreign_keys</span><span class="o">=</span><span class="n">consider_as_foreign_keys</span><span class="p">,</span>
</span><span data-line="2422">                    <span class="p">)</span>
</span><span data-line="2423">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2424">                    <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">join_condition</span><span class="p">(</span>
</span><span data-line="2425">                        <span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span><span class="p">,</span>
</span><span data-line="2426">                        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span>
</span><span data-line="2427">                        <span class="n">a_subset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_local_selectable</span><span class="p">,</span>
</span><span data-line="2428">                        <span class="n">consider_as_foreign_keys</span><span class="o">=</span><span class="n">consider_as_foreign_keys</span><span class="p">,</span>
</span><span data-line="2429">                    <span class="p">)</span>
</span><span data-line="2430">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="2431">                    <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin_initial</span>
</span><span data-line="2432">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2433">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2434">                    <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">join_condition</span><span class="p">(</span>
</span><span data-line="2435">                        <span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span><span class="p">,</span>
</span><span data-line="2436">                        <span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span><span class="p">,</span>
</span><span data-line="2437">                        <span class="n">a_subset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_local_selectable</span><span class="p">,</span>
</span><span data-line="2438">                        <span class="n">consider_as_foreign_keys</span><span class="o">=</span><span class="n">consider_as_foreign_keys</span><span class="p">,</span>
</span><span data-line="2439">                    <span class="p">)</span>
</span><span data-line="2440">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="2441">                    <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin_initial</span>
</span><span data-line="2442">        <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoForeignKeysError</span> <span class="k">as</span> <span class="n">nfe</span><span class="p">:</span>
</span><span data-line="2443">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2444">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoForeignKeysError</span><span class="p">(</span>
</span><span data-line="2445">                    <span class="s2">&quot;Could not determine join &quot;</span>
</span><span data-line="2446">                    <span class="s2">&quot;condition between parent/child tables on &quot;</span>
</span><span data-line="2447">                    <span class="s2">&quot;relationship </span><span class="si">%s</span><span class="s2"> - there are no foreign keys &quot;</span>
</span><span data-line="2448">                    <span class="s2">&quot;linking these tables via secondary table &#39;</span><span class="si">%s</span><span class="s2">&#39;.  &quot;</span>
</span><span data-line="2449">                    <span class="s2">&quot;Ensure that referencing columns are associated &quot;</span>
</span><span data-line="2450">                    <span class="s2">&quot;with a ForeignKey or ForeignKeyConstraint, or &quot;</span>
</span><span data-line="2451">                    <span class="s2">&quot;specify &#39;primaryjoin&#39; and &#39;secondaryjoin&#39; &quot;</span>
</span><span data-line="2452">                    <span class="s2">&quot;expressions.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">)</span>
</span><span data-line="2453">                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">nfe</span>
</span><span data-line="2454">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2455">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoForeignKeysError</span><span class="p">(</span>
</span><span data-line="2456">                    <span class="s2">&quot;Could not determine join &quot;</span>
</span><span data-line="2457">                    <span class="s2">&quot;condition between parent/child tables on &quot;</span>
</span><span data-line="2458">                    <span class="s2">&quot;relationship </span><span class="si">%s</span><span class="s2"> - there are no foreign keys &quot;</span>
</span><span data-line="2459">                    <span class="s2">&quot;linking these tables.  &quot;</span>
</span><span data-line="2460">                    <span class="s2">&quot;Ensure that referencing columns are associated &quot;</span>
</span><span data-line="2461">                    <span class="s2">&quot;with a ForeignKey or ForeignKeyConstraint, or &quot;</span>
</span><span data-line="2462">                    <span class="s2">&quot;specify a &#39;primaryjoin&#39; expression.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
</span><span data-line="2463">                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">nfe</span>
</span><span data-line="2464">        <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">AmbiguousForeignKeysError</span> <span class="k">as</span> <span class="n">afe</span><span class="p">:</span>
</span><span data-line="2465">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2466">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">AmbiguousForeignKeysError</span><span class="p">(</span>
</span><span data-line="2467">                    <span class="s2">&quot;Could not determine join &quot;</span>
</span><span data-line="2468">                    <span class="s2">&quot;condition between parent/child tables on &quot;</span>
</span><span data-line="2469">                    <span class="s2">&quot;relationship </span><span class="si">%s</span><span class="s2"> - there are multiple foreign key &quot;</span>
</span><span data-line="2470">                    <span class="s2">&quot;paths linking the tables via secondary table &#39;</span><span class="si">%s</span><span class="s2">&#39;.  &quot;</span>
</span><span data-line="2471">                    <span class="s2">&quot;Specify the &#39;foreign_keys&#39; &quot;</span>
</span><span data-line="2472">                    <span class="s2">&quot;argument, providing a list of those columns which &quot;</span>
</span><span data-line="2473">                    <span class="s2">&quot;should be counted as containing a foreign key &quot;</span>
</span><span data-line="2474">                    <span class="s2">&quot;reference from the secondary table to each of the &quot;</span>
</span><span data-line="2475">                    <span class="s2">&quot;parent and child tables.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">)</span>
</span><span data-line="2476">                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">afe</span>
</span><span data-line="2477">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2478">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">AmbiguousForeignKeysError</span><span class="p">(</span>
</span><span data-line="2479">                    <span class="s2">&quot;Could not determine join &quot;</span>
</span><span data-line="2480">                    <span class="s2">&quot;condition between parent/child tables on &quot;</span>
</span><span data-line="2481">                    <span class="s2">&quot;relationship </span><span class="si">%s</span><span class="s2"> - there are multiple foreign key &quot;</span>
</span><span data-line="2482">                    <span class="s2">&quot;paths linking the tables.  Specify the &quot;</span>
</span><span data-line="2483">                    <span class="s2">&quot;&#39;foreign_keys&#39; argument, providing a list of those &quot;</span>
</span><span data-line="2484">                    <span class="s2">&quot;columns which should be counted as containing a &quot;</span>
</span><span data-line="2485">                    <span class="s2">&quot;foreign key reference to the parent table.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
</span><span data-line="2486">                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">afe</span>
</span><span data-line="2487">
</span><span data-line="2488">    <span class="nd">@property</span>
</span><span data-line="2489">    <span class="k">def</span><span class="w"> </span><span class="nf">primaryjoin_minus_local</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="2490">        <span class="k">return</span> <span class="n">_deep_deannotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">))</span>
</span><span data-line="2491">
</span><span data-line="2492">    <span class="nd">@property</span>
</span><span data-line="2493">    <span class="k">def</span><span class="w"> </span><span class="nf">secondaryjoin_minus_local</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="2494">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2495">        <span class="k">return</span> <span class="n">_deep_deannotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">))</span>
</span><span data-line="2496">
</span><span data-line="2497">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="2498">    <span class="k">def</span><span class="w"> </span><span class="nf">primaryjoin_reverse_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="2499"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the primaryjoin condition suitable for the</span>
</span><span data-line="2500"><span class="sd">        &quot;reverse&quot; direction.</span>
</span><span data-line="2501">
</span><span data-line="2502"><span class="sd">        If the primaryjoin was delivered here with pre-existing</span>
</span><span data-line="2503"><span class="sd">        &quot;remote&quot; annotations, the local/remote annotations</span>
</span><span data-line="2504"><span class="sd">        are reversed.  Otherwise, the local/remote annotations</span>
</span><span data-line="2505"><span class="sd">        are removed.</span>
</span><span data-line="2506">
</span><span data-line="2507"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2508">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_remote_annotations</span><span class="p">:</span>
</span><span data-line="2509">
</span><span data-line="2510">            <span class="k">def</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CE</span><span class="p">]:</span>
</span><span data-line="2511">                <span class="k">if</span> <span class="s2">&quot;remote&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
</span><span data-line="2512">                    <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">)</span>
</span><span data-line="2513">                    <span class="k">del</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;remote&quot;</span><span class="p">]</span>
</span><span data-line="2514">                    <span class="n">v</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2515">                    <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_with_annotations</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span data-line="2516">                <span class="k">elif</span> <span class="s2">&quot;local&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
</span><span data-line="2517">                    <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">)</span>
</span><span data-line="2518">                    <span class="k">del</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">]</span>
</span><span data-line="2519">                    <span class="n">v</span><span class="p">[</span><span class="s2">&quot;remote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2520">                    <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_with_annotations</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span data-line="2521">
</span><span data-line="2522">                <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2523">
</span><span data-line="2524">            <span class="k">return</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">replace</span><span class="p">)</span>
</span><span data-line="2525">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2526">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_foreign_annotations</span><span class="p">:</span>
</span><span data-line="2527">                <span class="c1"># TODO: coverage</span>
</span><span data-line="2528">                <span class="k">return</span> <span class="n">_deep_deannotate</span><span class="p">(</span>
</span><span data-line="2529">                    <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">)</span>
</span><span data-line="2530">                <span class="p">)</span>
</span><span data-line="2531">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2532">                <span class="k">return</span> <span class="n">_deep_deannotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">)</span>
</span><span data-line="2533">
</span><span data-line="2534">    <span class="k">def</span><span class="w"> </span><span class="nf">_has_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">:</span> <span class="n">ClauseElement</span><span class="p">,</span> <span class="n">annotation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2535">        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">visitors</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="p">{}):</span>
</span><span data-line="2536">            <span class="k">if</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
</span><span data-line="2537">                <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="2538">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2539">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="2540">
</span><span data-line="2541">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="2542">    <span class="k">def</span><span class="w"> </span><span class="nf">_has_foreign_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2543">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_annotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="s2">&quot;foreign&quot;</span><span class="p">)</span>
</span><span data-line="2544">
</span><span data-line="2545">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="2546">    <span class="k">def</span><span class="w"> </span><span class="nf">_has_remote_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2547">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_annotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">)</span>
</span><span data-line="2548">
</span><span data-line="2549">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_fks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2550"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Annotate the primaryjoin and secondaryjoin</span>
</span><span data-line="2551"><span class="sd">        structures with &#39;foreign&#39; annotations marking columns</span>
</span><span data-line="2552"><span class="sd">        considered as foreign.</span>
</span><span data-line="2553">
</span><span data-line="2554"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2555">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_foreign_annotations</span><span class="p">:</span>
</span><span data-line="2556">            <span class="k">return</span>
</span><span data-line="2557">
</span><span data-line="2558">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">consider_as_foreign_keys</span><span class="p">:</span>
</span><span data-line="2559">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_from_fk_list</span><span class="p">()</span>
</span><span data-line="2560">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2561">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_present_fks</span><span class="p">()</span>
</span><span data-line="2562">
</span><span data-line="2563">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_from_fk_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2564">        <span class="k">def</span><span class="w"> </span><span class="nf">check_fk</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CE</span><span class="p">]:</span>
</span><span data-line="2565">            <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">consider_as_foreign_keys</span><span class="p">:</span>
</span><span data-line="2566">                <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;foreign&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2567">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2568">
</span><span data-line="2569">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2570">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">check_fk</span>
</span><span data-line="2571">        <span class="p">)</span>
</span><span data-line="2572">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2573">            <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2574">                <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">check_fk</span>
</span><span data-line="2575">            <span class="p">)</span>
</span><span data-line="2576">
</span><span data-line="2577">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_present_fks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2578">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2579">            <span class="n">secondarycols</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="2580">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2581">            <span class="n">secondarycols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="2582">
</span><span data-line="2583">        <span class="k">def</span><span class="w"> </span><span class="nf">is_foreign</span><span class="p">(</span>
</span><span data-line="2584">            <span class="n">a</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="2585">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="2586">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">):</span>
</span><span data-line="2587">                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span data-line="2588">                    <span class="k">return</span> <span class="n">a</span>
</span><span data-line="2589">                <span class="k">elif</span> <span class="n">b</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span><span data-line="2590">                    <span class="k">return</span> <span class="n">b</span>
</span><span data-line="2591">
</span><span data-line="2592">            <span class="k">if</span> <span class="n">secondarycols</span><span class="p">:</span>
</span><span data-line="2593">                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">secondarycols</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">secondarycols</span><span class="p">:</span>
</span><span data-line="2594">                    <span class="k">return</span> <span class="n">a</span>
</span><span data-line="2595">                <span class="k">elif</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">secondarycols</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">secondarycols</span><span class="p">:</span>
</span><span data-line="2596">                    <span class="k">return</span> <span class="n">b</span>
</span><span data-line="2597">
</span><span data-line="2598">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2599">
</span><span data-line="2600">        <span class="k">def</span><span class="w"> </span><span class="nf">visit_binary</span><span class="p">(</span><span class="n">binary</span><span class="p">:</span> <span class="n">BinaryExpression</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2601">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="2602">                <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">ColumnElement</span>
</span><span data-line="2603">            <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
</span><span data-line="2604">                <span class="k">return</span>
</span><span data-line="2605">
</span><span data-line="2606">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2607">                <span class="s2">&quot;foreign&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="2608">                <span class="ow">and</span> <span class="s2">&quot;foreign&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="2609">            <span class="p">):</span>
</span><span data-line="2610">                <span class="n">col</span> <span class="o">=</span> <span class="n">is_foreign</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
</span><span data-line="2611">                <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2612">                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">):</span>
</span><span data-line="2613">                        <span class="n">binary</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;foreign&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2614">                    <span class="k">elif</span> <span class="n">col</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">):</span>
</span><span data-line="2615">                        <span class="n">binary</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">_annotate</span><span class="p">(</span>
</span><span data-line="2616">                            <span class="p">{</span><span class="s2">&quot;foreign&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span data-line="2617">                        <span class="p">)</span>
</span><span data-line="2618">
</span><span data-line="2619">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">cloned_traverse</span><span class="p">(</span>
</span><span data-line="2620">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="n">visit_binary</span><span class="p">}</span>
</span><span data-line="2621">        <span class="p">)</span>
</span><span data-line="2622">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2623">            <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">cloned_traverse</span><span class="p">(</span>
</span><span data-line="2624">                <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="n">visit_binary</span><span class="p">}</span>
</span><span data-line="2625">            <span class="p">)</span>
</span><span data-line="2626">
</span><span data-line="2627">    <span class="k">def</span><span class="w"> </span><span class="nf">_refers_to_parent_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2628"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the join condition contains column</span>
</span><span data-line="2629"><span class="sd">        comparisons where both columns are in both tables.</span>
</span><span data-line="2630">
</span><span data-line="2631"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2632">        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span>
</span><span data-line="2633">        <span class="n">mt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span>
</span><span data-line="2634">        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="2635">
</span><span data-line="2636">        <span class="k">def</span><span class="w"> </span><span class="nf">visit_binary</span><span class="p">(</span><span class="n">binary</span><span class="p">:</span> <span class="n">BinaryExpression</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2637">            <span class="k">nonlocal</span> <span class="n">result</span>
</span><span data-line="2638">            <span class="n">c</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span>
</span><span data-line="2639">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2640">                <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">)</span>
</span><span data-line="2641">                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">)</span>
</span><span data-line="2642">                <span class="ow">and</span> <span class="n">pt</span><span class="o">.</span><span class="n">is_derived_from</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
</span><span data-line="2643">                <span class="ow">and</span> <span class="n">pt</span><span class="o">.</span><span class="n">is_derived_from</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
</span><span data-line="2644">                <span class="ow">and</span> <span class="n">mt</span><span class="o">.</span><span class="n">is_derived_from</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
</span><span data-line="2645">                <span class="ow">and</span> <span class="n">mt</span><span class="o">.</span><span class="n">is_derived_from</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
</span><span data-line="2646">            <span class="p">):</span>
</span><span data-line="2647">                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2648">
</span><span data-line="2649">        <span class="n">visitors</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="n">visit_binary</span><span class="p">})</span>
</span><span data-line="2650">        <span class="k">return</span> <span class="n">result</span>
</span><span data-line="2651">
</span><span data-line="2652">    <span class="k">def</span><span class="w"> </span><span class="nf">_tables_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2653"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if parent/child tables have some overlap.&quot;&quot;&quot;</span>
</span><span data-line="2654">
</span><span data-line="2655">        <span class="k">return</span> <span class="n">selectables_overlap</span><span class="p">(</span>
</span><span data-line="2656">            <span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span>
</span><span data-line="2657">        <span class="p">)</span>
</span><span data-line="2658">
</span><span data-line="2659">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2660"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Annotate the primaryjoin and secondaryjoin</span>
</span><span data-line="2661"><span class="sd">        structures with &#39;remote&#39; annotations marking columns</span>
</span><span data-line="2662"><span class="sd">        considered as part of the &#39;remote&#39; side.</span>
</span><span data-line="2663">
</span><span data-line="2664"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2665">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_remote_annotations</span><span class="p">:</span>
</span><span data-line="2666">            <span class="k">return</span>
</span><span data-line="2667">
</span><span data-line="2668">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2669">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_remote_secondary</span><span class="p">()</span>
</span><span data-line="2670">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_remote_pairs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_side</span><span class="p">:</span>
</span><span data-line="2671">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_remote_from_args</span><span class="p">()</span>
</span><span data-line="2672">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refers_to_parent_table</span><span class="p">():</span>
</span><span data-line="2673">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_selfref</span><span class="p">(</span>
</span><span data-line="2674">                <span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="s2">&quot;foreign&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span> <span class="kc">False</span>
</span><span data-line="2675">            <span class="p">)</span>
</span><span data-line="2676">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tables_overlap</span><span class="p">():</span>
</span><span data-line="2677">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_remote_with_overlap</span><span class="p">()</span>
</span><span data-line="2678">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2679">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_remote_distinct_selectables</span><span class="p">()</span>
</span><span data-line="2680">
</span><span data-line="2681">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_remote_secondary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2682"><span class="w">        </span><span class="sd">&quot;&quot;&quot;annotate &#39;remote&#39; in primaryjoin, secondaryjoin</span>
</span><span data-line="2683"><span class="sd">        when &#39;secondary&#39; is present.</span>
</span><span data-line="2684">
</span><span data-line="2685"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2686">
</span><span data-line="2687">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2688">        <span class="n">fixed_secondary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span>
</span><span data-line="2689">
</span><span data-line="2690">        <span class="k">def</span><span class="w"> </span><span class="nf">repl</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CE</span><span class="p">]:</span>
</span><span data-line="2691">            <span class="k">if</span> <span class="n">fixed_secondary</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
</span><span data-line="2692">                <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2693">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2694">
</span><span data-line="2695">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2696">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">repl</span>
</span><span data-line="2697">        <span class="p">)</span>
</span><span data-line="2698">
</span><span data-line="2699">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2700">        <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2701">            <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">repl</span>
</span><span data-line="2702">        <span class="p">)</span>
</span><span data-line="2703">
</span><span data-line="2704">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_selfref</span><span class="p">(</span>
</span><span data-line="2705">        <span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">remote_side_given</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="2706">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2707"><span class="w">        </span><span class="sd">&quot;&quot;&quot;annotate &#39;remote&#39; in primaryjoin, secondaryjoin</span>
</span><span data-line="2708"><span class="sd">        when the relationship is detected as self-referential.</span>
</span><span data-line="2709">
</span><span data-line="2710"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2711">
</span><span data-line="2712">        <span class="k">def</span><span class="w"> </span><span class="nf">visit_binary</span><span class="p">(</span><span class="n">binary</span><span class="p">:</span> <span class="n">BinaryExpression</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2713">            <span class="n">equated</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
</span><span data-line="2714">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="2715">                <span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span>
</span><span data-line="2716">            <span class="p">):</span>
</span><span data-line="2717">                <span class="c1"># assume one to many - FKs are &quot;remote&quot;</span>
</span><span data-line="2718">                <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">):</span>
</span><span data-line="2719">                    <span class="n">binary</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2720">                <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">equated</span><span class="p">:</span>
</span><span data-line="2721">                    <span class="n">binary</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2722">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">remote_side_given</span><span class="p">:</span>
</span><span data-line="2723">                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_non_column_elements</span><span class="p">()</span>
</span><span data-line="2724">
</span><span data-line="2725">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">cloned_traverse</span><span class="p">(</span>
</span><span data-line="2726">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="n">visit_binary</span><span class="p">}</span>
</span><span data-line="2727">        <span class="p">)</span>
</span><span data-line="2728">
</span><span data-line="2729">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_remote_from_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2730"><span class="w">        </span><span class="sd">&quot;&quot;&quot;annotate &#39;remote&#39; in primaryjoin, secondaryjoin</span>
</span><span data-line="2731"><span class="sd">        when the &#39;remote_side&#39; or &#39;_local_remote_pairs&#39;</span>
</span><span data-line="2732"><span class="sd">        arguments are used.</span>
</span><span data-line="2733">
</span><span data-line="2734"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2735">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_remote_pairs</span><span class="p">:</span>
</span><span data-line="2736">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_side</span><span class="p">:</span>
</span><span data-line="2737">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2738">                    <span class="s2">&quot;remote_side argument is redundant &quot;</span>
</span><span data-line="2739">                    <span class="s2">&quot;against more detailed _local_remote_side &quot;</span>
</span><span data-line="2740">                    <span class="s2">&quot;argument.&quot;</span>
</span><span data-line="2741">                <span class="p">)</span>
</span><span data-line="2742">
</span><span data-line="2743">            <span class="n">remote_side</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_remote_pairs</span><span class="p">]</span>
</span><span data-line="2744">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2745">            <span class="n">remote_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_side</span>
</span><span data-line="2746">
</span><span data-line="2747">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refers_to_parent_table</span><span class="p">():</span>
</span><span data-line="2748">            <span class="bp">self</span><span class="o">.</span><span class="n">_annotate_selfref</span><span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">remote_side</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="2749">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2750">
</span><span data-line="2751">            <span class="k">def</span><span class="w"> </span><span class="nf">repl</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CE</span><span class="p">]:</span>
</span><span data-line="2752">                <span class="c1"># use set() to avoid generating ``__eq__()`` expressions</span>
</span><span data-line="2753">                <span class="c1"># against each element</span>
</span><span data-line="2754">                <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">remote_side</span><span class="p">):</span>
</span><span data-line="2755">                    <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2756">                <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2757">
</span><span data-line="2758">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2759">                <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">repl</span>
</span><span data-line="2760">            <span class="p">)</span>
</span><span data-line="2761">
</span><span data-line="2762">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_remote_with_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2763"><span class="w">        </span><span class="sd">&quot;&quot;&quot;annotate &#39;remote&#39; in primaryjoin, secondaryjoin</span>
</span><span data-line="2764"><span class="sd">        when the parent/child tables have some set of</span>
</span><span data-line="2765"><span class="sd">        tables in common, though is not a fully self-referential</span>
</span><span data-line="2766"><span class="sd">        relationship.</span>
</span><span data-line="2767">
</span><span data-line="2768"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2769">
</span><span data-line="2770">        <span class="k">def</span><span class="w"> </span><span class="nf">visit_binary</span><span class="p">(</span><span class="n">binary</span><span class="p">:</span> <span class="n">BinaryExpression</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2771">            <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">proc_left_right</span><span class="p">(</span>
</span><span data-line="2772">                <span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span>
</span><span data-line="2773">            <span class="p">)</span>
</span><span data-line="2774">            <span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">proc_left_right</span><span class="p">(</span>
</span><span data-line="2775">                <span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span>
</span><span data-line="2776">            <span class="p">)</span>
</span><span data-line="2777">
</span><span data-line="2778">        <span class="n">check_entities</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2779">            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span>
</span><span data-line="2780">        <span class="p">)</span>
</span><span data-line="2781">
</span><span data-line="2782">        <span class="k">def</span><span class="w"> </span><span class="nf">proc_left_right</span><span class="p">(</span>
</span><span data-line="2783">            <span class="n">left</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">right</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="2784">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="2785">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="2786">                <span class="n">right</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span>
</span><span data-line="2787">            <span class="p">):</span>
</span><span data-line="2788">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span>
</span><span data-line="2789">                    <span class="n">right</span>
</span><span data-line="2790">                <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
</span><span data-line="2791">                    <span class="n">right</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2792">            <span class="k">elif</span> <span class="p">(</span>
</span><span data-line="2793">                <span class="n">check_entities</span>
</span><span data-line="2794">                <span class="ow">and</span> <span class="n">right</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parentmapper&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="2795">            <span class="p">):</span>
</span><span data-line="2796">                <span class="n">right</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2797">            <span class="k">elif</span> <span class="p">(</span>
</span><span data-line="2798">                <span class="n">check_entities</span>
</span><span data-line="2799">                <span class="ow">and</span> <span class="n">left</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parentmapper&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="2800">            <span class="p">):</span>
</span><span data-line="2801">                <span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2802">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2803">                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_non_column_elements</span><span class="p">()</span>
</span><span data-line="2804">
</span><span data-line="2805">            <span class="k">return</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span>
</span><span data-line="2806">
</span><span data-line="2807">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">cloned_traverse</span><span class="p">(</span>
</span><span data-line="2808">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="n">visit_binary</span><span class="p">}</span>
</span><span data-line="2809">        <span class="p">)</span>
</span><span data-line="2810">
</span><span data-line="2811">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_remote_distinct_selectables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2812"><span class="w">        </span><span class="sd">&quot;&quot;&quot;annotate &#39;remote&#39; in primaryjoin, secondaryjoin</span>
</span><span data-line="2813"><span class="sd">        when the parent/child tables are entirely</span>
</span><span data-line="2814"><span class="sd">        separate.</span>
</span><span data-line="2815">
</span><span data-line="2816"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2817">
</span><span data-line="2818">        <span class="k">def</span><span class="w"> </span><span class="nf">repl</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CE</span><span class="p">]:</span>
</span><span data-line="2819">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="2820">                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_local_selectable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span data-line="2821">                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_local_selectable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span data-line="2822">            <span class="p">):</span>
</span><span data-line="2823">                <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2824">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2825">
</span><span data-line="2826">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2827">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">repl</span>
</span><span data-line="2828">        <span class="p">)</span>
</span><span data-line="2829">
</span><span data-line="2830">    <span class="k">def</span><span class="w"> </span><span class="nf">_warn_non_column_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2831">        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="2832">            <span class="s2">&quot;Non-simple column elements in primary &quot;</span>
</span><span data-line="2833">            <span class="s2">&quot;join condition for property </span><span class="si">%s</span><span class="s2"> - consider using &quot;</span>
</span><span data-line="2834">            <span class="s2">&quot;remote() annotations to mark the remote side.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
</span><span data-line="2835">        <span class="p">)</span>
</span><span data-line="2836">
</span><span data-line="2837">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_local</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2838"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Annotate the primaryjoin and secondaryjoin</span>
</span><span data-line="2839"><span class="sd">        structures with &#39;local&#39; annotations.</span>
</span><span data-line="2840">
</span><span data-line="2841"><span class="sd">        This annotates all column elements found</span>
</span><span data-line="2842"><span class="sd">        simultaneously in the parent table</span>
</span><span data-line="2843"><span class="sd">        and the join condition that don&#39;t have a</span>
</span><span data-line="2844"><span class="sd">        &#39;remote&#39; annotation set up from</span>
</span><span data-line="2845"><span class="sd">        _annotate_remote() or user-defined.</span>
</span><span data-line="2846">
</span><span data-line="2847"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2848">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_annotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span><span class="p">):</span>
</span><span data-line="2849">            <span class="k">return</span>
</span><span data-line="2850">
</span><span data-line="2851">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_remote_pairs</span><span class="p">:</span>
</span><span data-line="2852">            <span class="n">local_side</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span>
</span><span data-line="2853">                <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_remote_pairs</span><span class="p">]</span>
</span><span data-line="2854">            <span class="p">)</span>
</span><span data-line="2855">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2856">            <span class="n">local_side</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="2857">
</span><span data-line="2858">        <span class="k">def</span><span class="w"> </span><span class="nf">locals_</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CE</span><span class="p">]:</span>
</span><span data-line="2859">            <span class="k">if</span> <span class="s2">&quot;remote&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotations</span> <span class="ow">and</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">local_side</span><span class="p">:</span>
</span><span data-line="2860">                <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;local&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span data-line="2861">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2862">
</span><span data-line="2863">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2864">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">locals_</span>
</span><span data-line="2865">        <span class="p">)</span>
</span><span data-line="2866">
</span><span data-line="2867">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotate_parentmapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2868">        <span class="k">def</span><span class="w"> </span><span class="nf">parentmappers_</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">_CE</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CE</span><span class="p">]:</span>
</span><span data-line="2869">            <span class="k">if</span> <span class="s2">&quot;remote&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
</span><span data-line="2870">                <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;parentmapper&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span><span class="p">})</span>
</span><span data-line="2871">            <span class="k">elif</span> <span class="s2">&quot;local&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
</span><span data-line="2872">                <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotate</span><span class="p">({</span><span class="s2">&quot;parentmapper&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span><span class="p">})</span>
</span><span data-line="2873">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="2874">
</span><span data-line="2875">        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="2876">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">parentmappers_</span>
</span><span data-line="2877">        <span class="p">)</span>
</span><span data-line="2878">
</span><span data-line="2879">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_remote_side</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2880">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
</span><span data-line="2881">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2882">                <span class="s2">&quot;Relationship </span><span class="si">%s</span><span class="s2"> could &quot;</span>
</span><span data-line="2883">                <span class="s2">&quot;not determine any unambiguous local/remote column &quot;</span>
</span><span data-line="2884">                <span class="s2">&quot;pairs based on join condition and remote_side &quot;</span>
</span><span data-line="2885">                <span class="s2">&quot;arguments.  &quot;</span>
</span><span data-line="2886">                <span class="s2">&quot;Consider using the remote() annotation to &quot;</span>
</span><span data-line="2887">                <span class="s2">&quot;accurately mark those elements of the join &quot;</span>
</span><span data-line="2888">                <span class="s2">&quot;condition that are on the remote side of &quot;</span>
</span><span data-line="2889">                <span class="s2">&quot;the relationship.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,)</span>
</span><span data-line="2890">            <span class="p">)</span>
</span><span data-line="2891">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2892">            <span class="n">not_target</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span>
</span><span data-line="2893">                <span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span><span class="o">.</span><span class="n">c</span>
</span><span data-line="2894">            <span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="2895">
</span><span data-line="2896">            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
</span><span data-line="2897">                <span class="k">if</span> <span class="n">rmt</span> <span class="ow">in</span> <span class="n">not_target</span><span class="p">:</span>
</span><span data-line="2898">                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="2899">                        <span class="s2">&quot;Expression </span><span class="si">%s</span><span class="s2"> is marked as &#39;remote&#39;, but these &quot;</span>
</span><span data-line="2900">                        <span class="s2">&quot;column(s) are local to the local side.  The &quot;</span>
</span><span data-line="2901">                        <span class="s2">&quot;remote() annotation is needed only for a &quot;</span>
</span><span data-line="2902">                        <span class="s2">&quot;self-referential relationship where both sides &quot;</span>
</span><span data-line="2903">                        <span class="s2">&quot;of the relationship refer to the same tables.&quot;</span>
</span><span data-line="2904">                        <span class="o">%</span> <span class="p">(</span><span class="n">rmt</span><span class="p">,)</span>
</span><span data-line="2905">                    <span class="p">)</span>
</span><span data-line="2906">
</span><span data-line="2907">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_foreign_cols</span><span class="p">(</span>
</span><span data-line="2908">        <span class="bp">self</span><span class="p">,</span> <span class="n">join_condition</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">primary</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="2909">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2910"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the foreign key columns collected and emit error</span>
</span><span data-line="2911"><span class="sd">        messages.&quot;&quot;&quot;</span>
</span><span data-line="2912">        <span class="n">foreign_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_columns_with_annotation</span><span class="p">(</span>
</span><span data-line="2913">            <span class="n">join_condition</span><span class="p">,</span> <span class="s2">&quot;foreign&quot;</span>
</span><span data-line="2914">        <span class="p">)</span>
</span><span data-line="2915">
</span><span data-line="2916">        <span class="n">has_foreign</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">foreign_cols</span><span class="p">)</span>
</span><span data-line="2917">
</span><span data-line="2918">        <span class="k">if</span> <span class="n">primary</span><span class="p">:</span>
</span><span data-line="2919">            <span class="n">can_sync</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synchronize_pairs</span><span class="p">)</span>
</span><span data-line="2920">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2921">            <span class="n">can_sync</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_synchronize_pairs</span><span class="p">)</span>
</span><span data-line="2922">
</span><span data-line="2923">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2924">            <span class="bp">self</span><span class="o">.</span><span class="n">support_sync</span>
</span><span data-line="2925">            <span class="ow">and</span> <span class="n">can_sync</span>
</span><span data-line="2926">            <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_sync</span> <span class="ow">and</span> <span class="n">has_foreign</span><span class="p">)</span>
</span><span data-line="2927">        <span class="p">):</span>
</span><span data-line="2928">            <span class="k">return</span>
</span><span data-line="2929">
</span><span data-line="2930">        <span class="c1"># from here below is just determining the best error message</span>
</span><span data-line="2931">        <span class="c1"># to report.  Check for a join condition using any operator</span>
</span><span data-line="2932">        <span class="c1"># (not just ==), perhaps they need to turn on &quot;viewonly=True&quot;.</span>
</span><span data-line="2933">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_sync</span> <span class="ow">and</span> <span class="n">has_foreign</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">can_sync</span><span class="p">:</span>
</span><span data-line="2934">            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2935">                <span class="s2">&quot;Could not locate any simple equality expressions &quot;</span>
</span><span data-line="2936">                <span class="s2">&quot;involving locally mapped foreign key columns for &quot;</span>
</span><span data-line="2937">                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> join condition &quot;</span>
</span><span data-line="2938">                <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; on relationship </span><span class="si">%s</span><span class="s2">.&quot;</span>
</span><span data-line="2939">                <span class="o">%</span> <span class="p">(</span>
</span><span data-line="2940">                    <span class="n">primary</span> <span class="ow">and</span> <span class="s2">&quot;primary&quot;</span> <span class="ow">or</span> <span class="s2">&quot;secondary&quot;</span><span class="p">,</span>
</span><span data-line="2941">                    <span class="n">join_condition</span><span class="p">,</span>
</span><span data-line="2942">                    <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="2943">                <span class="p">)</span>
</span><span data-line="2944">            <span class="p">)</span>
</span><span data-line="2945">            <span class="n">err</span> <span class="o">+=</span> <span class="p">(</span>
</span><span data-line="2946">                <span class="s2">&quot;  Ensure that referencing columns are associated &quot;</span>
</span><span data-line="2947">                <span class="s2">&quot;with a ForeignKey or ForeignKeyConstraint, or are &quot;</span>
</span><span data-line="2948">                <span class="s2">&quot;annotated in the join condition with the foreign() &quot;</span>
</span><span data-line="2949">                <span class="s2">&quot;annotation. To allow comparison operators other than &quot;</span>
</span><span data-line="2950">                <span class="s2">&quot;&#39;==&#39;, the relationship can be marked as viewonly=True.&quot;</span>
</span><span data-line="2951">            <span class="p">)</span>
</span><span data-line="2952">
</span><span data-line="2953">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span data-line="2954">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2955">            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2956">                <span class="s2">&quot;Could not locate any relevant foreign key columns &quot;</span>
</span><span data-line="2957">                <span class="s2">&quot;for </span><span class="si">%s</span><span class="s2"> join condition &#39;</span><span class="si">%s</span><span class="s2">&#39; on relationship </span><span class="si">%s</span><span class="s2">.&quot;</span>
</span><span data-line="2958">                <span class="o">%</span> <span class="p">(</span>
</span><span data-line="2959">                    <span class="n">primary</span> <span class="ow">and</span> <span class="s2">&quot;primary&quot;</span> <span class="ow">or</span> <span class="s2">&quot;secondary&quot;</span><span class="p">,</span>
</span><span data-line="2960">                    <span class="n">join_condition</span><span class="p">,</span>
</span><span data-line="2961">                    <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="2962">                <span class="p">)</span>
</span><span data-line="2963">            <span class="p">)</span>
</span><span data-line="2964">            <span class="n">err</span> <span class="o">+=</span> <span class="p">(</span>
</span><span data-line="2965">                <span class="s2">&quot;  Ensure that referencing columns are associated &quot;</span>
</span><span data-line="2966">                <span class="s2">&quot;with a ForeignKey or ForeignKeyConstraint, or are &quot;</span>
</span><span data-line="2967">                <span class="s2">&quot;annotated in the join condition with the foreign() &quot;</span>
</span><span data-line="2968">                <span class="s2">&quot;annotation.&quot;</span>
</span><span data-line="2969">            <span class="p">)</span>
</span><span data-line="2970">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span data-line="2971">
</span><span data-line="2972">    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2973"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if this relationship is one to many, many to one,</span>
</span><span data-line="2974"><span class="sd">        many to many.</span>
</span><span data-line="2975">
</span><span data-line="2976"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2977">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2978">            <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">MANYTOMANY</span>
</span><span data-line="2979">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2980">            <span class="n">parentcols</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="2981">            <span class="n">targetcols</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_persist_selectable</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="2982">
</span><span data-line="2983">            <span class="c1"># fk collection which suggests ONETOMANY.</span>
</span><span data-line="2984">            <span class="n">onetomany_fk</span> <span class="o">=</span> <span class="n">targetcols</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_key_columns</span><span class="p">)</span>
</span><span data-line="2985">
</span><span data-line="2986">            <span class="c1"># fk collection which suggests MANYTOONE.</span>
</span><span data-line="2987">
</span><span data-line="2988">            <span class="n">manytoone_fk</span> <span class="o">=</span> <span class="n">parentcols</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_key_columns</span><span class="p">)</span>
</span><span data-line="2989">
</span><span data-line="2990">            <span class="k">if</span> <span class="n">onetomany_fk</span> <span class="ow">and</span> <span class="n">manytoone_fk</span><span class="p">:</span>
</span><span data-line="2991">                <span class="c1"># fks on both sides.  test for overlap of local/remote</span>
</span><span data-line="2992">                <span class="c1"># with foreign key.</span>
</span><span data-line="2993">                <span class="c1"># we will gather columns directly from their annotations</span>
</span><span data-line="2994">                <span class="c1"># without deannotating, so that we can distinguish on a column</span>
</span><span data-line="2995">                <span class="c1"># that refers to itself.</span>
</span><span data-line="2996">
</span><span data-line="2997">                <span class="c1"># 1. columns that are both remote and FK suggest</span>
</span><span data-line="2998">                <span class="c1"># onetomany.</span>
</span><span data-line="2999">                <span class="n">onetomany_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_columns_with_annotation</span><span class="p">(</span>
</span><span data-line="3000">                    <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">,</span> <span class="s2">&quot;foreign&quot;</span>
</span><span data-line="3001">                <span class="p">)</span>
</span><span data-line="3002">
</span><span data-line="3003">                <span class="c1"># 2. columns that are FK but are not remote (e.g. local)</span>
</span><span data-line="3004">                <span class="c1"># suggest manytoone.</span>
</span><span data-line="3005">                <span class="n">manytoone_local</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="3006">                    <span class="n">c</span>
</span><span data-line="3007">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_columns_with_annotation</span><span class="p">(</span>
</span><span data-line="3008">                        <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="s2">&quot;foreign&quot;</span>
</span><span data-line="3009">                    <span class="p">)</span>
</span><span data-line="3010">                    <span class="k">if</span> <span class="s2">&quot;remote&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="3011">                <span class="p">}</span>
</span><span data-line="3012">
</span><span data-line="3013">                <span class="c1"># 3. if both collections are present, remove columns that</span>
</span><span data-line="3014">                <span class="c1"># refer to themselves.  This is for the case of</span>
</span><span data-line="3015">                <span class="c1"># and_(Me.id == Me.remote_id, Me.version == Me.version)</span>
</span><span data-line="3016">                <span class="k">if</span> <span class="n">onetomany_local</span> <span class="ow">and</span> <span class="n">manytoone_local</span><span class="p">:</span>
</span><span data-line="3017">                    <span class="n">self_equated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
</span><span data-line="3018">                        <span class="bp">self</span><span class="o">.</span><span class="n">local_columns</span>
</span><span data-line="3019">                    <span class="p">)</span>
</span><span data-line="3020">                    <span class="n">onetomany_local</span> <span class="o">=</span> <span class="n">onetomany_local</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">self_equated</span><span class="p">)</span>
</span><span data-line="3021">                    <span class="n">manytoone_local</span> <span class="o">=</span> <span class="n">manytoone_local</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">self_equated</span><span class="p">)</span>
</span><span data-line="3022">
</span><span data-line="3023">                <span class="c1"># at this point, if only one or the other collection is</span>
</span><span data-line="3024">                <span class="c1"># present, we know the direction, otherwise it&#39;s still</span>
</span><span data-line="3025">                <span class="c1"># ambiguous.</span>
</span><span data-line="3026">
</span><span data-line="3027">                <span class="k">if</span> <span class="n">onetomany_local</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">manytoone_local</span><span class="p">:</span>
</span><span data-line="3028">                    <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">ONETOMANY</span>
</span><span data-line="3029">                <span class="k">elif</span> <span class="n">manytoone_local</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">onetomany_local</span><span class="p">:</span>
</span><span data-line="3030">                    <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">MANYTOONE</span>
</span><span data-line="3031">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="3032">                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="3033">                        <span class="s2">&quot;Can&#39;t determine relationship&quot;</span>
</span><span data-line="3034">                        <span class="s2">&quot; direction for relationship &#39;</span><span class="si">%s</span><span class="s2">&#39; - foreign &quot;</span>
</span><span data-line="3035">                        <span class="s2">&quot;key columns within the join condition are present &quot;</span>
</span><span data-line="3036">                        <span class="s2">&quot;in both the parent and the child&#39;s mapped tables.  &quot;</span>
</span><span data-line="3037">                        <span class="s2">&quot;Ensure that only those columns referring &quot;</span>
</span><span data-line="3038">                        <span class="s2">&quot;to a parent column are marked as foreign, &quot;</span>
</span><span data-line="3039">                        <span class="s2">&quot;either via the foreign() annotation or &quot;</span>
</span><span data-line="3040">                        <span class="s2">&quot;via the foreign_keys argument.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
</span><span data-line="3041">                    <span class="p">)</span>
</span><span data-line="3042">            <span class="k">elif</span> <span class="n">onetomany_fk</span><span class="p">:</span>
</span><span data-line="3043">                <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">ONETOMANY</span>
</span><span data-line="3044">            <span class="k">elif</span> <span class="n">manytoone_fk</span><span class="p">:</span>
</span><span data-line="3045">                <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">MANYTOONE</span>
</span><span data-line="3046">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="3047">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="3048">                    <span class="s2">&quot;Can&#39;t determine relationship &quot;</span>
</span><span data-line="3049">                    <span class="s2">&quot;direction for relationship &#39;</span><span class="si">%s</span><span class="s2">&#39; - foreign &quot;</span>
</span><span data-line="3050">                    <span class="s2">&quot;key columns are present in neither the parent &quot;</span>
</span><span data-line="3051">                    <span class="s2">&quot;nor the child&#39;s mapped tables&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
</span><span data-line="3052">                <span class="p">)</span>
</span><span data-line="3053">
</span><span data-line="3054">    <span class="k">def</span><span class="w"> </span><span class="nf">_deannotate_pairs</span><span class="p">(</span>
</span><span data-line="3055">        <span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="n">_ColumnPairIterable</span>
</span><span data-line="3056">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_MutableColumnPairs</span><span class="p">:</span>
</span><span data-line="3057"><span class="w">        </span><span class="sd">&quot;&quot;&quot;provide deannotation for the various lists of</span>
</span><span data-line="3058"><span class="sd">        pairs, so that using them in hashes doesn&#39;t incur</span>
</span><span data-line="3059"><span class="sd">        high-overhead __eq__() comparisons against</span>
</span><span data-line="3060"><span class="sd">        original columns mapped.</span>
</span><span data-line="3061">
</span><span data-line="3062"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3063">        <span class="k">return</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">_deannotate</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">_deannotate</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">]</span>
</span><span data-line="3064">
</span><span data-line="3065">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3066">        <span class="n">sync_pairs</span><span class="p">:</span> <span class="n">_MutableColumnPairs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="3067">        <span class="n">lrp</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="3068">            <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">([])</span>
</span><span data-line="3069">        <span class="p">)</span>
</span><span data-line="3070">        <span class="n">secondary_sync_pairs</span><span class="p">:</span> <span class="n">_MutableColumnPairs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="3071">
</span><span data-line="3072">        <span class="k">def</span><span class="w"> </span><span class="nf">go</span><span class="p">(</span>
</span><span data-line="3073">            <span class="n">joincond</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span data-line="3074">            <span class="n">collection</span><span class="p">:</span> <span class="n">_MutableColumnPairs</span><span class="p">,</span>
</span><span data-line="3075">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3076">            <span class="k">def</span><span class="w"> </span><span class="nf">visit_binary</span><span class="p">(</span>
</span><span data-line="3077">                <span class="n">binary</span><span class="p">:</span> <span class="n">BinaryExpression</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="3078">                <span class="n">left</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="3079">                <span class="n">right</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="3080">            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3081">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3082">                    <span class="s2">&quot;remote&quot;</span> <span class="ow">in</span> <span class="n">right</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="3083">                    <span class="ow">and</span> <span class="s2">&quot;remote&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">left</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="3084">                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_be_synced_fn</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
</span><span data-line="3085">                <span class="p">):</span>
</span><span data-line="3086">                    <span class="n">lrp</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>
</span><span data-line="3087">                <span class="k">elif</span> <span class="p">(</span>
</span><span data-line="3088">                    <span class="s2">&quot;remote&quot;</span> <span class="ow">in</span> <span class="n">left</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="3089">                    <span class="ow">and</span> <span class="s2">&quot;remote&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">right</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="3090">                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_be_synced_fn</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
</span><span data-line="3091">                <span class="p">):</span>
</span><span data-line="3092">                    <span class="n">lrp</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
</span><span data-line="3093">                <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="n">operators</span><span class="o">.</span><span class="n">eq</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_be_synced_fn</span><span class="p">(</span>
</span><span data-line="3094">                    <span class="n">left</span><span class="p">,</span> <span class="n">right</span>
</span><span data-line="3095">                <span class="p">):</span>
</span><span data-line="3096">                    <span class="k">if</span> <span class="s2">&quot;foreign&quot;</span> <span class="ow">in</span> <span class="n">right</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
</span><span data-line="3097">                        <span class="n">collection</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>
</span><span data-line="3098">                    <span class="k">elif</span> <span class="s2">&quot;foreign&quot;</span> <span class="ow">in</span> <span class="n">left</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
</span><span data-line="3099">                        <span class="n">collection</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
</span><span data-line="3100">
</span><span data-line="3101">            <span class="n">visit_binary_product</span><span class="p">(</span><span class="n">visit_binary</span><span class="p">,</span> <span class="n">joincond</span><span class="p">)</span>
</span><span data-line="3102">
</span><span data-line="3103">        <span class="k">for</span> <span class="n">joincond</span><span class="p">,</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">[</span>
</span><span data-line="3104">            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="n">sync_pairs</span><span class="p">),</span>
</span><span data-line="3105">            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="n">secondary_sync_pairs</span><span class="p">),</span>
</span><span data-line="3106">        <span class="p">]:</span>
</span><span data-line="3107">            <span class="k">if</span> <span class="n">joincond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3108">                <span class="k">continue</span>
</span><span data-line="3109">            <span class="n">go</span><span class="p">(</span><span class="n">joincond</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
</span><span data-line="3110">
</span><span data-line="3111">        <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deannotate_pairs</span><span class="p">(</span><span class="n">lrp</span><span class="p">)</span>
</span><span data-line="3112">        <span class="bp">self</span><span class="o">.</span><span class="n">synchronize_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deannotate_pairs</span><span class="p">(</span><span class="n">sync_pairs</span><span class="p">)</span>
</span><span data-line="3113">        <span class="bp">self</span><span class="o">.</span><span class="n">secondary_synchronize_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deannotate_pairs</span><span class="p">(</span>
</span><span data-line="3114">            <span class="n">secondary_sync_pairs</span>
</span><span data-line="3115">        <span class="p">)</span>
</span><span data-line="3116">
</span><span data-line="3117">    <span class="n">_track_overlapping_sync_targets</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span>
</span><span data-line="3118">        <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="3119">        <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span>
</span><span data-line="3120">            <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="3121">        <span class="p">],</span>
</span><span data-line="3122">    <span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span data-line="3123">
</span><span data-line="3124">    <span class="k">def</span><span class="w"> </span><span class="nf">_warn_for_conflicting_sync_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3125">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_sync</span><span class="p">:</span>
</span><span data-line="3126">            <span class="k">return</span>
</span><span data-line="3127">
</span><span data-line="3128">        <span class="c1"># we would like to detect if we are synchronizing any column</span>
</span><span data-line="3129">        <span class="c1"># pairs in conflict with another relationship that wishes to sync</span>
</span><span data-line="3130">        <span class="c1"># an entirely different column to the same target.   This is a</span>
</span><span data-line="3131">        <span class="c1"># very rare edge case so we will try to minimize the memory/overhead</span>
</span><span data-line="3132">        <span class="c1"># impact of this check</span>
</span><span data-line="3133">        <span class="k">for</span> <span class="n">from_</span><span class="p">,</span> <span class="n">to_</span> <span class="ow">in</span> <span class="p">[</span>
</span><span data-line="3134">            <span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to_</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchronize_pairs</span>
</span><span data-line="3135">        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span data-line="3136">            <span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to_</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary_synchronize_pairs</span>
</span><span data-line="3137">        <span class="p">]:</span>
</span><span data-line="3138">            <span class="c1"># save ourselves a ton of memory and overhead by only</span>
</span><span data-line="3139">            <span class="c1"># considering columns that are subject to a overlapping</span>
</span><span data-line="3140">            <span class="c1"># FK constraints at the core level.   This condition can arise</span>
</span><span data-line="3141">            <span class="c1"># if multiple relationships overlap foreign() directly, but</span>
</span><span data-line="3142">            <span class="c1"># we&#39;re going to assume it&#39;s typically a ForeignKeyConstraint-</span>
</span><span data-line="3143">            <span class="c1"># level configuration that benefits from this warning.</span>
</span><span data-line="3144">
</span><span data-line="3145">            <span class="k">if</span> <span class="n">to_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_overlapping_sync_targets</span><span class="p">:</span>
</span><span data-line="3146">                <span class="bp">self</span><span class="o">.</span><span class="n">_track_overlapping_sync_targets</span><span class="p">[</span><span class="n">to_</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="3147">                    <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span> <span class="n">from_</span><span class="p">})</span>
</span><span data-line="3148">                <span class="p">)</span>
</span><span data-line="3149">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="3150">                <span class="n">other_props</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="3151">                <span class="n">prop_to_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_overlapping_sync_targets</span><span class="p">[</span><span class="n">to_</span><span class="p">]</span>
</span><span data-line="3152">
</span><span data-line="3153">                <span class="k">for</span> <span class="n">pr</span><span class="p">,</span> <span class="n">fr_</span> <span class="ow">in</span> <span class="n">prop_to_from</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="3154">                    <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3155">                        <span class="ow">not</span> <span class="n">pr</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_dispose_called</span>
</span><span data-line="3156">                        <span class="ow">and</span> <span class="n">pr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">_reverse_property</span>
</span><span data-line="3157">                        <span class="ow">and</span> <span class="n">pr</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">_overlaps</span>
</span><span data-line="3158">                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">_overlaps</span>
</span><span data-line="3159">                        <span class="c1"># note: the &quot;__*&quot; symbol is used internally by</span>
</span><span data-line="3160">                        <span class="c1"># SQLAlchemy as a general means of suppressing the</span>
</span><span data-line="3161">                        <span class="c1"># overlaps warning for some extension cases, however</span>
</span><span data-line="3162">                        <span class="c1"># this is not currently</span>
</span><span data-line="3163">                        <span class="c1"># a publicly supported symbol and may change at</span>
</span><span data-line="3164">                        <span class="c1"># any time.</span>
</span><span data-line="3165">                        <span class="ow">and</span> <span class="s2">&quot;__*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">_overlaps</span>
</span><span data-line="3166">                        <span class="ow">and</span> <span class="s2">&quot;__*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">_overlaps</span>
</span><span data-line="3167">                        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_sibling</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span data-line="3168">                        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">is_sibling</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>
</span><span data-line="3169">                        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_sibling</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>
</span><span data-line="3170">                        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">is_sibling</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span data-line="3171">                        <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="3172">                            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">pr</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="3173">                            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">common_parent</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span data-line="3174">                        <span class="p">)</span>
</span><span data-line="3175">                    <span class="p">):</span>
</span><span data-line="3176">                        <span class="n">other_props</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pr</span><span class="p">,</span> <span class="n">fr_</span><span class="p">))</span>
</span><span data-line="3177">
</span><span data-line="3178">                <span class="k">if</span> <span class="n">other_props</span><span class="p">:</span>
</span><span data-line="3179">                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="3180">                        <span class="s2">&quot;relationship &#39;</span><span class="si">%s</span><span class="s2">&#39; will copy column </span><span class="si">%s</span><span class="s2"> to column </span><span class="si">%s</span><span class="s2">, &quot;</span>
</span><span data-line="3181">                        <span class="s2">&quot;which conflicts with relationship(s): </span><span class="si">%s</span><span class="s2">. &quot;</span>
</span><span data-line="3182">                        <span class="s2">&quot;If this is not the intention, consider if these &quot;</span>
</span><span data-line="3183">                        <span class="s2">&quot;relationships should be linked with &quot;</span>
</span><span data-line="3184">                        <span class="s2">&quot;back_populates, or if viewonly=True should be &quot;</span>
</span><span data-line="3185">                        <span class="s2">&quot;applied to one or more if they are read-only. &quot;</span>
</span><span data-line="3186">                        <span class="s2">&quot;For the less common case that foreign key &quot;</span>
</span><span data-line="3187">                        <span class="s2">&quot;constraints are partially overlapping, the &quot;</span>
</span><span data-line="3188">                        <span class="s2">&quot;orm.foreign() &quot;</span>
</span><span data-line="3189">                        <span class="s2">&quot;annotation can be used to isolate the columns that &quot;</span>
</span><span data-line="3190">                        <span class="s2">&quot;should be written towards.   To silence this &quot;</span>
</span><span data-line="3191">                        <span class="s2">&quot;warning, add the parameter &#39;overlaps=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&#39; to the &quot;</span>
</span><span data-line="3192">                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; relationship.&quot;</span>
</span><span data-line="3193">                        <span class="o">%</span> <span class="p">(</span>
</span><span data-line="3194">                            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="3195">                            <span class="n">from_</span><span class="p">,</span>
</span><span data-line="3196">                            <span class="n">to_</span><span class="p">,</span>
</span><span data-line="3197">                            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span data-line="3198">                                <span class="nb">sorted</span><span class="p">(</span>
</span><span data-line="3199">                                    <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; (copies </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">fr_</span><span class="p">,</span> <span class="n">to_</span><span class="p">)</span>
</span><span data-line="3200">                                    <span class="k">for</span> <span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">fr_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">other_props</span>
</span><span data-line="3201">                                <span class="p">)</span>
</span><span data-line="3202">                            <span class="p">),</span>
</span><span data-line="3203">                            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">pr</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">other_props</span><span class="p">)),</span>
</span><span data-line="3204">                            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span>
</span><span data-line="3205">                        <span class="p">),</span>
</span><span data-line="3206">                        <span class="n">code</span><span class="o">=</span><span class="s2">&quot;qzyx&quot;</span><span class="p">,</span>
</span><span data-line="3207">                    <span class="p">)</span>
</span><span data-line="3208">                <span class="bp">self</span><span class="o">.</span><span class="n">_track_overlapping_sync_targets</span><span class="p">[</span><span class="n">to_</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_</span>
</span><span data-line="3209">
</span><span data-line="3210">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="3211">    <span class="k">def</span><span class="w"> </span><span class="nf">remote_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="3212">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_join_annotations</span><span class="p">(</span><span class="s2">&quot;remote&quot;</span><span class="p">)</span>
</span><span data-line="3213">
</span><span data-line="3214">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="3215">    <span class="k">def</span><span class="w"> </span><span class="nf">local_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="3216">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_join_annotations</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">)</span>
</span><span data-line="3217">
</span><span data-line="3218">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="3219">    <span class="k">def</span><span class="w"> </span><span class="nf">foreign_key_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="3220">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_join_annotations</span><span class="p">(</span><span class="s2">&quot;foreign&quot;</span><span class="p">)</span>
</span><span data-line="3221">
</span><span data-line="3222">    <span class="k">def</span><span class="w"> </span><span class="nf">_gather_join_annotations</span><span class="p">(</span>
</span><span data-line="3223">        <span class="bp">self</span><span class="p">,</span> <span class="n">annotation</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="3224">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="3225">        <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
</span><span data-line="3226">            <span class="bp">self</span><span class="o">.</span><span class="n">_gather_columns_with_annotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span>
</span><span data-line="3227">        <span class="p">)</span>
</span><span data-line="3228">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3229">            <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span data-line="3230">                <span class="bp">self</span><span class="o">.</span><span class="n">_gather_columns_with_annotation</span><span class="p">(</span>
</span><span data-line="3231">                    <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span> <span class="n">annotation</span>
</span><span data-line="3232">                <span class="p">)</span>
</span><span data-line="3233">            <span class="p">)</span>
</span><span data-line="3234">        <span class="k">return</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">_deannotate</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="p">}</span>
</span><span data-line="3235">
</span><span data-line="3236">    <span class="k">def</span><span class="w"> </span><span class="nf">_gather_columns_with_annotation</span><span class="p">(</span>
</span><span data-line="3237">        <span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="n">annotation</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="3238">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="3239">        <span class="n">annotation_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</span><span data-line="3240">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="3241">            <span class="n">cast</span><span class="p">(</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">col</span><span class="p">)</span>
</span><span data-line="3242">            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">visitors</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="p">{})</span>
</span><span data-line="3243">            <span class="k">if</span> <span class="n">annotation_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">_annotations</span><span class="p">)</span>
</span><span data-line="3244">        <span class="p">}</span>
</span><span data-line="3245">
</span><span data-line="3246">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="3247">    <span class="k">def</span><span class="w"> </span><span class="nf">_secondary_lineage_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="3248">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3249">            <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span>
</span><span data-line="3250">                <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">proxy_set</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">c</span><span class="p">])</span>
</span><span data-line="3251">            <span class="p">)</span>
</span><span data-line="3252">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="3253">            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_SET</span>
</span><span data-line="3254">
</span><span data-line="3255">    <span class="k">def</span><span class="w"> </span><span class="nf">join_targets</span><span class="p">(</span>
</span><span data-line="3256">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3257">        <span class="n">source_selectable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="3258">        <span class="n">dest_selectable</span><span class="p">:</span> <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="3259">        <span class="n">aliased</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="3260">        <span class="n">single_crit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3261">        <span class="n">extra_criteria</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
</span><span data-line="3262">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
</span><span data-line="3263">        <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span data-line="3264">        <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]],</span>
</span><span data-line="3265">        <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="3266">        <span class="n">Optional</span><span class="p">[</span><span class="n">ClauseAdapter</span><span class="p">],</span>
</span><span data-line="3267">        <span class="n">FromClause</span><span class="p">,</span>
</span><span data-line="3268">    <span class="p">]:</span>
</span><span data-line="3269"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a source and destination selectable, create a</span>
</span><span data-line="3270"><span class="sd">        join between them.</span>
</span><span data-line="3271">
</span><span data-line="3272"><span class="sd">        This takes into account aliasing the join clause</span>
</span><span data-line="3273"><span class="sd">        to reference the appropriate corresponding columns</span>
</span><span data-line="3274"><span class="sd">        in the target objects, as well as the extra child</span>
</span><span data-line="3275"><span class="sd">        criterion, equivalent column sets, etc.</span>
</span><span data-line="3276">
</span><span data-line="3277"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3278">        <span class="c1"># place a barrier on the destination such that</span>
</span><span data-line="3279">        <span class="c1"># replacement traversals won&#39;t ever dig into it.</span>
</span><span data-line="3280">        <span class="c1"># its internal structure remains fixed</span>
</span><span data-line="3281">        <span class="c1"># regardless of context.</span>
</span><span data-line="3282">        <span class="n">dest_selectable</span> <span class="o">=</span> <span class="n">_shallow_annotate</span><span class="p">(</span>
</span><span data-line="3283">            <span class="n">dest_selectable</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;no_replacement_traverse&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span data-line="3284">        <span class="p">)</span>
</span><span data-line="3285">
</span><span data-line="3286">        <span class="n">primaryjoin</span><span class="p">,</span> <span class="n">secondaryjoin</span><span class="p">,</span> <span class="n">secondary</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="3287">            <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span><span class="p">,</span>
</span><span data-line="3288">            <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span><span class="p">,</span>
</span><span data-line="3289">            <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span>
</span><span data-line="3290">        <span class="p">)</span>
</span><span data-line="3291">
</span><span data-line="3292">        <span class="c1"># adjust the join condition for single table inheritance,</span>
</span><span data-line="3293">        <span class="c1"># in the case that the join is to a subclass</span>
</span><span data-line="3294">        <span class="c1"># this is analogous to the</span>
</span><span data-line="3295">        <span class="c1"># &quot;_adjust_for_single_table_inheritance()&quot; method in Query.</span>
</span><span data-line="3296">
</span><span data-line="3297">        <span class="k">if</span> <span class="n">single_crit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3298">            <span class="k">if</span> <span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3299">                <span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">secondaryjoin</span> <span class="o">&amp;</span> <span class="n">single_crit</span>
</span><span data-line="3300">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="3301">                <span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">primaryjoin</span> <span class="o">&amp;</span> <span class="n">single_crit</span>
</span><span data-line="3302">
</span><span data-line="3303">        <span class="k">if</span> <span class="n">extra_criteria</span><span class="p">:</span>
</span><span data-line="3304">
</span><span data-line="3305">            <span class="k">def</span><span class="w"> </span><span class="nf">mark_exclude_cols</span><span class="p">(</span>
</span><span data-line="3306">                <span class="n">elem</span><span class="p">:</span> <span class="n">SupportsAnnotations</span><span class="p">,</span> <span class="n">annotations</span><span class="p">:</span> <span class="n">_AnnotationDict</span>
</span><span data-line="3307">            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SupportsAnnotations</span><span class="p">:</span>
</span><span data-line="3308"><span class="w">                </span><span class="sd">&quot;&quot;&quot;note unrelated columns in the &quot;extra criteria&quot; as either</span>
</span><span data-line="3309"><span class="sd">                should be adapted or not adapted, even though they are not</span>
</span><span data-line="3310"><span class="sd">                part of our &quot;local&quot; or &quot;remote&quot; side.</span>
</span><span data-line="3311">
</span><span data-line="3312"><span class="sd">                see #9779 for this case, as well as #11010 for a follow up</span>
</span><span data-line="3313">
</span><span data-line="3314"><span class="sd">                &quot;&quot;&quot;</span>
</span><span data-line="3315">
</span><span data-line="3316">                <span class="n">parentmapper_for_element</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="3317">                    <span class="s2">&quot;parentmapper&quot;</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="3318">                <span class="p">)</span>
</span><span data-line="3319">
</span><span data-line="3320">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3321">                    <span class="n">parentmapper_for_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span>
</span><span data-line="3322">                    <span class="ow">and</span> <span class="n">parentmapper_for_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="3323">                    <span class="ow">and</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_secondary_lineage_set</span>
</span><span data-line="3324">                <span class="p">):</span>
</span><span data-line="3325">                    <span class="k">return</span> <span class="n">_safe_annotate</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>
</span><span data-line="3326">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="3327">                    <span class="k">return</span> <span class="n">elem</span>
</span><span data-line="3328">
</span><span data-line="3329">            <span class="n">extra_criteria</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span data-line="3330">                <span class="n">_deep_annotate</span><span class="p">(</span>
</span><span data-line="3331">                    <span class="n">elem</span><span class="p">,</span>
</span><span data-line="3332">                    <span class="p">{</span><span class="s2">&quot;should_not_adapt&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span data-line="3333">                    <span class="n">annotate_callable</span><span class="o">=</span><span class="n">mark_exclude_cols</span><span class="p">,</span>
</span><span data-line="3334">                <span class="p">)</span>
</span><span data-line="3335">                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">extra_criteria</span>
</span><span data-line="3336">            <span class="p">)</span>
</span><span data-line="3337">
</span><span data-line="3338">            <span class="k">if</span> <span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3339">                <span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">secondaryjoin</span> <span class="o">&amp;</span> <span class="n">sql</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">extra_criteria</span><span class="p">)</span>
</span><span data-line="3340">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="3341">                <span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">primaryjoin</span> <span class="o">&amp;</span> <span class="n">sql</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">extra_criteria</span><span class="p">)</span>
</span><span data-line="3342">
</span><span data-line="3343">        <span class="k">if</span> <span class="n">aliased</span><span class="p">:</span>
</span><span data-line="3344">            <span class="k">if</span> <span class="n">secondary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3345">                <span class="n">secondary</span> <span class="o">=</span> <span class="n">secondary</span><span class="o">.</span><span class="n">_anonymous_fromclause</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="3346">                <span class="n">primary_aliasizer</span> <span class="o">=</span> <span class="n">ClauseAdapter</span><span class="p">(</span>
</span><span data-line="3347">                    <span class="n">secondary</span><span class="p">,</span>
</span><span data-line="3348">                    <span class="n">exclude_fn</span><span class="o">=</span><span class="n">_local_col_exclude</span><span class="p">,</span>
</span><span data-line="3349">                <span class="p">)</span>
</span><span data-line="3350">                <span class="n">secondary_aliasizer</span> <span class="o">=</span> <span class="n">ClauseAdapter</span><span class="p">(</span>
</span><span data-line="3351">                    <span class="n">dest_selectable</span><span class="p">,</span> <span class="n">equivalents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">child_equivalents</span>
</span><span data-line="3352">                <span class="p">)</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">primary_aliasizer</span><span class="p">)</span>
</span><span data-line="3353">                <span class="k">if</span> <span class="n">source_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3354">                    <span class="n">primary_aliasizer</span> <span class="o">=</span> <span class="n">ClauseAdapter</span><span class="p">(</span>
</span><span data-line="3355">                        <span class="n">secondary</span><span class="p">,</span>
</span><span data-line="3356">                        <span class="n">exclude_fn</span><span class="o">=</span><span class="n">_local_col_exclude</span><span class="p">,</span>
</span><span data-line="3357">                    <span class="p">)</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
</span><span data-line="3358">                        <span class="n">ClauseAdapter</span><span class="p">(</span>
</span><span data-line="3359">                            <span class="n">source_selectable</span><span class="p">,</span>
</span><span data-line="3360">                            <span class="n">equivalents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_equivalents</span><span class="p">,</span>
</span><span data-line="3361">                        <span class="p">)</span>
</span><span data-line="3362">                    <span class="p">)</span>
</span><span data-line="3363">
</span><span data-line="3364">                <span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">secondary_aliasizer</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">secondaryjoin</span><span class="p">)</span>
</span><span data-line="3365">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="3366">                <span class="n">primary_aliasizer</span> <span class="o">=</span> <span class="n">ClauseAdapter</span><span class="p">(</span>
</span><span data-line="3367">                    <span class="n">dest_selectable</span><span class="p">,</span>
</span><span data-line="3368">                    <span class="n">exclude_fn</span><span class="o">=</span><span class="n">_local_col_exclude</span><span class="p">,</span>
</span><span data-line="3369">                    <span class="n">equivalents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">child_equivalents</span><span class="p">,</span>
</span><span data-line="3370">                <span class="p">)</span>
</span><span data-line="3371">                <span class="k">if</span> <span class="n">source_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3372">                    <span class="n">primary_aliasizer</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
</span><span data-line="3373">                        <span class="n">ClauseAdapter</span><span class="p">(</span>
</span><span data-line="3374">                            <span class="n">source_selectable</span><span class="p">,</span>
</span><span data-line="3375">                            <span class="n">exclude_fn</span><span class="o">=</span><span class="n">_remote_col_exclude</span><span class="p">,</span>
</span><span data-line="3376">                            <span class="n">equivalents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_equivalents</span><span class="p">,</span>
</span><span data-line="3377">                        <span class="p">)</span>
</span><span data-line="3378">                    <span class="p">)</span>
</span><span data-line="3379">                <span class="n">secondary_aliasizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="3380">
</span><span data-line="3381">            <span class="n">primaryjoin</span> <span class="o">=</span> <span class="n">primary_aliasizer</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">primaryjoin</span><span class="p">)</span>
</span><span data-line="3382">            <span class="n">target_adapter</span> <span class="o">=</span> <span class="n">secondary_aliasizer</span> <span class="ow">or</span> <span class="n">primary_aliasizer</span>
</span><span data-line="3383">            <span class="n">target_adapter</span><span class="o">.</span><span class="n">exclude_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="3384">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="3385">            <span class="n">target_adapter</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="3386">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="3387">            <span class="n">primaryjoin</span><span class="p">,</span>
</span><span data-line="3388">            <span class="n">secondaryjoin</span><span class="p">,</span>
</span><span data-line="3389">            <span class="n">secondary</span><span class="p">,</span>
</span><span data-line="3390">            <span class="n">target_adapter</span><span class="p">,</span>
</span><span data-line="3391">            <span class="n">dest_selectable</span><span class="p">,</span>
</span><span data-line="3392">        <span class="p">)</span>
</span><span data-line="3393">
</span><span data-line="3394">    <span class="k">def</span><span class="w"> </span><span class="nf">create_lazy_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse_direction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
</span><span data-line="3395">        <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span data-line="3396">        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="3397">        <span class="n">Dict</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="3398">    <span class="p">]:</span>
</span><span data-line="3399">        <span class="n">binds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">BindParameter</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="3400">        <span class="n">equated_columns</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="3401">
</span><span data-line="3402">        <span class="n">has_secondary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="3403">
</span><span data-line="3404">        <span class="k">if</span> <span class="n">has_secondary</span><span class="p">:</span>
</span><span data-line="3405">            <span class="n">lookup</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span data-line="3406">            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
</span><span data-line="3407">                <span class="n">lookup</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</span><span data-line="3408">                <span class="n">equated_columns</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>
</span><span data-line="3409">        <span class="k">elif</span> <span class="ow">not</span> <span class="n">reverse_direction</span><span class="p">:</span>
</span><span data-line="3410">            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
</span><span data-line="3411">                <span class="n">equated_columns</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>
</span><span data-line="3412">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="3413">            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
</span><span data-line="3414">                <span class="n">equated_columns</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
</span><span data-line="3415">
</span><span data-line="3416">        <span class="k">def</span><span class="w"> </span><span class="nf">col_to_bind</span><span class="p">(</span>
</span><span data-line="3417">            <span class="n">element</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="3418">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BindParameter</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="3419">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3420">                <span class="p">(</span><span class="ow">not</span> <span class="n">reverse_direction</span> <span class="ow">and</span> <span class="s2">&quot;local&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">)</span>
</span><span data-line="3421">                <span class="ow">or</span> <span class="n">reverse_direction</span>
</span><span data-line="3422">                <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="3423">                    <span class="p">(</span><span class="n">has_secondary</span> <span class="ow">and</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">lookup</span><span class="p">)</span>
</span><span data-line="3424">                    <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">has_secondary</span> <span class="ow">and</span> <span class="s2">&quot;remote&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">_annotations</span><span class="p">)</span>
</span><span data-line="3425">                <span class="p">)</span>
</span><span data-line="3426">            <span class="p">):</span>
</span><span data-line="3427">                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">binds</span><span class="p">:</span>
</span><span data-line="3428">                    <span class="n">binds</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span>
</span><span data-line="3429">                        <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">element</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="3430">                    <span class="p">)</span>
</span><span data-line="3431">                <span class="k">return</span> <span class="n">binds</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
</span><span data-line="3432">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="3433">
</span><span data-line="3434">        <span class="n">lazywhere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primaryjoin</span>
</span><span data-line="3435">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">reverse_direction</span><span class="p">:</span>
</span><span data-line="3436">            <span class="n">lazywhere</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="3437">                <span class="n">lazywhere</span><span class="p">,</span> <span class="p">{},</span> <span class="n">col_to_bind</span>
</span><span data-line="3438">            <span class="p">)</span>
</span><span data-line="3439">
</span><span data-line="3440">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3441">            <span class="n">secondaryjoin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryjoin</span>
</span><span data-line="3442">            <span class="k">if</span> <span class="n">reverse_direction</span><span class="p">:</span>
</span><span data-line="3443">                <span class="n">secondaryjoin</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span>
</span><span data-line="3444">                    <span class="n">secondaryjoin</span><span class="p">,</span> <span class="p">{},</span> <span class="n">col_to_bind</span>
</span><span data-line="3445">                <span class="p">)</span>
</span><span data-line="3446">            <span class="n">lazywhere</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">lazywhere</span><span class="p">,</span> <span class="n">secondaryjoin</span><span class="p">)</span>
</span><span data-line="3447">
</span><span data-line="3448">        <span class="n">bind_to_col</span> <span class="o">=</span> <span class="p">{</span><span class="n">binds</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">binds</span><span class="p">}</span>
</span><span data-line="3449">
</span><span data-line="3450">        <span class="k">return</span> <span class="n">lazywhere</span><span class="p">,</span> <span class="n">bind_to_col</span><span class="p">,</span> <span class="n">equated_columns</span>
</span><span data-line="3451">
</span><span data-line="3452">
</span><span data-line="3453"><span class="k">class</span><span class="w"> </span><span class="nc">_ColInAnnotations</span><span class="p">:</span>
</span><span data-line="3454"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Serializable object that tests for names in c._annotations.</span>
</span><span data-line="3455">
</span><span data-line="3456"><span class="sd">    TODO: does this need to be serializable anymore?  can we find what the</span>
</span><span data-line="3457"><span class="sd">    use case was for that?</span>
</span><span data-line="3458">
</span><span data-line="3459"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="3460">
</span><span data-line="3461">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,)</span>
</span><span data-line="3462">
</span><span data-line="3463">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="3464">        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</span><span data-line="3465">
</span><span data-line="3466">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">ClauseElement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="3467">        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">_annotations</span><span class="p">))</span>
</span><span data-line="3468">
</span><span data-line="3469">
</span><span data-line="3470"><span class="n">_local_col_exclude</span> <span class="o">=</span> <span class="n">_ColInAnnotations</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;should_not_adapt&quot;</span><span class="p">)</span>
</span><span data-line="3471"><span class="n">_remote_col_exclude</span> <span class="o">=</span> <span class="n">_ColInAnnotations</span><span class="p">(</span><span class="s2">&quot;remote&quot;</span><span class="p">,</span> <span class="s2">&quot;should_not_adapt&quot;</span><span class="p">)</span>
</span><span data-line="3472">
</span><span data-line="3473">
</span><span data-line="3474"><span class="k">class</span><span class="w"> </span><span class="nc">Relationship</span><span class="p">(</span>
</span><span data-line="3475">    <span class="n">RelationshipProperty</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="3476">    <span class="n">_DeclarativeMapped</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="3477"><span class="p">):</span>
</span><span data-line="3478"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Describes an object property that holds a single item or list</span>
</span><span data-line="3479"><span class="sd">    of items that correspond to a related database table.</span>
</span><span data-line="3480">
</span><span data-line="3481"><span class="sd">    Public constructor is the :func:`_orm.relationship` function.</span>
</span><span data-line="3482">
</span><span data-line="3483"><span class="sd">    .. seealso::</span>
</span><span data-line="3484">
</span><span data-line="3485"><span class="sd">        :ref:`relationship_config_toplevel`</span>
</span><span data-line="3486">
</span><span data-line="3487"><span class="sd">    .. versionchanged:: 2.0 Added :class:`_orm.Relationship` as a Declarative</span>
</span><span data-line="3488"><span class="sd">       compatible subclass for :class:`_orm.RelationshipProperty`.</span>
</span><span data-line="3489">
</span><span data-line="3490"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="3491">
</span><span data-line="3492">    <span class="n">inherit_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="3493"><span class="w">    </span><span class="sd">&quot;&quot;&quot;:meta private:&quot;&quot;&quot;</span>
</span><span data-line="3494">
</span><span data-line="3495">
</span><span data-line="3496"><span class="k">class</span><span class="w"> </span><span class="nc">_RelationshipDeclared</span><span class="p">(</span>  <span class="c1"># type: ignore[misc]</span>
</span><span data-line="3497">    <span class="n">Relationship</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="3498">    <span class="n">WriteOnlyMapped</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>  <span class="c1"># not compatible with Mapped[_T]</span>
</span><span data-line="3499">    <span class="n">DynamicMapped</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>  <span class="c1"># not compatible with Mapped[_T]</span>
</span><span data-line="3500"><span class="p">):</span>
</span><span data-line="3501"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Relationship subclass used implicitly for declarative mapping.&quot;&quot;&quot;</span>
</span><span data-line="3502">
</span><span data-line="3503">    <span class="n">inherit_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="3504"><span class="w">    </span><span class="sd">&quot;&quot;&quot;:meta private:&quot;&quot;&quot;</span>
</span><span data-line="3505">
</span><span data-line="3506">    <span class="nd">@classmethod</span>
</span><span data-line="3507">    <span class="k">def</span><span class="w"> </span><span class="nf">_mapper_property_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="3508">        <span class="k">return</span> <span class="s2">&quot;Relationship&quot;</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Jacob Coffee</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/JacobCoffee/litestar-pydotorg" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=30646c52"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../_static/shibuya.js?v=c1cf1a6b"></script></body>
</html>